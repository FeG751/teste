<!DOCTYPE html>
<html lang="pt-BR">
<head>    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
    <title>7Chat - Versão Final Otimizada (Atualizado)</title>
    
    <!-- PWA Meta Tags -->    <meta name="theme-color" content="#1f2937"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Um aplicativo de chat em tempo real.">    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=7C">
    <!-- O manifest.json é gerado e injetado via script no final do body -->    <!-- Favicon inline para evitar erro 404 -->
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3e%3ctext y='24' font-size='24' fill='%234f46e5'%3e7%3c/text%3e%3c/svg%3e" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" />
    
    <!-- Tailwind CSS via CDN - Nota: Para produção, recomenda-se usar PostCSS ou Tailwind CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin': 'spin 1s linear infinite',
                        'ping': 'ping 1s cubic-bezier(0, 0, 0.2, 1) infinite',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --real-vh: 1vh;
        }        html, body {
            height: 100vh; /* Fallback */
            height: calc(var(--real-vh, 1vh) * 100);
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
        }
        .messages-container {
            background-image: url('https://i.imgur.com/kI46opI.png');
            background-size: cover;
            background-position: center;
        }
        #sidebar, #login-screen {
             background-image: url('https://i.imgur.com/KAWlxJS.png');
             background-size: cover;
             background-position: center;
        }        .header-blur, .form-blur {
            /* Backdrop blur mantido mas permitindo sobrescrita */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .modal, .notification { animation: fadeIn .3s ease-out; }
        .modal-content { animation: slideUp .3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typing-bounce 1.2s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) { animation-delay: -1.0s; }
        .typing-indicator span:nth-child(3) { animation-delay: -0.8s; }
        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }        /* Badge genérico - removido estilo específico para permitir customização */
        
        /* Estilos modernos forçados */
        .group:hover .group-hover\:scale-105 {
            transform: scale(1.05) !important;
        }
        
        .group:hover .group-hover\:text-blue-400 {
            color: #60a5fa !important;
        }
        
        .group:hover .group-hover\:text-emerald-400 {
            color: #34d399 !important;
        }
        
        .group:hover .group-hover\:text-purple-400 {
            color: #c084fc !important;
        }
        
        .group:hover .group-hover\:text-indigo-400 {
            color: #818cf8 !important;
        }
        
        .group:hover .group-hover\:text-red-400 {
            color: #f87171 !important;
        }
        
        .group:hover .group-hover\:text-green-400 {
            color: #4ade80 !important;
        }
        
        .transition-all {
            transition: all 0.3s ease !important;
        }
        
        .hover\:scale-110:hover {
            transform: scale(1.1) !important;
        }
        
        .hover\:scale-105:hover {
            transform: scale(1.05) !important;
        }
          .backdrop-blur-xl {
            backdrop-filter: blur(24px) !important;
            -webkit-backdrop-filter: blur(24px) !important;
        }
        
        /* Estilos para mensagens */
        .message-item {
            margin-bottom: 0.75rem;
        }
        
        .message-item:last-child {
            margin-bottom: 0;
        }
        
        /* Quebra de linha para mensagens longas */
        .break-words {
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Animação suave para troca de ícones */
        #dynamic-action-btn svg {
            transition: opacity 0.2s ease-in-out;
        }
        .seen-icon {
            width: 18px;
            height: 18px;
            margin-left: 6px;
            align-self: flex-end;
            margin-bottom: 2px;
        }
        audio::-webkit-media-controls-panel {
            background-color: #4b5563;
        }        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display,        audio::-webkit/media-controls-timeline,
        audio::-webkit-media-controls-volume-slider {
            filter: invert(1) grayscale(1) brightness(1.5);
        }

        /* Correções para PWA e teclado virtual */
        html, body {
            height: 100vh;
            height: calc(var(--real-vh, 1vh) * 100);
            overflow: auto; /* Mudança: permite scroll quando necessário */
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
        }

        /* Específico para PWA instalada */
        @media all and (display-mode: standalone) {
            html, body {
                overflow: auto !important;
                height: 100vh;
                height: calc(var(--real-vh, 1vh) * 100);
            }
            
            #login-screen {
                overflow-y: auto !important;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Ajustes para quando teclado virtual aparece */
        .keyboard-open {
            overflow-y: auto !important;
        }

        .keyboard-open #login-screen {
            height: auto !important;
            min-height: 100vh;
            overflow-y: auto !important;
            padding-bottom: 50px;
        }

        /* Melhor responsividade para inputs em foco */
        .input-focused {
            position: relative;
            z-index: 1000;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        /* Ajustes específicos para iOS */
        @supports (-webkit-touch-callout: none) {
            .keyboard-open {
                position: fixed;
                width: 100%;
                height: 100%;
                overflow-y: scroll;
            }
        }

        /* Container de login mais flexível */
        #login-screen .w-full.max-w-sm {
            margin: 20px auto;
            position: relative;
        }        /* Melhor viewport para dispositivos pequenos */
        @media (max-height: 600px) {
            #login-screen {
                padding: 10px;
                align-items: flex-start;
                padding-top: 20px;
            }
            
            #login-screen .w-full.max-w-sm {
                margin: 10px auto;
            }
        }

        /* Classe específica para PWA */
        .pwa-mode {
            -webkit-overflow-scrolling: touch;
        }

        .pwa-mode #login-screen {
            height: auto;
            min-height: 100vh;
            overflow-y: auto;
        }

        /* Melhor suporte para diferentes dispositivos */
        @media screen and (max-device-width: 480px) {
            .keyboard-open #login-screen {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                overflow-y: scroll;
                -webkit-overflow-scrolling: touch;
            }
        }

        /* Correção específica para formulário de login */
        #login-form {
            position: relative;
            z-index: 10;
        }

        #login-form input {
            position: relative;
            z-index: 11;
        }
    </style><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-black text-gray-200 overflow-hidden">

    <!-- Menu de Navegação Inferior -->
    <div class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 shadow-lg z-50">
        <div class="flex justify-around text-gray-400">
            <!-- Botão Amigos -->
            <a href="#" id="nav-friends" class="flex flex-col items-center justify-center p-3 text-center w-full hover:text-white transition-colors duration-300">
                <i class="fas fa-user-friends text-xl"></i>
                <span class="text-xs font-medium">Amigos</span>
            </a>
            <!-- Botão Salas (ativo por padrão) -->
            <a href="#" id="nav-rooms" class="flex flex-col items-center justify-center p-3 text-center w-full text-indigo-400 border-t-2 border-indigo-500 hover:text-white transition-colors duration-300">
                <i class="fas fa-comments text-xl"></i>
                <span class="text-xs font-medium">Salas</span>
            </a>
            <!-- Botão Configurar -->
            <a href="#" id="nav-settings" class="flex flex-col items-center justify-center p-3 text-center w-full hover:text-white transition-colors duration-300">
                <i class="fas fa-cog text-xl"></i>
                <span class="text-xs font-medium">Configurar</span>
            </a>
        </div>
    </div>

    <!-- ELEMENTOS GLOBAIS -->
    <input type="file" id="image-uploader" class="hidden" accept="image/*" />
    <input type="file" id="media-uploader" class="hidden" accept="image/*,video/*" />
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
    </div>
    <div id="notification-toast" class="hidden fixed bottom-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-xl z-[101]"></div>
    
    <!-- Menu de Contexto Customizado para Salas -->
    <div id="room-context-menu" class="hidden absolute bg-gray-800 rounded-md shadow-lg py-1 z-50 border border-gray-700">
        <a href="#" id="context-pin" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"></a>
        <a href="#" id="context-archive" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"></a>
        <a href="#" id="context-clear-chat" class="hidden px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Limpar Conversa</a>
        <a href="#" id="context-delete" class="block px-4 py-2 text-sm text-red-500 hover:bg-red-900/50"></a>
    </div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="hidden items-center justify-center h-full p-4 flex-col">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div id="invite-welcome-card" class="hidden w-full max-w-sm p-8 bg-gray-800/80 backdrop-blur-lg rounded-xl shadow-lg space-y-4 mb-4 text-center z-10 border border-gray-700">
            <h3 class="text-xl font-bold text-white">Você foi convidado!</h3>
            <p class="text-gray-400">Para entrar na sala, entre como convidado ou faça login na sua conta.</p>            <button id="enter-as-guest-btn" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-all duration-300">
                Entrar como Convidado
            </button>
        </div>
        <div class="w-full max-w-sm p-8 bg-gray-800/80 backdrop-blur-lg rounded-xl shadow-lg space-y-6 z-10 border border-gray-700">
            <h2 id="login-title" class="text-3xl font-extrabold text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-400">7Chat</h2>            <form id="login-form" class="space-y-4">
                <input id="email-input" type="email" required placeholder="E-mail" autocomplete="email" class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400 transition-all duration-300">
                <input id="password-input" type="password" required placeholder="Senha" autocomplete="current-password" class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400 transition-all duration-300">
                <button type="submit" class="w-full flex items-center justify-center py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-lg shadow-md hover:from-blue-600 hover:to-indigo-700 transition-all duration-300">Login</button>
            </form>
            <div class="text-center">
                <span class="text-sm text-gray-500">ou</span>
                <button id="main-guest-login-btn" class="mt-2 text-blue-400 hover:text-blue-300 font-semibold">Entrar como convidado</button>
            </div>
        </div>
    </div>    <!-- CONTAINER PRINCIPAL DO APP -->
    <div id="app-container" class="hidden h-full w-full relative overflow-hidden flex">
        <!-- SIDEBAR -->
        <div id="sidebar" class="w-80 flex-shrink-0 bg-gray-900 border-r border-gray-700 flex flex-col">
            <!-- Header da Sidebar -->
            <div id="sidebar-header" class="flex items-center justify-between p-4 border-b border-gray-700 bg-gray-800">
                <div class="flex items-center space-x-3">
                    <img id="my-profile-pic" class="w-10 h-10 rounded-full cursor-pointer" src="" alt="Perfil">
                    <div>
                        <h2 id="sidebar-username" class="font-semibold text-white text-sm"></h2>
                        <span id="sidebar-status" class="text-xs text-green-400">Online</span>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="user-settings-btn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button id="create-room-btn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
            
            <!-- Busca de Conversas -->
            <div class="p-4 border-b border-gray-700">
                <div class="relative">
                    <input type="text" id="conversation-search-input" placeholder="Buscar conversas..." class="w-full bg-gray-800 border border-gray-600 rounded-lg py-2 px-4 pl-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
            </div>
            
            <!-- Lista de Conversas -->
            <div id="room-list-container" class="flex-1 overflow-y-auto">
                <!-- Lista será preenchida pelo JavaScript -->
            </div>
            
            <!-- Footer com pedidos de amizade -->
            <div class="p-4 border-t border-gray-700">
                <button id="friend-requests-btn" class="w-full flex items-center justify-between p-3 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-user-plus text-blue-400"></i>
                        <span class="text-white">Pedidos de Amizade</span>
                    </div>
                    <span id="friend-requests-badge" class="hidden bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </button>
            </div>
        </div>
        
        <!-- PAINEL DE CHAT -->
        <div id="chat-panel" class="flex-1 flex flex-col">
            <!-- Área de boas-vindas quando nenhum chat está selecionado -->
            <div id="welcome-panel" class="flex-1 flex items-center justify-center text-center p-8">
                <div class="max-w-md">
                    <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full mx-auto mb-6 flex items-center justify-center">
                        <i class="fas fa-comments text-2xl text-white"></i>
                    </div>
                    <h2 class="text-2xl font-bold text-white mb-4">Bem-vindo ao 7Chat!</h2>
                    <p class="text-gray-400 mb-6">Selecione uma conversa para começar a trocar mensagens ou crie uma nova sala.</p>
                    <button class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-colors" onclick="document.getElementById('create-room-modal').classList.remove('hidden')">
                        Criar Nova Sala
                    </button>
                </div>
            </div>
            
            <!-- Área do chat ativo (inicialmente oculta) -->
            <div id="active-chat" class="hidden flex-1 flex flex-col">
                <!-- Header do chat -->
                <div id="chat-header" class="flex items-center justify-between p-4 border-b border-gray-700 bg-gray-800">
                    <div class="flex items-center space-x-3">
                        <img id="chat-user-pic" class="w-10 h-10 rounded-full" src="" alt="Usuário">
                        <div>
                            <h3 id="chat-title" class="font-semibold text-white"></h3>
                            <span id="chat-status" class="text-xs text-gray-400"></span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button id="chat-settings-btn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Mensagens -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-4 space-y-4 messages-container">
                    <!-- Mensagens serão inseridas aqui -->
                </div>
                
                <!-- Indicador de "digitando" -->
                <div id="typing-indicator" class="hidden px-4 py-2">
                    <div class="flex items-center space-x-2 text-gray-400 text-sm">
                        <div class="typing-indicator">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span id="typing-text">Alguém está digitando...</span>
                    </div>
                </div>
                
                <!-- Área de entrada de mensagem -->
                <div id="message-input-area" class="p-4 border-t border-gray-700 bg-gray-800">
                    <div class="flex items-end space-x-3">
                        <div class="flex space-x-2">
                            <button id="attach-btn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button id="voice-btn" class="p-2 text-gray-400 hover:text-white hover:bg-gray-700 rounded-lg transition-colors">
                                <i class="fas fa-microphone"></i>
                            </button>
                        </div>
                        <div class="flex-1 relative">
                            <textarea id="message-input" placeholder="Digite sua mensagem..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 text-white resize-none focus:outline-none focus:ring-2 focus:ring-blue-500" rows="1" maxlength="1000"></textarea>
                        </div>
                        <button id="send-btn" class="p-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Nova Tela de Amigos (inicialmente oculta) -->
    <div id="friends-screen" class="hidden h-full w-full flex flex-col bg-gray-900 text-white pb-20">
        <!-- Cabeçalho com Título, Busca e Botão de Editar -->
        <div class="bg-gray-800 shadow-md p-4 space-y-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">Amigos</h1>
                <div>
                    <!-- Botões que alternam de acordo com o modo de edição -->
                    <button id="edit-friends-btn" class="text-blue-400 hover:text-blue-300 font-semibold">Editar</button>
                    <button id="done-editing-btn" class="hidden text-blue-400 hover:text-blue-300 font-semibold">Concluir</button>
                </div>
            </div>
            <!-- Barra de Busca -->
            <div class="relative">
                <input type="text" id="friend-search-input" placeholder="Buscar amigo pelo nome exato..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-4 pl-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                    <i class="fas fa-search"></i>
                </div>
            </div>
        </div>

        <!-- Container da Lista de Amigos -->
        <div id="friends-list-container" class="flex-1 p-4 space-y-3 overflow-y-auto">
            <!-- A lista de amigos será gerada pelo JavaScript aqui -->
        </div>

        <!-- Barra de Ações de Exclusão (inicialmente oculta) -->
        <div id="delete-actions-bar" class="hidden p-4 bg-gray-800 border-t border-gray-700">
            <button id="delete-selected-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 disabled:bg-red-800 disabled:cursor-not-allowed" disabled>
                Excluir Selecionados
            </button>
        </div>
    </div>
    
    <div id="guest-container" class="hidden h-full w-full relative overflow-hidden"></div>

    <!-- MODAIS -->
    <div id="image-viewer-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[50] p-4">
        <div class="modal-content bg-transparent rounded-lg w-full max-w-2xl text-center relative">
            <div class="w-full h-auto max-h-[85vh] overflow-hidden rounded-lg mx-auto">
                 <img id="image-viewer-pic" class="w-full h-full object-contain">
            </div>
            <div id="image-viewer-actions" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-4"></div>
            <button id="close-image-viewer-btn" class="absolute top-2 right-2 m-2 text-white/80 hover:text-white text-4xl font-light">&times;</button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div class="modal-content bg-gray-800 text-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center space-y-4 border border-gray-700">
            <h3 id="custom-confirm-title" class="text-xl font-bold"></h3>
            <p id="custom-confirm-message" class="text-gray-400"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-confirm-cancel-btn" class="px-6 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Cancelar</button>
                <button id="custom-confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>    <div id="custom-prompt-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm space-y-4 border border-gray-700">
            <h3 id="custom-prompt-title" class="text-xl font-bold text-center text-white"></h3>
            <p id="custom-prompt-message" class="text-gray-400 text-center"></p>
            <input type="text" id="custom-prompt-input" placeholder="Sua resposta aqui..." class="w-full border border-gray-600 rounded-md px-3 py-2 bg-gray-700 text-white" />
            <button id="custom-prompt-ok-btn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirmar</button>
        </div>
    </div>

    <!-- MODAL DE NOTIFICAÇÕES OBRIGATÓRIAS -->
    <div id="mandatory-notifications-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[70] p-4">
        <div class="modal-content bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md space-y-6 border border-gray-700">
            <div class="text-center">
                <div class="mx-auto w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">Notificações Obrigatórias</h3>
                <p class="text-gray-300 text-center leading-relaxed">
                    Para usar o 7Chat, você precisa ativar as notificações. Isso garante que você receba mensagens importantes e tenha a melhor experiência no app.
                </p>
            </div>
            
            <div class="bg-gray-700/50 rounded-lg p-4 space-y-3">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300">Receba mensagens em tempo real</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300">Não perca conversas importantes</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300">Mantenha-se conectado</span>
                </div>
            </div>
            
            <button id="activate-mandatory-notifications-btn" class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <span>Ativar Notificações</span>
            </button>
            
            <p id="mandatory-notifications-status" class="text-xs text-center text-gray-500"></p>
        </div>
    </div>

    <div id="share-link-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Convidar para a Sala</h3><button id="close-share-link-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <p class="text-gray-400">Compartilhe este link para que outros possam entrar:</p>
            <div class="flex items-center space-x-2">
                <input type="text" id="share-link-input" readonly class="w-full border bg-gray-700 border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-300">
                <button id="copy-link-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex-shrink-0">Copiar</button>
            </div>
        </div>
    </div>

    <div id="user-settings-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 text-white rounded-lg shadow-xl p-6 w-full max-w-md space-y-6 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold">Configurações</h3><button id="close-user-settings-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div class="flex flex-col items-center space-y-4">
                <div class="relative group w-24 h-24">
                    <img id="user-settings-pic" class="w-full h-full rounded-full bg-gray-600 object-cover cursor-pointer">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity rounded-full">Trocar</div>
                </div>            <div class="w-full">
                <label for="user-settings-name" class="block text-sm font-medium text-gray-400">Nome de Usuário</label>
                <input type="text" id="user-settings-name" class="mt-1 w-full border border-gray-600 rounded-md px-3 py-2 bg-gray-700" />
            </div>
        </div>
        <div class="pt-4 border-t border-gray-700 space-y-2">
                <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>Sair</span>
                </button>
            </div>
        </div>
    </div>

    <div id="room-settings-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 text-white rounded-lg shadow-xl p-6 w-full max-w-lg space-y-6 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold">Configurações da Sala</h3><button id="close-room-settings-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div class="flex items-center space-x-4">
                <div class="relative group flex-shrink-0 w-16 h-16">
                    <img id="room-settings-pic" class="w-full h-full rounded-full bg-gray-600 object-cover cursor-pointer">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity rounded-full">Trocar</div>
                </div>
                <div class="w-full">
                    <label for="room-settings-name" class="block text-sm font-medium text-gray-400">Nome da Sala</label>
                    <input type="text" id="room-settings-name" class="mt-1 w-full border border-gray-600 rounded-md px-3 py-2 bg-gray-700" />
                </div>
            </div>
            <div class="pt-4 border-t border-gray-700">
                <h4 class="text-lg font-semibold">Membros</h4>
                <div id="room-members-list" class="mt-2 max-h-48 overflow-y-auto space-y-2"></div>
            </div>
            <div id="add-member-section" class="hidden pt-4 border-t border-gray-700">
                 <button id="add-member-btn" class="w-full text-left px-4 py-2 bg-blue-800 text-blue-200 rounded-md hover:bg-blue-700">Adicionar Membro</button>
            </div>
            <div class="pt-4 border-t border-gray-700">
                <button id="clear-chat-btn" class="w-full text-left px-4 py-2 bg-red-900/50 text-red-300 rounded-md hover:bg-red-900/70">Limpar Histórico de Mensagens</button>
            </div>
        </div>
    </div>
    
    <div id="add-member-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Adicionar Amigo ao Grupo</h3><button id="close-add-member-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div id="add-member-list" class="max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <div id="create-room-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm space-y-4 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Criar Nova Sala</h3><button id="close-create-modal-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <form id="create-room-form">
                <div><label for="room-name-input" class="block text-sm font-medium text-gray-400">Nome da Sala</label><input type="text" id="room-name-input" required class="mt-1 w-full border border-gray-600 bg-gray-700 rounded-md px-3 py-2" /></div>
                <div><label for="room-password-input" class="block text-sm font-medium text-gray-400">Senha (Opcional)</label><input type="password" id="room-password-input" placeholder="Deixe em branco para sala pública" class="mt-1 w-full border border-gray-600 bg-gray-700 rounded-md px-3 py-2" /></div>
                <div class="flex justify-end space-x-3 pt-2"><button type="button" id="cancel-create-room-btn" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Criar</button></div>
            </form>
        </div>
    </div>
    
    <div id="user-search-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Encontrar Usuários</h3><button id="close-user-search-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div class="relative">
                <input type="search" id="user-search-input" placeholder="Digite o nome de usuário..." class="w-full border border-gray-600 bg-gray-700 rounded-md px-3 py-2 pl-10 text-white">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <div id="user-search-results" class="max-h-60 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="friend-requests-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Pedidos de Amizade</h3><button id="close-friend-requests-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div id="friend-requests-list" class="max-h-60 overflow-y-auto"></div>
        </div>
    </div>    <!-- Modal de Configurações da Conversa -->
    <div id="conversation-settings-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gradient-to-br from-gray-800 to-gray-900 text-white rounded-2xl shadow-2xl p-0 w-full max-w-md border border-gray-600 overflow-hidden">
            <!-- Header do Modal -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 relative">
                <button id="close-conversation-settings-btn" class="absolute top-4 right-4 text-white/80 hover:text-white text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 transition-all duration-200">&times;</button>
                <h3 class="text-2xl font-bold text-white">Configurações</h3>
                <p class="text-blue-100 text-sm mt-1">Personalize sua conversa</p>
            </div>
            
            <!-- Informações do Chat -->
            <div class="p-6 bg-gray-800/50 border-b border-gray-700">
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 p-0.5">
                            <div class="w-full h-full rounded-full overflow-hidden bg-gray-800">
                                <img id="conversation-settings-pic" class="w-full h-full object-cover">
                            </div>
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-gray-800"></div>
                    </div>                    <div class="flex-1 min-w-0">
                        <h4 id="conversation-settings-name" class="text-lg font-semibold text-white truncate"></h4>
                        <p id="conversation-settings-type" class="text-sm text-gray-400"></p>
                        <div id="user-status-indicator" class="flex items-center space-x-2 mt-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-xs text-green-400">Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Opções da Conversa -->
            <div class="p-6 space-y-4">
                <!-- Notificações -->
                <div class="flex items-center justify-between p-4 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700/70 transition-all duration-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                        </div>
                        <div>
                            <span class="font-medium text-white">Notificações</span>
                            <p class="text-xs text-gray-400">Receber alertas desta conversa</p>
                        </div>
                    </div>                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="conversation-notifications-toggle" class="sr-only peer">
                        <div class="w-12 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-1/2 after:left-1.5 after:-translate-y-1/2 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <!-- Sons -->
                <div class="flex items-center justify-between p-4 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700/70 transition-all duration-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.464 8.464a5 5 0 000 7.072"></path>
                            </svg>
                        </div>
                        <div>
                            <span class="font-medium text-white">Sons</span>
                            <p class="text-xs text-gray-400">Tocar sons de notificação</p>
                        </div>
                    </div>                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="conversation-sounds-toggle" class="sr-only peer" checked>
                        <div class="w-12 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-1/2 after:left-1.5 after:-translate-y-1/2 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                </div>

                <!-- Arquivos de Mídia -->
                <button class="w-full flex items-center justify-between p-4 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700/70 hover:border-blue-500/50 transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="text-left">
                            <span class="font-medium text-white">Arquivos de Mídia</span>
                            <p class="text-xs text-gray-400">Fotos, vídeos e documentos</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>

                <!-- Buscar Mensagens -->
                <button class="w-full flex items-center justify-between p-4 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700/70 hover:border-blue-500/50 transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <div class="text-left">
                            <span class="font-medium text-white">Buscar Mensagens</span>
                            <p class="text-xs text-gray-400">Encontrar mensagens específicas</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>            <!-- Ações da Conversa -->
            <div class="p-6 pt-0 space-y-3 border-t border-gray-700/50">
                <button id="clear-chat-btn" class="w-full flex items-center justify-center space-x-3 py-3 px-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-xl font-medium hover:from-yellow-600 hover:to-orange-600 transition-all duration-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1H7a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>Limpar Conversa</span>
                </button>
                
                <button id="block-user-btn" class="w-full flex items-center justify-center space-x-3 py-3 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-medium hover:from-red-600 hover:to-red-700 transition-all duration-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364L18.364 5.636"></path>
                    </svg>
                    <span>Bloquear Usuário</span>
                </button>
            </div>
        </div>
    </div>

<script type="module">
    // --- IMPORTAÇÕES ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, orderBy, addDoc, serverTimestamp, where, updateDoc, arrayUnion, writeBatch, getDocs, arrayRemove, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    import { getDatabase, ref as rtdbRef, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

    // --- CONFIGURAÇÃO DO FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCyidXzqqe-rrcF0QrBQ2iSIR_mf0tpMd0",
      authDomain: "seu-projeto-chat.firebaseapp.com",
      databaseURL: "https://seu-projeto-chat-default-rtdb.firebaseio.com",
      projectId: "seu-projeto-chat",
      storageBucket: "seu-projeto-chat.firebasestorage.app",
      messagingSenderId: "259194791953",
      appId: "1:259194791953:web:587ea979f1f26aff2629b0"
    };

    // --- VARIÁVEIS GLOBAIS ---
    let app, auth, db, rtdb, storage, messaging;
    const ui = {};    const state = { 
        currentUserId: null, 
        currentUserData: null, 
        currentRoomData: null,
        roomsData: [],
        friendsData: new Map(),
        usersStatus: {}, 
        readReceiptObserver: null,
        imageUploadContext: null,
        unsubscribeRoom: null, 
        unsubscribeMessages: null, 
        unsubscribeUserRooms: null,
        unsubscribeUserData: null,
        unsubscribePresence: null,
        unsubscribeSearchListener: null,
        typingTimeout: null,
        isRecording: false,
        mediaRecorder: null,
        audioChunks: [],        recordingStartTime: 0,
        recordingTimerInterval: null,
        notificationCheckInterval: null,        isEditingFriends: false, // <-- ADICIONE ESTA LINHA
        selectedFriendsForDeletion: [], // <-- E ESTA LINHA
        userSearchResults: [] // <-- ADICIONE ESTA LINHA
    };// --- LÓGICA DE INICIALIZAÇÃO ---

    // Função para verificar se elementos essenciais existem
    function checkRequiredElements() {
        const requiredElements = [
            'login-screen',
            'app-container', 
            'guest-container',
            'friends-screen'
        ];
        
        const missing = requiredElements.filter(id => !document.getElementById(id));
        
        if (missing.length > 0) {
            console.error('❌ Elementos HTML obrigatórios não encontrados:', missing);
            return false;
        }
        
        console.log('✅ Todos os elementos HTML necessários encontrados');
        return true;
    }    function main() {
        console.log('🚀 Inicializando aplicação...');
        
        if (!checkRequiredElements()) {
            console.error('❌ Aplicação não pode inicializar - elementos HTML faltando');
            return;
        }
        
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);

            try {
                messaging = getMessaging(app);
                console.log('✅ Firebase Messaging inicializado');
            } catch (err) {
                console.warn("⚠️ Firebase Messaging não é suportado neste ambiente.", err.message);
                messaging = null;
            }

            try {
                rtdb = getDatabase(app);
                console.log('✅ Firebase Realtime Database inicializado');
            } catch (err) {
                console.warn("⚠️ Firebase Realtime Database erro:", err.message);
                rtdb = null;
            }

            console.log('✅ Firebase inicializado com sucesso');
            
            bindGlobalUI();
            onAuthStateChanged(auth, handleAuthChange);
            
            console.log('✅ Event listeners configurados');
            
        } catch (error) {
            console.error('❌ Erro ao inicializar Firebase:', error);
            
            // Forçar mostrar tela de login mesmo com erro
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('login-screen').classList.add('flex');
            document.getElementById('app-container').classList.add('hidden');
            
            showNotification?.('Erro de conexão. Tente recarregar a página.', 'error');
        }
    }
    
    function getRoomDisplayName(room, currentUserId) {
        if (!room) return 'Carregando...';
        if (room.isDirectMessage) {
            const otherUserId = room.members.find(id => id !== currentUserId);
            return room.memberDetails?.[otherUserId] || 'Conversa Privada';
        }
        return room.name;
    }

    async function handleAuthChange(user) {
        const params = new URLSearchParams(window.location.search);
        const roomIdFromUrl = params.get('room');        const cleanupListeners = () => {
            if (state.unsubscribeUserRooms) state.unsubscribeUserRooms();
            if (state.unsubscribeUserData) state.unsubscribeUserData();
            if (state.unsubscribeRoom) state.unsubscribeRoom();
            if (state.unsubscribeMessages) state.unsubscribeMessages();
            if (state.unsubscribeSearchListener) state.unsubscribeSearchListener();
            if (state.unsubscribePresence) state.unsubscribePresence();
            if (state.readReceiptObserver) state.readReceiptObserver.disconnect();
            if (state.notificationCheckInterval) clearInterval(state.notificationCheckInterval);
        };if (user) {
            state.currentUserId = user.uid;
            
            let userSnap = await getDoc(doc(db, 'users', user.uid));
            if (!userSnap.exists()) {
                try {
                    await createUserProfile(user);
                } catch (e) { 
                    console.error("Failed to create user profile:", e);
                    await signOut(auth);
                    return;
                } 
            }
            
            if (roomIdFromUrl && user.isAnonymous) {
                const roomSnap = await getDoc(doc(db, 'rooms', roomIdFromUrl));
                if (!roomSnap.exists()) {
                    showNotification("A sala para a qual você foi convidado não existe mais.", "error");
                    await signOut(auth); return;
                }
                await setupGuestUI(roomIdFromUrl);
            } else {
                // Para usuários não convidados, verificar notificações obrigatórias
                if (!user.isAnonymous) {
                    const notificationsAllowed = enforceNotifications();
                    if (!notificationsAllowed) {
                        return; // Interrompe o setup até que as notificações sejam ativadas
                    }
                }
                
                await setupMainUI(roomIdFromUrl);
            }

            if(!user.isAnonymous) {
                setupPresenceSystem(); 
                // Só chamar setupPushNotifications se as notificações já estiverem permitidas
                if (checkNotificationPermission() === 'granted') {
                    setupPushNotifications();
                }
                // Monitorar mudanças no status das notificações
                monitorNotificationStatus();
            }

        } else {
            cleanupListeners();
            Object.assign(state, { currentUserData: null, currentUserId: null, roomsData: [], usersStatus: {}, friendsData: new Map() });
            
            ['guest-container', 'app-container'].forEach(id => document.getElementById(id).classList.add('hidden'));
            const loginScreen = document.getElementById('login-screen');
            const inviteCard = document.getElementById('invite-welcome-card');
            
            if (roomIdFromUrl) {
                inviteCard.classList.remove('hidden');
                document.getElementById('enter-as-guest-btn').onclick = () => signInAnonymously(auth);
            } else {
                inviteCard.classList.add('hidden');
            }
            document.getElementById('main-guest-login-btn').onclick = () => signInAnonymously(auth);
            loginScreen.classList.remove('hidden');
            loginScreen.classList.add('flex');
            document.getElementById('login-form').onsubmit = handleLogin;
        }
    }

    async function setupMainUI(roomIdFromUrl) {
        try {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('guest-container').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Configurar listeners de dados
            setupDataListeners();
            
            // Configurar UI principal
            bindMainUI();
            
            // Configurar configurações de conversa
            setupConversationSettings();
            
            // Configurar eventos dos modais
            setupModalEvents();
            
            // Se há room ID da URL, abrir essa sala
            if (roomIdFromUrl) {
                setTimeout(() => {
                    openRoom(roomIdFromUrl, true);
                }, 1000);
            }
            
        } catch (error) {
            console.error('Erro ao configurar UI principal:', error);
            showNotification('Erro ao carregar aplicação.', 'error');
        }
    }
    
    async function createUserProfile(user) {
        const baseProfile = { uid: user.uid, friends: [], friendRequests: [], fcmTokens: [] };

        if (user.isAnonymous) {
            const guestName = await showCustomPrompt("Bem-vindo(a)!", "Para entrar, por favor, digite seu nome de convidado.");
            if (!guestName) { await signOut(auth); throw new Error("Guest name not provided."); }
            Object.assign(baseProfile, {
                username: `Convidado: ${guestName.trim()}`,
                guest_name_lowercase: guestName.trim().toLowerCase(),
                isGuest: true,
                photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(guestName.trim()[0])}&background=random&color=fff`
            });
        } else {
            const username = user.email.split('@')[0];
            Object.assign(baseProfile, {
                username, username_lowercase: username.toLowerCase(), email: user.email, isGuest: false,
                photoURL: `https://i.pravatar.cc/150?u=${user.uid}`
            });
        }
        await setDoc(doc(db, 'users', user.uid), baseProfile);
    }
    
    async function setupGuestUI(roomId) {
        try {
            await updateDoc(doc(db, 'rooms', roomId), { members: arrayUnion(state.currentUserId) });
        } catch(e) { console.warn("Could not add guest to room members, maybe already there.", e); }
        document.getElementById('guest-container').classList.remove('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.add('hidden');
        await openRoom(roomId, true);
        history.replaceState(null, '', window.location.pathname);
    }

    async function setupMainUI(roomIdFromUrl) {
        document.getElementById('guest-container').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        initMainLayout();
        bindMainUI();
        setupDataListeners(); 
        if (roomIdFromUrl) {
            await openRoom(roomIdFromUrl);
            history.replaceState(null, '', window.location.pathname);
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value);
        } catch (err) { showNotification("Falha no login: " + err.message, "error"); }
    }    function initMainLayout() {
        document.getElementById('app-container').innerHTML = `
        <div id="sidebar" class="w-full md:w-1/3 h-full transition-transform duration-300 ease-in-out transform md:translate-x-0 relative flex flex-col bg-gray-900">
            <!-- CABEÇALHO REDESENHADO -->
            <header class="relative p-4 flex justify-between items-center border-b border-gray-800">
                <!-- Botão de Sino (Pedidos de Amizade) -->
                <button id="friend-requests-btn" title="Pedidos de Amizade" class="group relative p-3 rounded-xl hover:bg-gray-800 transition-all duration-300">
                     <svg class="w-6 h-6 text-gray-400 group-hover:text-blue-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                     </svg>
                     <span id="friend-requests-badge" class="hidden absolute -top-1 -right-1 w-5 h-5 bg-blue-600 text-white text-xs rounded-full flex items-center justify-center border-2 border-gray-900"></span>
                </button>
                
                <!-- Foto do Perfil (agora leva para as Configurações) -->
                <div id="user-settings-btn" title="Configurações" class="relative z-10 cursor-pointer">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 p-0.5 hover:scale-105 transition-transform duration-300">
                        <div class="w-full h-full rounded-full overflow-hidden bg-gray-600">
                            <img id="my-profile-pic" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
            </header>

            <!-- TÍTULO E NOVA BARRA DE BUSCA -->
            <div class="p-4 space-y-4">
                <h1 class="text-3xl font-bold text-white">Conversas</h1>
                <div class="relative">
                    <input type="search" id="conversation-search-input" placeholder="Pesquisar conversas..." class="w-full bg-gray-800 border border-gray-700 rounded-lg py-2 px-4 pl-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
            </div>

            <!-- Lista de Salas/Conversas -->
            <div id="room-list-container" class="overflow-y-auto flex-1 pb-24"></div>

            <!-- BOTÃO DE CRIAR SALA REPOSICIONADO -->
            <button id="create-room-btn" class="group absolute bottom-24 right-6 w-16 h-16 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-full flex items-center justify-center shadow-lg hover:scale-110 transition-transform duration-300 z-20">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
            </button>
        </div>

        <div id="chat-panel" class="w-full md:flex-grow absolute md:static inset-0 flex flex-col bg-black transition-transform duration-300 ease-in-out transform translate-x-full md:translate-x-0 pb-16">
            <div class="h-full flex items-center justify-center text-center p-4"><p class="text-gray-500">Selecione uma sala ou inicie uma nova conversa.</p></div>
        </div>`;
    }function bindGlobalUI() {
        document.getElementById('close-user-settings-btn').onclick = () => document.getElementById('user-settings-modal').classList.add('hidden');
        document.getElementById('close-room-settings-btn').onclick = () => document.getElementById('room-settings-modal').classList.add('hidden');
        document.getElementById('close-add-member-btn').onclick = () => document.getElementById('add-member-modal').classList.add('hidden');
        document.getElementById('close-create-modal-btn').onclick = () => document.getElementById('create-room-modal').classList.add('hidden');
        document.getElementById('close-image-viewer-btn').onclick = () => document.getElementById('image-viewer-modal').classList.add('hidden');
        document.getElementById('close-share-link-btn').onclick = () => document.getElementById('share-link-modal').classList.add('hidden');
        document.getElementById('close-friend-requests-btn').onclick = () => document.getElementById('friend-requests-modal').classList.add('hidden');
        document.getElementById('close-user-search-btn').onclick = () => {
             if (state.unsubscribeSearchListener) state.unsubscribeSearchListener();
             document.getElementById('user-search-modal').classList.add('hidden');
        };
        document.getElementById('close-conversation-settings-btn').onclick = () => document.getElementById('conversation-settings-modal').classList.add('hidden');
        document.getElementById('create-room-form').onsubmit = handleCreateRoomSubmit;
        document.getElementById('image-uploader').onchange = handleMediaUpload;
        document.getElementById('media-uploader').onchange = handleMediaUpload;
        window.addEventListener('click', () => document.getElementById('room-context-menu').classList.add('hidden'));
        
        // Event listeners para o chat
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        
        if (messageInput) {
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Auto-resize textarea
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 100) + 'px';
                
                // Typing indicator (optional - would need real-time implementation)
                if (state.currentRoomData && !state.typingTimeout) {
                    // Send typing indicator
                    state.typingTimeout = setTimeout(() => {
                        state.typingTimeout = null;
                    }, 3000);
                }
            });
        }
        
        if (sendBtn) {
            sendBtn.onclick = sendMessage;
        }
        
        // Event listeners para botões de mídia
        const attachBtn = document.getElementById('attach-btn');
        const voiceBtn = document.getElementById('voice-btn');
        
        if (attachBtn) {
            attachBtn.onclick = () => {
                document.getElementById('media-uploader').click();
            };
        }
        
        if (voiceBtn) {
            voiceBtn.onclick = toggleAudioRecording;
        }
        
        // Event listeners para amigos
        const friendSearchInput = document.getElementById('friend-search-input');
        const editFriendsBtn = document.getElementById('edit-friends-btn');
        const doneEditingBtn = document.getElementById('done-editing-btn');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');
        
        if (friendSearchInput) {
            friendSearchInput.oninput = handleFriendSearch;
        }
        
        if (editFriendsBtn) {
            editFriendsBtn.onclick = () => {
                state.isEditingFriends = true;
                renderFriendsScreen();
            };
        }
        
        if (doneEditingBtn) {
            doneEditingBtn.onclick = () => {
                state.isEditingFriends = false;
                state.selectedFriendsForDeletion = [];
                renderFriendsScreen();
            };
        }
        
        if (deleteSelectedBtn) {
            deleteSelectedBtn.onclick = deleteSelectedFriends;
        }
        
        // Event listeners para o modal de configurações da conversa
        const conversationModal = document.getElementById('conversation-settings-modal');
        conversationModal.onclick = (e) => {
            if (e.target === conversationModal) {
                conversationModal.classList.add('hidden');
            }
        };
    }    function bindMainUI() {
        Object.assign(ui, {
            myProfilePic: document.getElementById('my-profile-pic'),
            userSettingsBtn: document.getElementById('user-settings-btn'),
            createRoomBtn: document.getElementById('create-room-btn'),
            roomListContainer: document.getElementById('room-list-container'),
            friendRequestsBtn: document.getElementById('friend-requests-btn'),
            friendRequestsBadge: document.getElementById('friend-requests-badge'),
            conversationSearchInput: document.getElementById('conversation-search-input')
        });

        // O clique na foto do perfil agora abre as configurações
        if (ui.userSettingsBtn) ui.userSettingsBtn.onclick = openUserSettings;
        if (ui.createRoomBtn) ui.createRoomBtn.onclick = () => document.getElementById('create-room-modal').classList.remove('hidden');
        if (ui.friendRequestsBtn) ui.friendRequestsBtn.onclick = openFriendRequestsModal;        // A nova busca de conversas irá filtrar a lista
        if (ui.conversationSearchInput) {
            ui.conversationSearchInput.oninput = () => renderSidebarLists();
        }

        // --- Lógica de Navegação Principal ---
        const navFriends = document.getElementById('nav-friends');
        const navRooms = document.getElementById('nav-rooms');
        const appContainer = document.getElementById('app-container');
        const friendsScreen = document.getElementById('friends-screen');

        if (navFriends) {
            navFriends.addEventListener('click', (e) => {
                e.preventDefault();
                friendsScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                updateNav(navFriends);
                renderFriendsScreen(); 
            });
        }

        if (navRooms) {
            navRooms.addEventListener('click', (e) => {
                e.preventDefault();
                appContainer.classList.remove('hidden');
                friendsScreen.classList.add('hidden');
                updateNav(navRooms);
            });
        }
    }
    
    function setupDataListeners() {
        if (!state.currentUserId) return;
        cleanupOldListeners();

        state.unsubscribeUserData = onSnapshot(doc(db, 'users', state.currentUserId), (docSnap) => {
            if (docSnap.exists()) {
                const oldData = state.currentUserData;
                state.currentUserData = { uid: docSnap.id, ...docSnap.data() };
                if (JSON.stringify(oldData?.friends) !== JSON.stringify(state.currentUserData.friends)) {
                    fetchFriendsData(); 
                }
                renderApp();
            } else {
                console.error("User document not found, signing out.");
                signOut(auth);
            }
        });

        const roomsQuery = query(collection(db, 'rooms'), where("members", "array-contains", state.currentUserId));
        state.unsubscribeUserRooms = onSnapshot(roomsQuery, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "modified") {
                    const changedRoomData = { id: change.doc.id, ...change.doc.data() };
                    const lastMessage = changedRoomData.lastMessage;

                    if (lastMessage && lastMessage.senderId !== state.currentUserId) {
                        const chatPanel = document.getElementById('chat-panel');
                        const guestContainer = document.getElementById('guest-container');
                        const isChatOpen = (chatPanel?.dataset.currentRoomId === changedRoomData.id) || (guestContainer?.dataset.currentRoomId === changedRoomData.id);

                        if (!isChatOpen) {
                            if (navigator.vibrate) {
                                navigator.vibrate([100, 50, 100]);
                            }
                            if (changedRoomData.isDirectMessage && !state.currentUserData.isGuest) {
                                const otherUserId = changedRoomData.members.find(id => id !== state.currentUserId);
                                const otherUserDetails = changedRoomData.memberDetails || {};
                                const otherUserPhoto = changedRoomData.memberPhotos || {};
                                createOrGetDirectMessageRoom(otherUserId, otherUserDetails[otherUserId], otherUserPhoto[otherUserId]);
                            }
                        }
                    }
                }
            });

            state.roomsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        });

        const statusRef = rtdbRef(rtdb, 'status');
        if (rtdb) {
            state.unsubscribePresence = onValue(statusRef, (snapshot) => {
                state.usersStatus = snapshot.val() || {};
                renderApp();
            });
        }
    }
    
    async function fetchFriendsData() {
        const { friends = [] } = state.currentUserData || {};
        if (friends.length === 0) {
            state.friendsData.clear();
            renderApp();
            return;
        }
        const friendsQuery = query(collection(db, 'users'), where('uid', 'in', friends));
        const friendsSnapshots = await getDocs(friendsQuery);
        state.friendsData.clear();
        friendsSnapshots.forEach(doc => {
            state.friendsData.set(doc.id, doc.data());
        });
        renderApp();
    }

    function cleanupOldListeners() {
        if (state.unsubscribeUserData) state.unsubscribeUserData();
        if (state.unsubscribeUserRooms) state.unsubscribeUserRooms();
        if (state.unsubscribePresence) state.unsubscribePresence();
    }

    function renderSidebarHeader() {
        if (!state.currentUserData) return;
        
        const profilePic = document.getElementById('my-profile-pic');
        const username = document.getElementById('sidebar-username');
        const status = document.getElementById('sidebar-status');
        
        if (profilePic) profilePic.src = state.currentUserData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(state.currentUserData.username?.[0] || 'U') + '&background=random&color=fff';
        if (username) username.textContent = state.currentUserData.username || 'Usuário';
        if (status) status.textContent = state.currentUserData.isGuest ? 'Convidado' : 'Online';
    }

    function renderApp() {
        if (!state.currentUserData || !document.getElementById('sidebar')) return;
        renderSidebarHeader();
        renderSidebarLists();
        renderFriendsScreen();
        updateFriendRequestsBadge();

        const createRoomBtn = document.getElementById('create-room-btn');
        if (createRoomBtn) {
            createRoomBtn.style.display = state.currentUserData.isGuest ? 'none' : 'flex';
        }
    }

    function renderSidebarLists() {
        const container = document.getElementById('room-list-container');
        const searchInput = document.getElementById('conversation-search-input');
        
        if (!container || !state.currentUserData) return;

        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        let roomsData = [...state.roomsData];

        // Filtra as salas se houver um termo de busca
        if (searchTerm) {
            roomsData = roomsData.filter(room => {
                const roomName = getRoomDisplayName(room, state.currentUserId).toLowerCase();
                return roomName.includes(searchTerm);
            });
        }

        let roomsHtml = '';
        if (roomsData.length > 0) {
            roomsData.sort((a, b) => (b.lastMessage?.timestamp || 0) - (a.lastMessage?.timestamp || 0));
            roomsHtml = roomsData.map(room => renderRoomItem(room)).join('');
        } else {
             roomsHtml += `<p class="px-4 text-sm text-gray-500 text-center mt-10">${searchTerm ? 'Nenhuma conversa encontrada.' : 'Você ainda não tem conversas. Inicie uma nova clicando no botão +.'}</p>`;
        }

        container.innerHTML = roomsHtml;

        // Reconecta os eventos de clique para cada item de conversa
        container.querySelectorAll('.room-item').forEach(el => {
            el.onclick = () => openRoom(el.dataset.roomId);
        });
    }

    function getRoomDisplayName(room, currentUserId) {
        if (!room) return 'Conversa';
        
        if (room.isDirectMessage) {
            const otherUserId = room.members?.find(id => id !== currentUserId);
            return room.memberDetails?.[otherUserId] || 'Usuário';
        }
        
        return room.name || 'Sala sem nome';
    }
    function updateNav(activeButton) {
        const navFriends = document.getElementById('nav-friends');
        const navRooms = document.getElementById('nav-rooms');
        if (!navFriends || !navRooms) return;

        [navFriends, navRooms].forEach(btn => {

            btn.classList.remove('text-indigo-400', 'border-t-2', 'border-indigo-500');
            btn.classList.add('text-gray-400');
        });
        activeButton.classList.add('text-indigo-400', 'border-t-2', 'border-indigo-500');
        activeButton.classList.remove('text-gray-400');
    }

    async function handleFriendSearch() {
        const searchInput = document.getElementById('friend-search-input');
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
            state.userSearchResults = []; // Limpa os resultados se a busca estiver vazia
            renderFriendsScreen();
            return;
        }

        try {
            // Busca por usuários cujo nome minúsculo começa com o termo de busca
            const usersRef = collection(db, 'users');
            const q = query(usersRef, 
                where('username_lowercase', '>=', searchTerm),
                where('username_lowercase', '<=', searchTerm + '\uf8ff')
            );
            
            const querySnapshot = await getDocs(q);
            state.userSearchResults = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFriendsScreen(); // Re-renderiza a tela com os resultados da busca
        } catch (error) {
            console.error("Erro ao buscar usuários:", error);
            showNotification("Não foi possível realizar a busca.", "error");
        }
    }    function formatTimestamp(ts) {
        if (!ts || !ts.toDate) return '';
        const date = ts.toDate();
        const now = new Date();
        const diffSeconds = (now.getTime() - date.getTime()) / 1000;
        const diffDays = Math.floor(diffSeconds / 86400);

        if (diffDays < 1 && date.getDate() === now.getDate()) {
            return date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }
        if (diffDays < 2 && date.getDate() === now.getDate() - 1) {
            return 'Ontem';
        }
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    function renderRoomItem(room) {
        const roomName = getRoomDisplayName(room, state.currentUserId);
        
        let photoURL = room.photoURL;
        if (room.isDirectMessage) {
            const otherUserId = room.members.find(id => id !== state.currentUserId);
            photoURL = room.memberPhotos?.[otherUserId] || `https://ui-avatars.com/api/?name=${encodeURIComponent(roomName[0])}&background=random&color=fff`;
        }

        const lastMessage = room.lastMessage;
        let lastMessageHtml = '<span class="text-gray-500">Nenhuma mensagem ainda.</span>';
        if (lastMessage) {
            const messageText = lastMessage.type === 'image' ? '📷 Foto' : (lastMessage.type === 'audio' ? '🎤 Áudio' : (lastMessage.text || ''));
            const senderPrefix = lastMessage.senderId === state.currentUserId ? "Você: " : "";
            lastMessageHtml = `<span class="text-gray-400 truncate">${senderPrefix}${messageText}</span>`;
        }

        const timestamp = lastMessage?.timestamp ? formatTimestamp(lastMessage.timestamp) : '';

        return `
            <div class="room-item group relative p-3 mx-2 rounded-xl flex items-center hover:bg-gray-800 cursor-pointer transition-all duration-200" data-room-id="${room.id}">
                <div class="relative flex-shrink-0">
                    <img src="${photoURL}" class="w-14 h-14 rounded-full object-cover ring-2 ring-gray-700/50 group-hover:ring-blue-500 transition-all duration-300" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(roomName[0])}&background=random&color=fff';">
                </div>
                <div class="flex-1 ml-4 min-w-0 border-b border-gray-800 group-hover:border-gray-700 py-3 pr-2">
                    <div class="flex justify-between items-center">
                        <h3 class="font-bold text-white truncate">${roomName}</h3>
                        <span class="text-xs text-gray-500 flex-shrink-0 ml-2">${timestamp}</span>
                    </div>
                    <div class="flex justify-between items-start mt-1">
                        ${lastMessageHtml}
                        <!-- Futuramente, um contador de mensagens não lidas pode ir aqui -->
                    </div>
                </div>
            </div>
        `;
    }

    // Função básica para abrir uma sala/conversa
    async function openRoom(roomId, isFromUrl = false) {
        if (!roomId) return;
        
        try {
            const roomRef = doc(db, 'rooms', roomId);
            const roomDoc = await getDoc(roomRef);
            
            if (!roomDoc.exists()) {
                showNotification("Esta conversa não existe mais.", "error");
                return;
            }
            
            const roomData = { id: roomDoc.id, ...roomDoc.data() };
            
            // Verifica se o usuário é membro da sala
            if (!roomData.members.includes(state.currentUserId)) {
                showNotification("Você não tem acesso a esta conversa.", "error");
                return;
            }
            
            // Atualiza o painel de chat com a conversa selecionada
            const chatPanel = document.getElementById('chat-panel');
            if (chatPanel) {
                chatPanel.dataset.currentRoomId = roomId;
                
                // Aqui você pode implementar a lógica para carregar mensagens
                chatPanel.innerHTML = `
                    <div class="h-full flex items-center justify-center text-center p-4">
                        <p class="text-gray-500">Conversa: ${getRoomDisplayName(roomData, state.currentUserId)}</p>
                    </div>
                `;
                
                console.log("Sala aberta:", roomData);
                // TODO: Implementar carregamento de mensagens aqui
            }
            
        } catch (error) {
            console.error("Erro ao abrir sala:", error);
            showNotification("Erro ao abrir conversa.", "error");
        }
    }

    // Função básica para criar ou obter uma conversa direta
    async function createOrGetDirectMessageRoom(otherUserId, otherUsername, otherUserPhoto) {
        if (!otherUserId || otherUserId === state.currentUserId) return;
        
        try {
            // Cria um ID único para a conversa direta baseado nos IDs dos usuários
            const roomId = `dm_${[state.currentUserId, otherUserId].sort().join('_')}`;
            
            const roomRef = doc(db, 'rooms', roomId);
            const roomDoc = await getDoc(roomRef);
            
            if (!roomDoc.exists()) {
                // Cria nova conversa direta
                const newRoomData = {
                    id: roomId,
                    name: '', // Conversas diretas não têm nome fixo
                    isDirectMessage: true,
                    members: [state.currentUserId, otherUserId],
                    memberDetails: {
                        [state.currentUserId]: state.currentUserData.username,
                        [otherUserId]: otherUsername
                    },
                    memberPhotos: {
                        [state.currentUserId]: state.currentUserData.photoURL || '',
                        [otherUserId]: otherUserPhoto || ''
                    },
                    createdAt: new Date(),
                    lastMessage: null
                };
                
                await setDoc(roomRef, newRoomData);
                console.log("Nova conversa direta criada:", roomId);
            }
            
            // Abre a conversa
            await openRoom(roomId);
            
        } catch (error) {
            console.error("Erro ao criar/abrir conversa direta:", error);
            showNotification("Erro ao abrir conversa com o usuário.", "error");
        }
    }
</script>
<script>
    // --- Lógica para ajuste de altura do viewport em celulares ---
    function setRealViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--real-vh', `${vh}px`);
    }
    window.addEventListener('resize', setRealViewportHeight);
    setRealViewportHeight(); // Executa no carregamento inicial    // --- PWA Service Worker & Manifest ---
    const MANIFEST_DATA = {
        "name": "7Chat", "short_name": "7Chat", "description": "Um aplicativo de chat em tempo real.",
        "start_url": "/", "scope": "/", "display": "standalone", "background_color": "#000000", "theme_color": "#111827",
        "icons": [
            { "src": "https://placehold.co/192x192/4f46e5/ffffff?text=7C", "sizes": "192x192", "type": "image/png" },
            { "src": "https://placehold.co/512x512/4f46e5/ffffff?text=7Chat", "sizes": "512x512", "type": "image/png" },
            { "src": "https://placehold.co/512x512/4f46e5/ffffff?text=7Chat&maskable=true", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
        ]
    };
    const manifestBlob = new Blob([JSON.stringify(MANIFEST_DATA)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link');
    link.rel = 'manifest'; link.href = manifestURL;
    document.head.appendChild(link);
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then((registration) => {
                console.log('Service Worker registrado com sucesso:', registration);
            }).catch((err) => {                console.warn('Falha no registro do Service Worker: ', err);
            });    }

    // === CORREÇÃO PARA TECLADO VIRTUAL EM PWA ===

    // Função para detectar se é PWA instalada
    function isPWA() {
        return window.matchMedia('(display-mode: standalone)').matches || 
               window.navigator.standalone === true ||
               document.referrer.includes('android-app://');
    }

    // Configurar altura real da viewport
    function setRealVH() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--real-vh', `${vh}px`);
    }

    // Detectar aparição do teclado virtual
    function setupKeyboardDetection() {
        let initialViewportHeight = window.innerHeight;
        let currentViewportHeight = window.innerHeight;
        
        const handleResize = () => {
            currentViewportHeight = window.innerHeight;
            const heightDifference = initialViewportHeight - currentViewportHeight;
            
            // Se a diferença for maior que 150px, provavelmente o teclado apareceu
            if (heightDifference > 150) {
                document.body.classList.add('keyboard-open');
                setRealVH();
            } else {
                document.body.classList.remove('keyboard-open');
                setRealVH();
            }
        };
        
        // Detectar mudanças no viewport
        window.addEventListener('resize', handleResize);
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                initialViewportHeight = window.innerHeight;
                setRealVH();
            }, 500);
        });
    }

    // Scroll automático para inputs em foco
    function setupInputFocusHandling() {
        const inputs = document.querySelectorAll('input, textarea');
        
        inputs.forEach(input => {
            input.addEventListener('focus', (e) => {
                setTimeout(() => {
                    if (isPWA()) {
                        e.target.classList.add('input-focused');
                        e.target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center',
                            inline: 'nearest'
                        });
                    }
                }, 300); // Delay para aguardar o teclado aparecer
            });
            
            input.addEventListener('blur', (e) => {
                e.target.classList.remove('input-focused');
            });
        });
    }

    // Inicializar correções quando DOM estiver pronto
    document.addEventListener('DOMContentLoaded', () => {
        setRealVH();
        
        if (isPWA()) {
            setupKeyboardDetection();
            setupInputFocusHandling();
            
            // Aplicar classe específica para PWA
            document.body.classList.add('pwa-mode');
        }
    });    // Atualizar altura quando a tela redimensionar
    window.addEventListener('resize', setRealVH);    // Chamar a função main quando a página carregar
    main();

    // Função para configurar navegação
    function setupNavigation() {
        const appContainer = document.getElementById('app-container');
        const friendsScreen = document.getElementById('friends-screen');
        const navRooms = document.getElementById('nav-rooms');

        if (navRooms) {
            navRooms.addEventListener('click', (e) => {
                e.preventDefault();
                friendsScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                updateNav(navRooms);
            });
        }

        // Navegação para configurações (terceiro botão)
        const navSettings = document.getElementById('nav-settings');
        if (navSettings) {
            navSettings.addEventListener('click', (e) => {
                e.preventDefault();
                openUserSettings();
            });
        }
    }

    // Função para atualizar navegação ativa
    function updateNav(activeElement) {
        const navItems = document.querySelectorAll('#nav-friends, #nav-rooms, #nav-settings');
        navItems.forEach(item => {
            item.classList.remove('text-indigo-400', 'border-t-2', 'border-indigo-500');
            item.classList.add('text-gray-400');
        });
        
        activeElement.classList.remove('text-gray-400');
        activeElement.classList.add('text-indigo-400', 'border-t-2', 'border-indigo-500');
    }

    // Funções necessárias (versões básicas para teste)
    function setupDataListeners() {
        console.log('Configurando listeners de dados...');
    }

    function openUserSettings() {
        const modal = document.getElementById('user-settings-modal');
        const userPic = document.getElementById('user-settings-pic');
        const userName = document.getElementById('user-settings-name');
        const logoutBtn = document.getElementById('logout-btn');
        
        if (!modal || !state.currentUserData) return;
        
        // Preencher dados do usuário
        if (userPic) {
            userPic.src = state.currentUserData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(state.currentUserData.username?.[0] || 'U') + '&background=random&color=fff';
        }
        
        if (userName) {
            userName.value = state.currentUserData.username || '';
        }
        
        // Configurar logout
        if (logoutBtn) {
            logoutBtn.onclick = async () => {
                try {
                    await signOut(auth);
                    modal.classList.add('hidden');
                } catch (error) {
                    console.error('Erro ao fazer logout:', error);
                    showNotification('Erro ao fazer logout.', 'error');
                }
            };
        }
        
        modal.classList.remove('hidden');
    }

    function openFriendRequestsModal() {
        const modal = document.getElementById('friend-requests-modal');
        const container = document.getElementById('friend-requests-list');
        
        if (!modal || !container) return;
        
        // Renderizar lista de pedidos
        renderFriendRequests(container);
        
        modal.classList.remove('hidden');
    }

    async function renderFriendRequests(container) {
        if (!state.currentUserData?.friendRequests || state.currentUserData.friendRequests.length === 0) {
            container.innerHTML = '<p class="text-center text-gray-400 py-4">Nenhum pedido de amizade.</p>';
            return;
        }
        
        try {
            // Buscar dados dos usuários que enviaram pedidos
            const requestsQuery = query(
                collection(db, 'users'),
                where('uid', 'in', state.currentUserData.friendRequests)
            );
            
            const requestsSnapshot = await getDocs(requestsQuery);
            const requesters = requestsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            let html = '';
            requesters.forEach(requester => {
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-700 rounded-lg mb-2">
                        <div class="flex items-center space-x-3">
                            <img src="${requester.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(requester.username?.[0] || 'U') + '&background=random&color=fff'}" 
                                 class="w-10 h-10 rounded-full" alt="${requester.username}">
                            <div>
                                <div class="text-white font-medium">${requester.username}</div>
                                <div class="text-gray-400 text-sm">${requester.isGuest ? 'Convidado' : 'Usuário'}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="acceptFriendRequest('${requester.uid}')" 
                                    class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg">
                                Aceitar
                            </button>
                            <button onclick="rejectFriendRequest('${requester.uid}')" 
                                    class="px-3 py-1 bg-red-600 hover:bg-red-700 text-white text-sm rounded-lg">
                                Recusar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
        } catch (error) {
            console.error('Erro ao carregar pedidos de amizade:', error);
            container.innerHTML = '<p class="text-center text-red-400 py-4">Erro ao carregar pedidos.</p>';
        }
    }

    async function acceptFriendRequest(userId) {
        try {
            const batch = writeBatch(db);
            
            // Adicionar aos amigos do usuário atual
            const currentUserRef = doc(db, 'users', state.currentUserId);
            batch.update(currentUserRef, {
                friends: arrayUnion(userId),
                friendRequests: arrayRemove(userId)
            });
            
            // Adicionar usuário atual aos amigos do solicitante
            const requesterRef = doc(db, 'users', userId);
            batch.update(requesterRef, {
                friends: arrayUnion(state.currentUserId)
            });
            
            await batch.commit();
            
            showNotification('Pedido de amizade aceito!', 'success');
            
            // Recarregar a lista
            const container = document.getElementById('friend-requests-list');
            if (container) {
                renderFriendRequests(container);
            }
            
        } catch (error) {
            console.error('Erro ao aceitar pedido:', error);
            showNotification('Erro ao aceitar pedido de amizade.', 'error');
        }
    }

    async function rejectFriendRequest(userId) {
        try {
            // Remover apenas dos pedidos pendentes
            await updateDoc(doc(db, 'users', state.currentUserId), {
                friendRequests: arrayRemove(userId)
            });
            
            showNotification('Pedido de amizade recusado.', 'info');
            
            // Recarregar a lista
            const container = document.getElementById('friend-requests-list');
            if (container) {
                renderFriendRequests(container);
            }
            
        } catch (error) {
            console.error('Erro ao recusar pedido:', error);
            showNotification('Erro ao recusar pedido de amizade.', 'error');
        }
    }

    // Atualizar badge de pedidos de amizade
    function updateFriendRequestsBadge() {
        const badge = document.getElementById('friend-requests-badge');
        if (!badge || !state.currentUserData) return;
        
        const requestsCount = state.currentUserData.friendRequests?.length || 0;
        
        if (requestsCount > 0) {
            badge.textContent = requestsCount;
            badge.classList.remove('hidden');
        } else {
            badge.classList.add('hidden');
        }
    }

    function renderSidebarLists() {
        console.log('Renderizando listas da sidebar...');
    }

    function renderFriendsScreen() {
        const container = document.getElementById('friends-list-container');
        const searchInput = document.getElementById('friend-search-input');
        
        if (!container || !state.currentUserData) return;

        const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
        let html = '';

        // Se houver termo de busca, mostrar resultados da busca
        if (searchTerm && state.userSearchResults.length > 0) {
            html += '<div class="mb-4"><h3 class="text-lg font-semibold text-white mb-3">Resultados da Busca</h3>';
            
            state.userSearchResults.forEach(user => {
                if (user.uid === state.currentUserId) return; // Não mostrar o próprio usuário
                
                const isFriend = state.currentUserData.friends?.includes(user.uid);
                const hasSentRequest = state.currentUserData.friendRequests?.includes(user.uid);
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg mb-2">
                        <div class="flex items-center space-x-3">
                            <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(user.username?.[0] || 'U') + '&background=random&color=fff'}" 
                                 class="w-10 h-10 rounded-full" alt="${user.username}">
                            <div>
                                <div class="text-white font-medium">${user.username}</div>
                                <div class="text-gray-400 text-sm">${user.isGuest ? 'Guest' : 'User'}</div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            ${isFriend ? 
                                `<button onclick="startDirectMessage('${user.uid}', '${user.username}', '${user.photoURL || ''}')" class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">Mensagem</button>` :
                                hasSentRequest ?
                                    `<span class="px-3 py-1 bg-gray-600 text-gray-300 text-sm rounded-lg">Pedido Enviado</span>` :
                                    `<button onclick="sendFriendRequest('${user.uid}')" class="px-3 py-1 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg">Adicionar</button>`
                            }
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
        }

        // Lista de amigos
        if (state.friendsData.size > 0) {
            html += '<div class="mb-4"><h3 class="text-lg font-semibold text-white mb-3">Meus Amigos</h3>';
            
            Array.from(state.friendsData.entries()).forEach(([friendId, friendData]) => {
                const isOnline = state.usersStatus[friendId]?.state === 'online';
                const editMode = state.isEditingFriends;
                const isSelected = state.selectedFriendsForDeletion.includes(friendId);
                
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg mb-2 ${editMode ? 'cursor-pointer hover:bg-gray-700' : ''}" 
                         ${editMode ? `onclick="toggleFriendSelection('${friendId}')"` : ''}>
                        <div class="flex items-center space-x-3">
                            ${editMode ? `<input type="checkbox" ${isSelected ? 'checked' : ''} class="mr-2">` : ''}
                            <div class="relative">
                                <img src="${friendData.photoURL || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(friendData.username?.[0] || 'U') + '&background=random&color=fff'}" 
                                     class="w-10 h-10 rounded-full" alt="${friendData.username}">
                                <div class="absolute -bottom-1 -right-1 w-3 h-3 ${isOnline ? 'bg-green-500' : 'bg-gray-500'} border-2 border-gray-800 rounded-full"></div>
                            </div>
                            <div>
                                <div class="text-white font-medium">${friendData.username}</div>
                                <div class="text-gray-400 text-sm">${isOnline ? 'Online' : 'Offline'}</div>
                            </div>
                        </div>
                        ${!editMode ? `
                            <button onclick="startDirectMessage('${friendId}', '${friendData.username}', '${friendData.photoURL || ''}')" 
                                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg">
                                Mensagem
                            </button>
                        ` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
        } else if (!searchTerm) {
            html += '<div class="text-center py-8"><p class="text-gray-400 mb-4">Você ainda não tem amigos.</p><p class="text-gray-500 text-sm">Use a busca acima para encontrar pessoas.</p></div>';
        }

        container.innerHTML = html;

        // Atualizar estado dos botões de edição
        const editBtn = document.getElementById('edit-friends-btn');
        const doneBtn = document.getElementById('done-editing-btn');
        const deleteBar = document.getElementById('delete-actions-bar');
        const deleteBtn = document.getElementById('delete-selected-btn');

        if (editBtn && doneBtn && deleteBar && deleteBtn) {
            if (state.isEditingFriends) {
                editBtn.classList.add('hidden');
                doneBtn.classList.remove('hidden');
                deleteBar.classList.remove('hidden');
                deleteBtn.disabled = state.selectedFriendsForDeletion.length === 0;
            } else {
                editBtn.classList.remove('hidden');
                doneBtn.classList.add('hidden');
                deleteBar.classList.add('hidden');
                state.selectedFriendsForDeletion = [];
            }
        }
    }

    async function sendFriendRequest(userId) {
        try {
            const userRef = doc(db, 'users', userId);
            await updateDoc(userRef, {
                friendRequests: arrayUnion(state.currentUserId)
            });
            
            showNotification('Pedido de amizade enviado!', 'success');
            
            // Atualizar estado local
            state.userSearchResults = state.userSearchResults.map(user => 
                user.uid === userId ? { ...user, hasSentRequest: true } : user
            );
            renderFriendsScreen();
        } catch (error) {
            console.error('Erro ao enviar pedido de amizade:', error);
            showNotification('Erro ao enviar pedido de amizade.', 'error');
        }
    }

    async function startDirectMessage(userId, username, photoURL) {
        try {
            await createOrGetDirectMessageRoom(userId, username, photoURL);
            
            // Alternar para a tela de salas
            document.getElementById('friends-screen').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            updateNav(document.getElementById('nav-rooms'));
        } catch (error) {
            console.error('Erro ao iniciar conversa:', error);
            showNotification('Erro ao iniciar conversa.', 'error');
        }
    }

    function toggleFriendSelection(friendId) {
        const index = state.selectedFriendsForDeletion.indexOf(friendId);
        if (index > -1) {
            state.selectedFriendsForDeletion.splice(index, 1);
        } else {
            state.selectedFriendsForDeletion.push(friendId);
        }
        
        const deleteBtn = document.getElementById('delete-selected-btn');
        if (deleteBtn) {
            deleteBtn.disabled = state.selectedFriendsForDeletion.length === 0;
        }
        
        renderFriendsScreen();
    }

    async function handleCreateRoomSubmit(e) {
        e.preventDefault();
        
        const roomNameInput = document.getElementById('room-name-input');
        const roomPasswordInput = document.getElementById('room-password-input');
        
        const roomName = roomNameInput.value.trim();
        const roomPassword = roomPasswordInput.value.trim();
        
        if (!roomName) {
            showNotification('Digite um nome para a sala.', 'error');
            return;
        }
        
        try {
            const roomData = {
                name: roomName,
                isDirectMessage: false,
                members: [state.currentUserId],
                memberDetails: {
                    [state.currentUserId]: state.currentUserData.username
                },
                memberPhotos: {
                    [state.currentUserId]: state.currentUserData.photoURL || ''
                },
                createdAt: serverTimestamp(),
                createdBy: state.currentUserId,
                lastMessage: null,
                photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(roomName[0])}&background=random&color=fff`
            };
            
            if (roomPassword) {
                roomData.password = roomPassword;
                roomData.isPrivate = true;
            }
            
            const roomRef = await addDoc(collection(db, 'rooms'), roomData);
            
            showNotification('Sala criada com sucesso!', 'success');
            
            // Fechar modal
            document.getElementById('create-room-modal').classList.add('hidden');
            roomNameInput.value = '';
            roomPasswordInput.value = '';
            
            // Abrir a nova sala
            setTimeout(() => {
                openRoom(roomRef.id);
            }, 500);
            
        } catch (error) {
            console.error('Erro ao criar sala:', error);
            showNotification('Erro ao criar sala. Tente novamente.', 'error');
        }
    }

    async function openRoom(roomId, isFromUrl = false) {
        if (!roomId) return;
        
        try {
            const roomRef = doc(db, 'rooms', roomId);
            const roomDoc = await getDoc(roomRef);
            
            if (!roomDoc.exists()) {
                showNotification("Esta conversa não existe mais.", "error");
                return;
            }
            
            const roomData = { id: roomDoc.id, ...roomDoc.data() };
            
            // Verifica se o usuário é membro da sala
            if (!roomData.members.includes(state.currentUserId)) {
                showNotification("Você não tem acesso a esta conversa.", "error");
                return;
            }
            
            // Atualizar estado da sala atual
            state.currentRoomData = roomData;
            
            // Atualizar UI do chat
            updateChatUI(roomData);
            
            // Carregar mensagens
            loadMessages(roomId);
            
            // Mostrar painel de chat ativo
            document.getElementById('welcome-panel').classList.add('hidden');
            document.getElementById('active-chat').classList.remove('hidden');
            
        } catch (error) {
            console.error("Erro ao abrir sala:", error);
            showNotification("Erro ao abrir conversa.", "error");
        }
    }

    function updateChatUI(roomData) {
        const chatTitle = document.getElementById('chat-title');
        const chatUserPic = document.getElementById('chat-user-pic');
        const chatStatus = document.getElementById('chat-status');
        
        const roomName = getRoomDisplayName(roomData, state.currentUserId);
        
        if (chatTitle) chatTitle.textContent = roomName;
        
        if (chatUserPic) {
            let photoURL = roomData.photoURL;
            if (roomData.isDirectMessage) {
                const otherUserId = roomData.members.find(id => id !== state.currentUserId);
                photoURL = roomData.memberPhotos?.[otherUserId] || photoURL;
            }
            chatUserPic.src = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(roomName[0])}&background=random&color=fff`;
        }
        
        if (chatStatus) {
            if (roomData.isDirectMessage) {
                const otherUserId = roomData.members.find(id => id !== state.currentUserId);
                const isOnline = state.usersStatus[otherUserId]?.state === 'online';
                chatStatus.textContent = isOnline ? 'Online' : 'Offline';
            } else {
                chatStatus.textContent = `${roomData.members.length} membros`;
            }
        }
    }

    function loadMessages(roomId) {
        // Limpar listener anterior se existir
        if (state.unsubscribeMessages) {
            state.unsubscribeMessages();
        }
        
        const messagesQuery = query(
            collection(db, 'messages'),
            where('roomId', '==', roomId),
            orderBy('timestamp', 'asc')
        );
        
        state.unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
            const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderMessages(messages);
        });
    }

    function renderMessages(messages) {
        const container = document.getElementById('messages-container');
        if (!container) return;
        
        let html = '';
        
        messages.forEach((message, index) => {
            const isOwn = message.senderId === state.currentUserId;
            const showAvatar = index === 0 || messages[index - 1].senderId !== message.senderId;
            const timestamp = message.timestamp ? formatTimestamp(message.timestamp) : '';
            
            html += `
                <div class="flex ${isOwn ? 'justify-end' : 'justify-start'} mb-4">
                    <div class="flex ${isOwn ? 'flex-row-reverse' : 'flex-row'} items-end space-x-2 max-w-xs lg:max-w-md">
                        ${showAvatar && !isOwn ? `
                            <img src="${message.senderPhoto || 'https://ui-avatars.com/api/?name=' + encodeURIComponent(message.senderName?.[0] || 'U') + '&background=random&color=fff'}" 
                                 class="w-8 h-8 rounded-full" alt="${message.senderName}">
                        ` : !isOwn ? '<div class="w-8"></div>' : ''}
                        
                        <div class="${isOwn ? 'bg-blue-600 text-white' : 'bg-gray-700 text-white'} px-4 py-2 rounded-2xl">
                            ${!isOwn && showAvatar ? `<div class="text-xs text-gray-300 mb-1">${message.senderName}</div>` : ''}
                            
                            ${message.type === 'text' ? `
                                <p class="break-words">${message.text}</p>
                            ` : message.type === 'image' ? `
                                <img src="${message.fileURL}" class="max-w-full rounded-lg cursor-pointer" onclick="openImageViewer('${message.fileURL}')">
                            ` : message.type === 'video' ? `
                                <video src="${message.fileURL}" controls class="max-w-full rounded-lg"></video>
                            ` : message.type === 'audio' ? `
                                <audio src="${message.fileURL}" controls class="w-full"></audio>
                            ` : ''}
                            
                            <div class="text-xs ${isOwn ? 'text-blue-200' : 'text-gray-400'} mt-1">${timestamp}</div>
                        </div>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        
        // Scroll para a última mensagem
        container.scrollTop = container.scrollHeight;
    }

    async function sendMessage() {
        const messageInput = document.getElementById('message-input');
        const messageText = messageInput.value.trim();
        
        if (!messageText || !state.currentRoomData) return;
        
        try {
            const messageData = {
                text: messageText,
                type: 'text',
                senderId: state.currentUserId,
                senderName: state.currentUserData.username,
                senderPhoto: state.currentUserData.photoURL || '',
                roomId: state.currentRoomData.id,
                timestamp: serverTimestamp()
            };
            
            // Adicionar mensagem
            await addDoc(collection(db, 'messages'), messageData);
            
            // Atualizar última mensagem da sala
            await updateDoc(doc(db, 'rooms', state.currentRoomData.id), {
                lastMessage: {
                    text: messageText,
                    senderId: state.currentUserId,
                    timestamp: serverTimestamp(),
                    type: 'text'
                }
            });
            
            // Limpar input
            messageInput.value = '';
            
        } catch (error) {
            console.error('Erro ao enviar mensagem:', error);
            showNotification('Erro ao enviar mensagem.', 'error');
        }
    }

    async function handleMediaUpload(event) {
        const file = event.target.files[0];
        if (!file || !state.currentRoomData) return;
        
        // Verificar tamanho do arquivo (max 10MB)
        if (file.size > 10 * 1024 * 1024) {
            showNotification('Arquivo muito grande. Máximo 10MB.', 'error');
            return;
        }
        
        try {
            showLoadingOverlay(true);
            
            // Upload do arquivo para o Firebase Storage
            const fileRef = storageRef(storage, `media/${Date.now()}_${file.name}`);
            const uploadSnapshot = await uploadBytes(fileRef, file);
            const fileURL = await getDownloadURL(uploadSnapshot.ref);
            
            // Determinar tipo do arquivo
            let messageType = 'file';
            if (file.type.startsWith('image/')) {
                messageType = 'image';
            } else if (file.type.startsWith('video/')) {
                messageType = 'video';
            } else if (file.type.startsWith('audio/')) {
                messageType = 'audio';
            }
            
            // Criar mensagem
            const messageData = {
                type: messageType,
                fileURL: fileURL,
                fileName: file.name,
                fileSize: file.size,
                senderId: state.currentUserId,
                senderName: state.currentUserData.username,
                senderPhoto: state.currentUserData.photoURL || '',
                roomId: state.currentRoomData.id,
                timestamp: serverTimestamp()
            };
            
            // Adicionar mensagem
            await addDoc(collection(db, 'messages'), messageData);
            
            // Atualizar última mensagem da sala
            const lastMessageText = messageType === 'image' ? '📷 Foto' : 
                                   messageType === 'video' ? '🎥 Vídeo' : 
                                   messageType === 'audio' ? '🎤 Áudio' : '📎 Arquivo';
            
            await updateDoc(doc(db, 'rooms', state.currentRoomData.id), {
                lastMessage: {
                    text: lastMessageText,
                    senderId: state.currentUserId,
                    timestamp: serverTimestamp(),
                    type: messageType
                }
            });
            
            showNotification('Arquivo enviado com sucesso!', 'success');
            
        } catch (error) {
            console.error('Erro ao fazer upload:', error);
            showNotification('Erro ao enviar arquivo.', 'error');
        } finally {
            showLoadingOverlay(false);
            event.target.value = ''; // Limpar input
        }
    }

    async function toggleAudioRecording() {
        const voiceBtn = document.getElementById('voice-btn');
        const icon = voiceBtn.querySelector('i');
        
        if (!state.isRecording) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                state.mediaRecorder = new MediaRecorder(stream);
                state.audioChunks = [];
                
                state.mediaRecorder.ondataavailable = (event) => {
                    state.audioChunks.push(event.data);
                };
                
                state.mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(state.audioChunks, { type: 'audio/wav' });
                    await sendAudioMessage(audioBlob);
                    
                    // Parar todas as tracks do stream
                    stream.getTracks().forEach(track => track.stop());
                };
                
                state.mediaRecorder.start();
                state.isRecording = true;
                state.recordingStartTime = Date.now();
                
                // Atualizar UI
                icon.className = 'fas fa-stop';
                voiceBtn.classList.add('bg-red-600');
                voiceBtn.classList.remove('hover:bg-gray-700');
                
                // Timer de gravação
                state.recordingTimerInterval = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - state.recordingStartTime) / 1000);
                    if (elapsed >= 60) { // Máximo 60 segundos
                        toggleAudioRecording();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('Erro ao iniciar gravação:', error);
                showNotification('Erro ao acessar o microfone.', 'error');
            }
        } else {
            // Parar gravação
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
            }
            
            state.isRecording = false;
            
            // Atualizar UI
            icon.className = 'fas fa-microphone';
            voiceBtn.classList.remove('bg-red-600');
            voiceBtn.classList.add('hover:bg-gray-700');
            
            if (state.recordingTimerInterval) {
                clearInterval(state.recordingTimerInterval);
            }
        }
    }

    async function sendAudioMessage(audioBlob) {
        if (!state.currentRoomData) return;
        
        try {
            showLoadingOverlay(true);
            
            // Upload do áudio
            const audioRef = storageRef(storage, `audio/${Date.now()}_recording.wav`);
            const uploadSnapshot = await uploadBytes(audioRef, audioBlob);
            const audioURL = await getDownloadURL(uploadSnapshot.ref);
            
            // Criar mensagem de áudio
            const messageData = {
                type: 'audio',
                fileURL: audioURL,
                fileName: 'Gravação de voz',
                senderId: state.currentUserId,
                senderName: state.currentUserData.username,
                senderPhoto: state.currentUserData.photoURL || '',
                roomId: state.currentRoomData.id,
                timestamp: serverTimestamp()
            };
            
            // Adicionar mensagem
            await addDoc(collection(db, 'messages'), messageData);
            
            // Atualizar última mensagem da sala
            await updateDoc(doc(db, 'rooms', state.currentRoomData.id), {
                lastMessage: {
                    text: '🎤 Áudio',
                    senderId: state.currentUserId,
                    timestamp: serverTimestamp(),
                    type: 'audio'
                }
            });
            
        } catch (error) {
            console.error('Erro ao enviar áudio:', error);
            showNotification('Erro ao enviar gravação.', 'error');
        } finally {
            showLoadingOverlay(false);
        }
    }

    function showLoadingOverlay(show) {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) {
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }
    }

    function openImageViewer(imageUrl) {
        const modal = document.getElementById('image-viewer-modal');
        const img = document.getElementById('image-viewer-pic');
        
        if (modal && img) {
            img.src = imageUrl;
            modal.classList.remove('hidden');
        }
    }

    async function deleteSelectedFriends() {
        if (state.selectedFriendsForDeletion.length === 0) return;
        
        try {
            const batch = writeBatch(db);
            
            // Remover dos amigos do usuário atual
            const currentUserRef = doc(db, 'users', state.currentUserId);
            batch.update(currentUserRef, {
                friends: arrayRemove(...state.selectedFriendsForDeletion)
            });
            
            // Remover o usuário atual dos amigos de cada amigo selecionado
            state.selectedFriendsForDeletion.forEach(friendId => {
                const friendRef = doc(db, 'users', friendId);
                batch.update(friendRef, {
                    friends: arrayRemove(state.currentUserId)
                });
            });
            
            await batch.commit();
            
            showNotification('Amigos removidos com sucesso.', 'success');
            
            state.isEditingFriends = false;
            state.selectedFriendsForDeletion = [];
            
        } catch (error) {
            console.error('Erro ao remover amigos:', error);
            showNotification('Erro ao remover amigos.', 'error');
        }
    }

    function showNotification(message, type = 'info') {
        const toast = document.getElementById('notification-toast');
        if (!toast) return;
        
        toast.textContent = message;
        
        // Define a cor baseada no tipo
        let bgColor = 'bg-blue-500'; // padrão
        if (type === 'error') bgColor = 'bg-red-500';
        else if (type === 'success') bgColor = 'bg-green-500';
        else if (type === 'warning') bgColor = 'bg-yellow-500';
        
        toast.className = `fixed bottom-5 right-5 py-2 px-4 rounded-lg shadow-xl z-[101] ${bgColor} text-white`;
        toast.classList.remove('hidden');
        
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    // Função global para fazer funções disponíveis no HTML
    window.sendFriendRequest = sendFriendRequest;
    window.startDirectMessage = startDirectMessage;
    window.toggleFriendSelection = toggleFriendSelection;
    window.acceptFriendRequest = acceptFriendRequest;
    window.rejectFriendRequest = rejectFriendRequest;
    window.openImageViewer = openImageViewer;
    window.shareRoomLink = shareRoomLink;

    function showCustomPrompt(title, message) {
        return new Promise((resolve) => {
            const modal = document.getElementById('custom-prompt-modal');
            document.getElementById('custom-prompt-title').textContent = title;
            document.getElementById('custom-prompt-message').textContent = message;
            const input = document.getElementById('custom-prompt-input');
            input.value = '';
            
            const okBtn = document.getElementById('custom-prompt-ok-btn');
            okBtn.onclick = () => {
                modal.classList.add('hidden');
                resolve(input.value);
            };
            
            modal.classList.remove('hidden');
            input.focus();
        });
    }

    function enforceNotifications() {
        // Por enquanto, sempre permitir
        return true;
    }

    function checkNotificationPermission() {
        return Notification?.permission || 'default';
    }

    function setupPresenceSystem() {
        if (!state.currentUserId || !rtdb) {
            console.warn('Presence system não pode ser inicializado - faltando userId ou rtdb');
            return;
        }
        
        try {
            const userStatusRef = rtdbRef(rtdb, `status/${state.currentUserId}`);
            const connectedRef = rtdbRef(rtdb, '.info/connected');
            
            // Quando conectado, definir status como online
            onValue(connectedRef, (snapshot) => {
                if (snapshot.val() === true) {
                    // Definir como online
                    set(userStatusRef, {
                        state: 'online',
                        lastSeen: rtdbServerTimestamp()
                    });
                    
                    // Quando desconectar, definir como offline
                    onDisconnect(userStatusRef).set({
                        state: 'offline',
                        lastSeen: rtdbServerTimestamp()
                    });
                }
            });
        } catch (error) {
            console.error('Erro ao configurar sistema de presença:', error);
        }
    }

    async function setupPushNotifications() {
        if (!messaging) {
            console.warn('Firebase Messaging não está disponível');
            return;
        }
        
        try {
            // Solicitar permissão para notificações
            const permission = await Notification.requestPermission();
            
            if (permission === 'granted') {
                // Obter token FCM
                const token = await getToken(messaging, {
                    vapidKey: 'BH8nFNyOJWHdYOcO7Qp5Y6WtF3J8uL7A9GhD2Cj4Bp8Kx6Mq5Vo2Z7Ty1Rf9Nw3Eg8Us5Qe7Zv6Yt8Kl4Hj9Po2'
                });
                
                if (token) {
                    // Salvar token no perfil do usuário
                    await updateDoc(doc(db, 'users', state.currentUserId), {
                        fcmTokens: arrayUnion(token)
                    });
                    
                    console.log('Token FCM registrado:', token);
                }
                
                // Escutar mensagens em primeiro plano
                onMessage(messaging, (payload) => {
                    console.log('Mensagem recebida em primeiro plano:', payload);
                    
                    // Mostrar notificação personalizada
                    showNotification(payload.notification?.body || 'Nova mensagem', 'info');
                });
                
            } else {
                console.warn('Permissão para notificações negada');
            }
            
        } catch (error) {
            console.error('Erro ao configurar push notifications:', error);
        }
    }

    function monitorNotificationStatus() {
        if (!('Notification' in window)) return;
        
        // Verificar status a cada 30 segundos
        state.notificationCheckInterval = setInterval(() => {
            const permission = Notification.permission;
            
            if (permission === 'denied') {
                showNotification('Notificações foram bloqueadas. Algumas funcionalidades podem não funcionar.', 'warning');
            }
        }, 30000);
    }

    // Função para configurar eventos de configurações da conversa
    function setupConversationSettings() {
        const chatSettingsBtn = document.getElementById('chat-settings-btn');
        const conversationModal = document.getElementById('conversation-settings-modal');
        const conversationPic = document.getElementById('conversation-settings-pic');
        const conversationName = document.getElementById('conversation-settings-name');
        const conversationType = document.getElementById('conversation-settings-type');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        
        if (chatSettingsBtn) {
            chatSettingsBtn.onclick = () => {
                if (!state.currentRoomData) return;
                
                // Preencher dados da conversa
                const roomName = getRoomDisplayName(state.currentRoomData, state.currentUserId);
                
                if (conversationName) conversationName.textContent = roomName;
                if (conversationType) {
                    conversationType.textContent = state.currentRoomData.isDirectMessage ? 'Conversa Privada' : 'Sala de Chat';
                }
                
                if (conversationPic) {
                    let photoURL = state.currentRoomData.photoURL;
                    if (state.currentRoomData.isDirectMessage) {
                        const otherUserId = state.currentRoomData.members.find(id => id !== state.currentUserId);
                        photoURL = state.currentRoomData.memberPhotos?.[otherUserId] || photoURL;
                    }
                    conversationPic.src = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(roomName[0])}&background=random&color=fff`;
                }
                
                conversationModal.classList.remove('hidden');
            };
        }
        
        if (clearChatBtn) {
            clearChatBtn.onclick = async () => {
                if (!state.currentRoomData) return;
                
                if (confirm('Tem certeza que deseja limpar todo o histórico desta conversa? Esta ação não pode ser desfeita.')) {
                    try {
                        // Buscar todas as mensagens da sala
                        const messagesQuery = query(
                            collection(db, 'messages'),
                            where('roomId', '==', state.currentRoomData.id)
                        );
                        
                        const messagesSnapshot = await getDocs(messagesQuery);
                        const batch = writeBatch(db);
                        
                        // Adicionar todas as mensagens ao batch para exclusão
                        messagesSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });
                        
                        // Limpar última mensagem da sala
                        batch.update(doc(db, 'rooms', state.currentRoomData.id), {
                            lastMessage: null
                        });
                        
                        await batch.commit();
                        
                        showNotification('Histórico da conversa limpo com sucesso.', 'success');
                        conversationModal.classList.add('hidden');
                        
                    } catch (error) {
                        console.error('Erro ao limpar conversa:', error);
                        showNotification('Erro ao limpar conversa.', 'error');
                    }
                }
            };
        }
    }

    function generateRoomInviteLink(roomId) {
        const baseUrl = window.location.origin + window.location.pathname;
        return `${baseUrl}?room=${roomId}`;
    }

    function shareRoomLink() {
        if (!state.currentRoomData) return;
        
        const shareModal = document.getElementById('share-link-modal');
        const shareLinkInput = document.getElementById('share-link-input');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        
        if (!shareModal || !shareLinkInput) return;
        
        const inviteLink = generateRoomInviteLink(state.currentRoomData.id);
        shareLinkInput.value = inviteLink;
        
        if (copyLinkBtn) {
            copyLinkBtn.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(inviteLink);
                    showNotification('Link copiado para a área de transferência!', 'success');
                } catch (error) {
                    console.error('Erro ao copiar link:', error);
                    
                    // Fallback para navegadores que não suportam clipboard API
                    shareLinkInput.select();
                    document.execCommand('copy');
                    showNotification('Link copiado!', 'success');
                }
            };
        }
        
        shareModal.classList.remove('hidden');
    }

    // Função para atualizar nome do usuário
    async function updateUserProfile() {
        const nameInput = document.getElementById('user-settings-name');
        const newName = nameInput?.value?.trim();
        
        if (!newName || !state.currentUserData) return;
        
        try {
            await updateDoc(doc(db, 'users', state.currentUserId), {
                username: newName,
                username_lowercase: newName.toLowerCase()
            });
            
            showNotification('Perfil atualizado com sucesso!', 'success');
            
        } catch (error) {
            console.error('Erro ao atualizar perfil:', error);
            showNotification('Erro ao atualizar perfil.', 'error');
        }
    }

    // Adicionar eventos aos modais
    function setupModalEvents() {
        // Save user settings
        const userModal = document.getElementById('user-settings-modal');
        const userNameInput = document.getElementById('user-settings-name');
        
        if (userNameInput) {
            userNameInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    updateUserProfile();
                }
            });
            
            userNameInput.addEventListener('blur', updateUserProfile);
        }
        
        // Close modals when clicking outside
        [
            'user-settings-modal',
            'room-settings-modal', 
            'create-room-modal',
            'friend-requests-modal',
            'user-search-modal',
            'conversation-settings-modal',
            'share-link-modal',
            'image-viewer-modal'
        ].forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            }
        });
    }

    function openRoom(roomId, isGuest = false) {
        console.log('Abrindo sala:', roomId);
        return Promise.resolve();
    }

    // INICIALIZAR APLICAÇÃO
    main();

</script>

<!-- PWA Manifest Generator -->
<script>
    // Gerar manifest.json dinamicamente
    const manifest = {
        name: "7Chat",
        short_name: "7Chat",
        description: "Aplicativo de chat em tempo real",
        start_url: "/",
        display: "standalone",
        background_color: "#1f2937",
        theme_color: "#1f2937",
        icons: [
            {
                src: "https://placehold.co/192x192/4f46e5/ffffff?text=7C",
                sizes: "192x192",
                type: "image/png"
            },
            {
                src: "https://placehold.co/512x512/4f46e5/ffffff?text=7C",
                sizes: "512x512",
                type: "image/png"
            }
        ]    };

    const manifestBlob2 = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL2 = URL.createObjectURL(manifestBlob2);
    const link2 = document.createElement('link');
    link2.rel = 'manifest';
    link2.href = manifestURL2;
    document.head.appendChild(link2);

    // Registrar Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then(registration => console.log('Service Worker registrado com sucesso:', registration))
            .catch(error => console.log('Falha ao registrar Service Worker:', error));
    }
</script>

</body>
</html>
