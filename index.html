
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>7Chat - Vers√£o Final Otimizada (Atualizado)</title>
    
    <!-- PWA Meta Tags -->    <meta name="theme-color" content="#1f2937"/>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Um aplicativo de chat em tempo real.">    <link rel="apple-touch-icon" href="https://placehold.co/192x192/4f46e5/ffffff?text=7C">
    <!-- O manifest.json √© gerado e injetado via script no final do body -->    <!-- Favicon inline para evitar erro 404 -->
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3e%3ctext y='24' font-size='24' fill='%234f46e5'%3e7%3c/text%3e%3c/svg%3e" type="image/svg+xml">
    <link rel="icon" href="/favicon.ico" />
    
    <!-- Tailwind CSS via CDN - Nota: Para produ√ß√£o, recomenda-se usar PostCSS ou Tailwind CLI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'spin': 'spin 1s linear infinite',
                        'ping': 'ping 1s cubic-bezier(0, 0, 0.2, 1) infinite',
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --real-vh: 1vh;
        }        html, body {
            height: 100vh; /* Fallback */
            height: calc(var(--real-vh, 1vh) * 100);
            overflow: hidden;
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%) !important;
        }
        .messages-container {
            background-image: url('https://i.imgur.com/kI46opI.png');
            background-size: cover;
            background-position: center;
        }
        #sidebar, #login-screen {
             background-image: url('https://i.imgur.com/KAWlxJS.png');
             background-size: cover;
             background-position: center;
        }        .header-blur, .form-blur {
            /* Backdrop blur mantido mas permitindo sobrescrita */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        .modal, .notification { animation: fadeIn .3s ease-out; }
        .modal-content { animation: slideUp .3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #9ca3af;
            animation: typing-bounce 1.2s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) { animation-delay: -1.0s; }
        .typing-indicator span:nth-child(3) { animation-delay: -0.8s; }
        @keyframes typing-bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }        /* Badge gen√©rico - removido estilo espec√≠fico para permitir customiza√ß√£o */
        
        /* Estilos modernos for√ßados */
        .group:hover .group-hover\:scale-105 {
            transform: scale(1.05) !important;
        }
        
        .group:hover .group-hover\:text-blue-400 {
            color: #60a5fa !important;
        }
        
        .group:hover .group-hover\:text-emerald-400 {
            color: #34d399 !important;
        }
        
        .group:hover .group-hover\:text-purple-400 {
            color: #c084fc !important;
        }
        
        .group:hover .group-hover\:text-indigo-400 {
            color: #818cf8 !important;
        }
        
        .group:hover .group-hover\:text-red-400 {
            color: #f87171 !important;
        }
        
        .group:hover .group-hover\:text-green-400 {
            color: #4ade80 !important;
        }
        
        .transition-all {
            transition: all 0.3s ease !important;
        }
        
        .hover\:scale-110:hover {
            transform: scale(1.1) !important;
        }
        
        .hover\:scale-105:hover {
            transform: scale(1.05) !important;
        }
          .backdrop-blur-xl {
            backdrop-filter: blur(24px) !important;
            -webkit-backdrop-filter: blur(24px) !important;
        }
        
        /* Estilos para mensagens */
        .message-item {
            margin-bottom: 0.75rem;
        }
        
        .message-item:last-child {
            margin-bottom: 0;
        }
        
        /* Quebra de linha para mensagens longas */
        .break-words {
            word-break: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* Anima√ß√£o suave para troca de √≠cones */
        #dynamic-action-btn svg {
            transition: opacity 0.2s ease-in-out;
        }
        .seen-icon {
            width: 18px;
            height: 18px;
            margin-left: 6px;
            align-self: flex-end;
            margin-bottom: 2px;
        }
        audio::-webkit-media-controls-panel {
            background-color: #4b5563;
        }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display,        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-volume-slider {
            filter: invert(1) grayscale(1) brightness(1.5);
        }
    </style>    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body class="bg-black text-gray-200 overflow-hidden">

    <!-- Menu de Navega√ß√£o Inferior -->
    <div class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-700 shadow-lg z-50">
        <div class="flex justify-around text-gray-400">
            <!-- Bot√£o Amigos -->
            <a href="#" id="nav-friends" class="flex flex-col items-center justify-center p-3 text-center w-full hover:text-white transition-colors duration-300">
                <i class="fas fa-user-friends text-xl"></i>
                <span class="text-xs font-medium">Amigos</span>
            </a>
            <!-- Bot√£o Salas (ativo por padr√£o) -->
            <a href="#" id="nav-rooms" class="flex flex-col items-center justify-center p-3 text-center w-full text-indigo-400 border-t-2 border-indigo-500 hover:text-white transition-colors duration-300">
                <i class="fas fa-comments text-xl"></i>
                <span class="text-xs font-medium">Salas</span>
            </a>
            <!-- Bot√£o Configurar -->
            <a href="#" id="nav-settings" class="flex flex-col items-center justify-center p-3 text-center w-full hover:text-white transition-colors duration-300">
                <i class="fas fa-cog text-xl"></i>
                <span class="text-xs font-medium">Configurar</span>
            </a>
        </div>
    </div>

    <!-- ELEMENTOS GLOBAIS -->
    <input type="file" id="image-uploader" class="hidden" accept="image/*" />
    <input type="file" id="media-uploader" class="hidden" accept="image/*,video/*" />
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-white"></div>
    </div>
    <div id="notification-toast" class="hidden fixed bottom-5 right-5 bg-blue-500 text-white py-2 px-4 rounded-lg shadow-xl z-[101]"></div>
    
    <!-- Menu de Contexto Customizado para Salas -->
    <div id="room-context-menu" class="hidden absolute bg-gray-800 rounded-md shadow-lg py-1 z-50 border border-gray-700">
        <a href="#" id="context-pin" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"></a>
        <a href="#" id="context-archive" class="block px-4 py-2 text-sm text-gray-300 hover:bg-gray-700"></a>
        <a href="#" id="context-clear-chat" class="hidden px-4 py-2 text-sm text-gray-300 hover:bg-gray-700">Limpar Conversa</a>
        <a href="#" id="context-delete" class="block px-4 py-2 text-sm text-red-500 hover:bg-red-900/50"></a>
    </div>

    <!-- TELA DE LOGIN -->
    <div id="login-screen" class="hidden items-center justify-center h-full p-4 flex-col">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
        <div id="invite-welcome-card" class="hidden w-full max-w-sm p-8 bg-gray-800/80 backdrop-blur-lg rounded-xl shadow-lg space-y-4 mb-4 text-center z-10 border border-gray-700">
            <h3 class="text-xl font-bold text-white">Voc√™ foi convidado!</h3>
            <p class="text-gray-400">Para entrar na sala, entre como convidado ou fa√ßa login na sua conta.</p>            <button id="enter-as-guest-btn" class="w-full px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-all duration-300">
                Entrar como Convidado
            </button>
        </div>
        <div class="w-full max-w-sm p-8 bg-gray-800/80 backdrop-blur-lg rounded-xl shadow-lg space-y-6 z-10 border border-gray-700">
            <h2 id="login-title" class="text-3xl font-extrabold text-center bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-cyan-400">7Chat</h2>            <form id="login-form" class="space-y-4">
                <input id="email-input" type="email" required placeholder="E-mail" autocomplete="email" class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400 transition-all duration-300">
                <input id="password-input" type="password" required placeholder="Senha" autocomplete="current-password" class="w-full px-4 py-3 border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-700 text-white placeholder-gray-400 transition-all duration-300">
                <button type="submit" class="w-full flex items-center justify-center py-3 bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-semibold rounded-lg shadow-md hover:from-blue-600 hover:to-indigo-700 transition-all duration-300">Login</button>
            </form>
            <div class="text-center">
                <span class="text-sm text-gray-500">ou</span>
                <button id="main-guest-login-btn" class="mt-2 text-blue-400 hover:text-blue-300 font-semibold">Entrar como convidado</button>
            </div>
        </div>
    </div>    <!-- CONTAINER PRINCIPAL DO APP -->
    <div id="app-container" class="hidden h-full w-full relative overflow-hidden"></div>
    
    <!-- Coloque seu conte√∫do principal (tela de salas/chat) aqui dentro -->
    <div id="rooms-screen">
        <!-- Exemplo: <h1 class="text-white text-center text-2xl mt-10">Tela de Salas</h1> -->    </div>

    <!-- Nova Tela de Amigos (inicialmente oculta) -->
    <div id="friends-screen" class="hidden h-full w-full flex flex-col bg-gray-900 text-white pb-20">
        <!-- Cabe√ßalho com T√≠tulo, Busca e Bot√£o de Editar -->
        <div class="bg-gray-800 shadow-md p-4 space-y-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold">Amigos</h1>
                <div>
                    <!-- Bot√µes que alternam de acordo com o modo de edi√ß√£o -->
                    <button id="edit-friends-btn" class="text-blue-400 hover:text-blue-300 font-semibold">Editar</button>
                    <button id="done-editing-btn" class="hidden text-blue-400 hover:text-blue-300 font-semibold">Concluir</button>
                </div>
            </div>
            <!-- Barra de Busca -->
            <div class="relative">
                <input type="text" id="friend-search-input" placeholder="Buscar amigo pelo nome exato..." class="w-full bg-gray-700 border border-gray-600 rounded-lg py-2 px-4 pl-10 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">
                    <i class="fas fa-search"></i>
                </div>
            </div>
        </div>

        <!-- Container da Lista de Amigos -->
        <div id="friends-list-container" class="flex-1 p-4 space-y-3 overflow-y-auto">
            <!-- A lista de amigos ser√° gerada pelo JavaScript aqui -->
        </div>

        <!-- Barra de A√ß√µes de Exclus√£o (inicialmente oculta) -->
        <div id="delete-actions-bar" class="hidden p-4 bg-gray-800 border-t border-gray-700">
            <button id="delete-selected-btn" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 disabled:bg-red-800 disabled:cursor-not-allowed" disabled>
                Excluir Selecionados
            </button>
        </div>
    </div>
    
    <div id="guest-container" class="hidden h-full w-full relative overflow-hidden"></div>

    <!-- MODAIS -->
    <div id="image-viewer-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-[50] p-4">
        <div class="modal-content bg-transparent rounded-lg w-full max-w-2xl text-center relative">
            <div class="w-full h-auto max-h-[85vh] overflow-hidden rounded-lg mx-auto">
                 <img id="image-viewer-pic" class="w-full h-full object-contain">
            </div>
            <div id="image-viewer-actions" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-4"></div>
            <button id="close-image-viewer-btn" class="absolute top-2 right-2 m-2 text-white/80 hover:text-white text-4xl font-light">&times;</button>
        </div>
    </div>

    <div id="custom-confirm-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div class="modal-content bg-gray-800 text-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center space-y-4 border border-gray-700">
            <h3 id="custom-confirm-title" class="text-xl font-bold"></h3>
            <p id="custom-confirm-message" class="text-gray-400"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-confirm-cancel-btn" class="px-6 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Cancelar</button>
                <button id="custom-confirm-ok-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
            </div>
        </div>
    </div>    <div id="custom-prompt-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm space-y-4 border border-gray-700">
            <h3 id="custom-prompt-title" class="text-xl font-bold text-center text-white"></h3>
            <p id="custom-prompt-message" class="text-gray-400 text-center"></p>
            <input type="text" id="custom-prompt-input" placeholder="Sua resposta aqui..." class="w-full border border-gray-600 rounded-md px-3 py-2 bg-gray-700 text-white" />
            <button id="custom-prompt-ok-btn" class="w-full px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Confirmar</button>
        </div>
    </div>

    <!-- MODAL DE NOTIFICA√á√ïES OBRIGAT√ìRIAS -->
    <div id="mandatory-notifications-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[70] p-4">
        <div class="modal-content bg-gray-800 rounded-xl shadow-2xl p-8 w-full max-w-md space-y-6 border border-gray-700">
            <div class="text-center">
                <div class="mx-auto w-16 h-16 bg-yellow-500 rounded-full flex items-center justify-center mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2">Notifica√ß√µes Obrigat√≥rias</h3>
                <p class="text-gray-300 text-center leading-relaxed">
                    Para usar o 7Chat, voc√™ precisa ativar as notifica√ß√µes. Isso garante que voc√™ receba mensagens importantes e tenha a melhor experi√™ncia no app.
                </p>
            </div>
            
            <div class="bg-gray-700/50 rounded-lg p-4 space-y-3">
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300">Receba mensagens em tempo real</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300">N√£o perca conversas importantes</span>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                    <span class="text-sm text-gray-300">Mantenha-se conectado</span>
                </div>
            </div>
            
            <button id="activate-mandatory-notifications-btn" class="w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-300 flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                </svg>
                <span>Ativar Notifica√ß√µes</span>
            </button>
            
            <p id="mandatory-notifications-status" class="text-xs text-center text-gray-500"></p>
        </div>
    </div>

    <div id="share-link-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Convidar para a Sala</h3><button id="close-share-link-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <p class="text-gray-400">Compartilhe este link para que outros possam entrar:</p>
            <div class="flex items-center space-x-2">
                <input type="text" id="share-link-input" readonly class="w-full border bg-gray-700 border-gray-600 rounded-lg px-3 py-2 text-sm text-gray-300">
                <button id="copy-link-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex-shrink-0">Copiar</button>
            </div>
        </div>
    </div>

    <div id="user-settings-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 text-white rounded-lg shadow-xl p-6 w-full max-w-md space-y-6 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold">Configura√ß√µes</h3><button id="close-user-settings-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div class="flex flex-col items-center space-y-4">
                <div class="relative group w-24 h-24">
                    <img id="user-settings-pic" class="w-full h-full rounded-full bg-gray-600 object-cover cursor-pointer">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity rounded-full">Trocar</div>
                </div>            <div class="w-full">
                <label for="user-settings-name" class="block text-sm font-medium text-gray-400">Nome de Usu√°rio</label>
                <input type="text" id="user-settings-name" class="mt-1 w-full border border-gray-600 rounded-md px-3 py-2 bg-gray-700" />
            </div>
        </div>
        <div class="pt-4 border-t border-gray-700 space-y-2">
                <button id="logout-btn" class="w-full flex items-center justify-center space-x-2 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                    <span>Sair</span>
                </button>
            </div>
        </div>
    </div>

    <div id="room-settings-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 text-white rounded-lg shadow-xl p-6 w-full max-w-lg space-y-6 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold">Configura√ß√µes da Sala</h3><button id="close-room-settings-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div class="flex items-center space-x-4">
                <div class="relative group flex-shrink-0 w-16 h-16">
                    <img id="room-settings-pic" class="w-full h-full rounded-full bg-gray-600 object-cover cursor-pointer">
                    <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center text-white text-xs font-bold opacity-0 group-hover:opacity-100 transition-opacity rounded-full">Trocar</div>
                </div>
                <div class="w-full">
                    <label for="room-settings-name" class="block text-sm font-medium text-gray-400">Nome da Sala</label>
                    <input type="text" id="room-settings-name" class="mt-1 w-full border border-gray-600 rounded-md px-3 py-2 bg-gray-700" />
                </div>
            </div>
            <div class="pt-4 border-t border-gray-700">
                <h4 class="text-lg font-semibold">Membros</h4>
                <div id="room-members-list" class="mt-2 max-h-48 overflow-y-auto space-y-2"></div>
            </div>
            <div id="add-member-section" class="hidden pt-4 border-t border-gray-700">
                 <button id="add-member-btn" class="w-full text-left px-4 py-2 bg-blue-800 text-blue-200 rounded-md hover:bg-blue-700">Adicionar Membro</button>
            </div>
            <div class="pt-4 border-t border-gray-700">
                <button id="clear-chat-btn" class="w-full text-left px-4 py-2 bg-red-900/50 text-red-300 rounded-md hover:bg-red-900/70">Limpar Hist√≥rico de Mensagens</button>
            </div>
        </div>
    </div>
    
    <div id="add-member-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Adicionar Amigo ao Grupo</h3><button id="close-add-member-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div id="add-member-list" class="max-h-60 overflow-y-auto"></div>
        </div>
    </div>

    <div id="create-room-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm space-y-4 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Criar Nova Sala</h3><button id="close-create-modal-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <form id="create-room-form">
                <div><label for="room-name-input" class="block text-sm font-medium text-gray-400">Nome da Sala</label><input type="text" id="room-name-input" required class="mt-1 w-full border border-gray-600 bg-gray-700 rounded-md px-3 py-2" /></div>
                <div><label for="room-password-input" class="block text-sm font-medium text-gray-400">Senha (Opcional)</label><input type="password" id="room-password-input" placeholder="Deixe em branco para sala p√∫blica" class="mt-1 w-full border border-gray-600 bg-gray-700 rounded-md px-3 py-2" /></div>
                <div class="flex justify-end space-x-3 pt-2"><button type="button" id="cancel-create-room-btn" class="px-4 py-2 bg-gray-600 rounded-md hover:bg-gray-500">Cancelar</button><button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Criar</button></div>
            </form>
        </div>
    </div>
    
    <div id="user-search-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Encontrar Usu√°rios</h3><button id="close-user-search-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div class="relative">
                <input type="search" id="user-search-input" placeholder="Digite o nome de usu√°rio..." class="w-full border border-gray-600 bg-gray-700 rounded-md px-3 py-2 pl-10 text-white">
                <svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
            </div>
            <div id="user-search-results" class="max-h-60 overflow-y-auto"></div>
        </div>
    </div>
    
    <div id="friend-requests-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-md space-y-4 border border-gray-700">
            <div class="flex justify-between items-center"><h3 class="text-2xl font-bold text-white">Pedidos de Amizade</h3><button id="close-friend-requests-btn" class="text-gray-500 hover:text-gray-300 text-2xl">&times;</button></div>
            <div id="friend-requests-list" class="max-h-60 overflow-y-auto"></div>
        </div>
    </div>    <!-- Modal de Configura√ß√µes da Conversa -->
    <div id="conversation-settings-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[55] p-4">
        <div class="modal-content bg-gradient-to-br from-gray-800 to-gray-900 text-white rounded-2xl shadow-2xl p-0 w-full max-w-md border border-gray-600 overflow-hidden">
            <!-- Header do Modal -->
            <div class="bg-gradient-to-r from-blue-600 to-purple-600 p-6 relative">
                <button id="close-conversation-settings-btn" class="absolute top-4 right-4 text-white/80 hover:text-white text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-white/10 transition-all duration-200">&times;</button>
                <h3 class="text-2xl font-bold text-white">Configura√ß√µes</h3>
                <p class="text-blue-100 text-sm mt-1">Personalize sua conversa</p>
            </div>
            
            <!-- Informa√ß√µes do Chat -->
            <div class="p-6 bg-gray-800/50 border-b border-gray-700">
                <div class="flex items-center space-x-4">
                    <div class="relative">
                        <div class="w-16 h-16 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 p-0.5">
                            <div class="w-full h-full rounded-full overflow-hidden bg-gray-800">
                                <img id="conversation-settings-pic" class="w-full h-full object-cover">
                            </div>
                        </div>
                        <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-green-500 rounded-full border-2 border-gray-800"></div>
                    </div>                    <div class="flex-1 min-w-0">
                        <h4 id="conversation-settings-name" class="text-lg font-semibold text-white truncate"></h4>
                        <p id="conversation-settings-type" class="text-sm text-gray-400"></p>
                        <div id="user-status-indicator" class="flex items-center space-x-2 mt-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                            <span class="text-xs text-green-400">Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Op√ß√µes da Conversa -->
            <div class="p-6 space-y-4">
                <!-- Notifica√ß√µes -->
                <div class="flex items-center justify-between p-4 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700/70 transition-all duration-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                        </div>
                        <div>
                            <span class="font-medium text-white">Notifica√ß√µes</span>
                            <p class="text-xs text-gray-400">Receber alertas desta conversa</p>
                        </div>
                    </div>                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="conversation-notifications-toggle" class="sr-only peer">
                        <div class="w-12 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-1/2 after:left-1.5 after:-translate-y-1/2 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>

                <!-- Sons -->
                <div class="flex items-center justify-between p-4 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700/70 transition-all duration-200">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.464 8.464a5 5 0 000 7.072"></path>
                            </svg>
                        </div>
                        <div>
                            <span class="font-medium text-white">Sons</span>
                            <p class="text-xs text-gray-400">Tocar sons de notifica√ß√£o</p>
                        </div>
                    </div>                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="conversation-sounds-toggle" class="sr-only peer" checked>
                        <div class="w-12 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-1/2 after:left-1.5 after:-translate-y-1/2 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    </label>
                </div>

                <!-- Arquivos de M√≠dia -->
                <button class="w-full flex items-center justify-between p-4 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700/70 hover:border-blue-500/50 transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-pink-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div class="text-left">
                            <span class="font-medium text-white">Arquivos de M√≠dia</span>
                            <p class="text-xs text-gray-400">Fotos, v√≠deos e documentos</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>

                <!-- Buscar Mensagens -->
                <button class="w-full flex items-center justify-between p-4 bg-gray-700/50 rounded-xl border border-gray-600/50 hover:bg-gray-700/70 hover:border-blue-500/50 transition-all duration-200 group">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <div class="text-left">
                            <span class="font-medium text-white">Buscar Mensagens</span>
                            <p class="text-xs text-gray-400">Encontrar mensagens espec√≠ficas</p>
                        </div>
                    </div>
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </button>
            </div>            <!-- A√ß√µes da Conversa -->
            <div class="p-6 pt-0 space-y-3 border-t border-gray-700/50">
                <button id="clear-chat-btn" class="w-full flex items-center justify-center space-x-3 py-3 px-4 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-xl font-medium hover:from-yellow-600 hover:to-orange-600 transition-all duration-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1H7a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    <span>Limpar Conversa</span>
                </button>
                
                <button id="block-user-btn" class="w-full flex items-center justify-center space-x-3 py-3 px-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl font-medium hover:from-red-600 hover:to-red-700 transition-all duration-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728L5.636 5.636m12.728 12.728L18.364 5.636M5.636 18.364L18.364 5.636"></path>
                    </svg>
                    <span>Bloquear Usu√°rio</span>
                </button>
            </div>
        </div>
    </div>

<script type="module">
    // --- IMPORTA√á√ïES ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, orderBy, addDoc, serverTimestamp, where, updateDoc, arrayUnion, writeBatch, getDocs, arrayRemove, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    import { getDatabase, ref as rtdbRef, onValue, set, onDisconnect, serverTimestamp as rtdbServerTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-messaging.js";

    // --- CONFIGURA√á√ÉO DO FIREBASE ---
    const firebaseConfig = {
      apiKey: "AIzaSyCyidXzqqe-rrcF0QrBQ2iSIR_mf0tpMd0",
      authDomain: "seu-projeto-chat.firebaseapp.com",
      projectId: "seu-projeto-chat",
      storageBucket: "seu-projeto-chat.firebasestorage.app",
      messagingSenderId: "259194791953",
      appId: "1:259194791953:web:587ea979f1f26aff2629b0"
    };

    // --- VARI√ÅVEIS GLOBAIS ---
    let app, auth, db, rtdb, storage, messaging;
    const ui = {};    const state = { 
        currentUserId: null, 
        currentUserData: null, 
        currentRoomData: null,
        roomsData: [],
        friendsData: new Map(),
        usersStatus: {}, 
        readReceiptObserver: null,
        imageUploadContext: null,
        unsubscribeRoom: null, 
        unsubscribeMessages: null, 
        unsubscribeUserRooms: null,
        unsubscribeUserData: null,
        unsubscribePresence: null,
        unsubscribeSearchListener: null,
        typingTimeout: null,
        isRecording: false,
        mediaRecorder: null,
        audioChunks: [],        recordingStartTime: 0,
        recordingTimerInterval: null,
        notificationCheckInterval: null,        isEditingFriends: false, // <-- ADICIONE ESTA LINHA
        selectedFriendsForDeletion: [], // <-- E ESTA LINHA
        userSearchResults: [] // <-- ADICIONE ESTA LINHA
    };// --- L√ìGICA DE INICIALIZA√á√ÉO ---
    function main() {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        rtdb = getDatabase(app);

        try {
            messaging = getMessaging(app);
        } catch (err) {
            console.warn("Firebase Messaging n√£o √© suportado neste ambiente.", err.message);
            messaging = null;
        }

        bindGlobalUI();
        onAuthStateChanged(auth, handleAuthChange);
        
        // Monitorar mudan√ßas no bot√£o din√¢mico
        setTimeout(() => {
            const dynamicBtn = document.getElementById('dynamic-action-btn');
            if (dynamicBtn) {
                console.log('üîç [MONITOR] Iniciando monitoramento do bot√£o din√¢mico');
                  // Usar MutationObserver para detectar mudan√ßas nas classes
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            const newClasses = dynamicBtn.className;
                            console.log('üîç [MONITOR] Classes do bot√£o alteradas para:', newClasses);
                            
                            // Detectar se ficou vermelho quando n√£o deveria
                            if ((newClasses.includes('red') || newClasses.includes('pulse')) && !state.isRecording) {                                console.log('‚ö†Ô∏è [MONITOR] ALERTA: Bot√£o ficou vermelho sem estar gravando!');                                console.log('‚ö†Ô∏è [MONITOR] state.isRecording:', state.isRecording);
                                console.log('‚ö†Ô∏è [MONITOR] Aplicando corre√ß√£o imediata');
                                
                                // Corre√ß√£o imediata sem usar toggleButtonState
                                setTimeout(() => {
                                    const chatInput = document.querySelector('.chat-input');
                                    const dynamicBtn = document.querySelector('#dynamic-action-btn');
                                    const micIcon = document.querySelector('#mic-icon');
                                    const sendIcon = document.querySelector('#send-icon');
                                    
                                    if (chatInput && chatInput.value.trim() === '' && dynamicBtn && micIcon && sendIcon) {
                                        console.log('‚ö†Ô∏è [MONITOR] Corrigindo bot√£o vermelho');
                                        state.isRecording = false;
                                        micIcon.classList.remove('hidden');
                                        sendIcon.classList.add('hidden');
                                        dynamicBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                                        dynamicBtn.removeAttribute('style');
                                    }
                                }, 10);
                            }
                        }
                    });
                });
                
                observer.observe(dynamicBtn, {
                    attributes: true,
                    attributeFilter: ['class']
                });
            }
        }, 2000);
    }
    
    function getRoomDisplayName(room, currentUserId) {
        if (!room) return 'Carregando...';
        if (room.isDirectMessage) {
            const otherUserId = room.members.find(id => id !== currentUserId);
            return room.memberDetails?.[otherUserId] || 'Conversa Privada';
        }
        return room.name;
    }

    async function handleAuthChange(user) {
        const params = new URLSearchParams(window.location.search);
        const roomIdFromUrl = params.get('room');        const cleanupListeners = () => {
            if (state.unsubscribeUserRooms) state.unsubscribeUserRooms();
            if (state.unsubscribeUserData) state.unsubscribeUserData();
            if (state.unsubscribeRoom) state.unsubscribeRoom();
            if (state.unsubscribeMessages) state.unsubscribeMessages();
            if (state.unsubscribeSearchListener) state.unsubscribeSearchListener();
            if (state.unsubscribePresence) state.unsubscribePresence();
            if (state.readReceiptObserver) state.readReceiptObserver.disconnect();
            if (state.notificationCheckInterval) clearInterval(state.notificationCheckInterval);
        };if (user) {
            state.currentUserId = user.uid;
            
            let userSnap = await getDoc(doc(db, 'users', user.uid));
            if (!userSnap.exists()) {
                try {
                    await createUserProfile(user);
                } catch (e) { 
                    console.error("Failed to create user profile:", e);
                    await signOut(auth);
                    return;
                } 
            }
            
            if (roomIdFromUrl && user.isAnonymous) {
                const roomSnap = await getDoc(doc(db, 'rooms', roomIdFromUrl));
                if (!roomSnap.exists()) {
                    showNotification("A sala para a qual voc√™ foi convidado n√£o existe mais.", "error");
                    await signOut(auth); return;
                }
                await setupGuestUI(roomIdFromUrl);
            } else {
                // Para usu√°rios n√£o convidados, verificar notifica√ß√µes obrigat√≥rias
                if (!user.isAnonymous) {
                    const notificationsAllowed = enforceNotifications();
                    if (!notificationsAllowed) {
                        return; // Interrompe o setup at√© que as notifica√ß√µes sejam ativadas
                    }
                }
                
                await setupMainUI(roomIdFromUrl);
            }

            if(!user.isAnonymous) {
                setupPresenceSystem(); 
                // S√≥ chamar setupPushNotifications se as notifica√ß√µes j√° estiverem permitidas
                if (checkNotificationPermission() === 'granted') {
                    setupPushNotifications();
                }
                // Monitorar mudan√ßas no status das notifica√ß√µes
                monitorNotificationStatus();
            }

        } else {
            cleanupListeners();
            Object.assign(state, { currentUserData: null, currentUserId: null, roomsData: [], usersStatus: {}, friendsData: new Map() });
            
            ['guest-container', 'app-container'].forEach(id => document.getElementById(id).classList.add('hidden'));
            const loginScreen = document.getElementById('login-screen');
            const inviteCard = document.getElementById('invite-welcome-card');
            
            if (roomIdFromUrl) {
                inviteCard.classList.remove('hidden');
                document.getElementById('enter-as-guest-btn').onclick = () => signInAnonymously(auth);
            } else {
                inviteCard.classList.add('hidden');
            }
            document.getElementById('main-guest-login-btn').onclick = () => signInAnonymously(auth);
            loginScreen.classList.remove('hidden');
            loginScreen.classList.add('flex');
            document.getElementById('login-form').onsubmit = handleLogin;
        }
    }
    
    async function createUserProfile(user) {
        const baseProfile = { uid: user.uid, friends: [], friendRequests: [], fcmTokens: [] };

        if (user.isAnonymous) {
            const guestName = await showCustomPrompt("Bem-vindo(a)!", "Para entrar, por favor, digite seu nome de convidado.");
            if (!guestName) { await signOut(auth); throw new Error("Guest name not provided."); }
            Object.assign(baseProfile, {
                username: `Convidado: ${guestName.trim()}`,
                guest_name_lowercase: guestName.trim().toLowerCase(),
                isGuest: true,
                photoURL: `https://ui-avatars.com/api/?name=${encodeURIComponent(guestName.trim()[0])}&background=random&color=fff`
            });
        } else {
            const username = user.email.split('@')[0];
            Object.assign(baseProfile, {
                username, username_lowercase: username.toLowerCase(), email: user.email, isGuest: false,
                photoURL: `https://i.pravatar.cc/150?u=${user.uid}`
            });
        }
        await setDoc(doc(db, 'users', user.uid), baseProfile);
    }
    
    async function setupGuestUI(roomId) {
        try {
            await updateDoc(doc(db, 'rooms', roomId), { members: arrayUnion(state.currentUserId) });
        } catch(e) { console.warn("Could not add guest to room members, maybe already there.", e); }
        document.getElementById('guest-container').classList.remove('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.add('hidden');
        await openRoom(roomId, true);
        history.replaceState(null, '', window.location.pathname);
    }

    async function setupMainUI(roomIdFromUrl) {
        document.getElementById('guest-container').classList.add('hidden');
        document.getElementById('login-screen').classList.add('hidden');
        document.getElementById('app-container').classList.remove('hidden');
        initMainLayout();
        bindMainUI();
        setupDataListeners(); 
        if (roomIdFromUrl) {
            await openRoom(roomIdFromUrl);
            history.replaceState(null, '', window.location.pathname);
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        try {
            await signInWithEmailAndPassword(auth, document.getElementById('email-input').value, document.getElementById('password-input').value);
        } catch (err) { showNotification("Falha no login: " + err.message, "error"); }
    }

    function initMainLayout() {
        document.getElementById('app-container').innerHTML = `
        <div id="sidebar" class="w-full md:w-1/3 h-full transition-transform duration-300 ease-in-out transform md:translate-x-0 relative flex flex-col">            <header class="relative p-4 flex justify-between items-center header-blur border-b border-gray-800/50 flex-shrink-0 backdrop-blur-xl bg-gradient-to-r from-gray-900/90 via-gray-800/90 to-gray-900/90">
                <!-- Efeito de gradiente sutil no fundo -->
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600/3 via-purple-600/3 to-indigo-600/3"></div>
                
                <!-- Bot√µes de a√ß√£o √† esquerda -->
                <div class="flex items-center space-x-1 relative z-10">
                     <button id="friend-requests-btn" title="Pedidos de Amizade" class="group relative p-3 rounded-xl hover:bg-gradient-to-r hover:from-blue-600/20 hover:to-indigo-600/20 transition-all duration-300 hover:scale-110">
                         <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                         </svg>
                         <span id="friend-requests-badge" class="absolute -top-1 -right-1 w-5 h-5 bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs rounded-full flex items-center justify-center font-bold shadow-lg hidden"></span>
                         <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-500/10 to-indigo-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                     </button>
                     <button id="user-search-btn" title="Buscar Usu√°rio" class="group relative p-3 rounded-xl hover:bg-gradient-to-r hover:from-emerald-600/20 hover:to-green-600/20 transition-all duration-300 hover:scale-110">
                         <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                             <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                         </svg>
                         <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-emerald-500/10 to-green-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                     </button>
                    <button id="user-settings-btn" title="Configura√ß√µes" class="group relative p-3 rounded-xl hover:bg-gradient-to-r hover:from-purple-600/20 hover:to-pink-600/20 transition-all duration-300 hover:scale-110">
                        <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-purple-500/10 to-pink-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    </button>
                </div>
                
                <!-- Nome do usu√°rio no centro -->
                <div class="flex-1 flex justify-center min-w-0 mx-4 relative z-10">
                    <span id="my-username" class="font-bold text-lg truncate text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500 text-center hover:from-blue-400 hover:to-cyan-400 transition-all duration-300 cursor-pointer"></span>
                </div>
                
                <!-- Foto do perfil -->
                <div class="relative z-10">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-600/20 p-0.5 hover:scale-105 transition-transform duration-300 cursor-pointer">
                        <div class="w-full h-full rounded-full overflow-hidden bg-gray-600 ring-2 ring-gray-700/50 hover:ring-blue-500/30 transition-all duration-300">
                            <img id="my-profile-pic" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300">
                        </div>
                    </div>
                </div>
                
                <!-- Linha decorativa -->
                <div class="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-blue-500/30 to-transparent"></div>
            </header>
            <div id="room-list-container" class="overflow-y-auto flex-1 pb-20"></div>            <button id="create-room-btn" class="group absolute bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-blue-500 via-blue-600 to-cyan-500 text-white rounded-full flex items-center justify-center shadow-2xl hover:shadow-blue-500/25 transition-all duration-300 hover:scale-110 hover:rotate-90 border-2 border-blue-400/20">
                <!-- Efeito de brilho -->
                <div class="absolute inset-0 rounded-full bg-gradient-to-r from-blue-400/20 to-cyan-400/20 opacity-0 group-hover:opacity-100 transition-opacity duration-300 animate-pulse"></div>
                
                <!-- √çcone -->
                <svg class="w-8 h-8 relative z-10 group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                
                <!-- Borda animada -->
                <div class="absolute inset-0 rounded-full border-2 border-transparent bg-gradient-to-r from-blue-400 via-cyan-400 to-blue-400 opacity-0 group-hover:opacity-50 group-hover:animate-spin transition-opacity duration-300" style="animation-duration: 3s;"></div>
            </button>
        </div>
        <div id="chat-panel" class="w-full md:flex-grow absolute md:static inset-0 flex flex-col bg-black transition-transform duration-300 ease-in-out transform translate-x-full md:translate-x-0">
            <div class="h-full flex items-center justify-center text-center p-4"><p class="text-gray-500">Selecione uma sala ou inicie uma nova conversa.</p></div>
        </div>`;
    }    function bindGlobalUI() {
        document.getElementById('close-user-settings-btn').onclick = () => document.getElementById('user-settings-modal').classList.add('hidden');
        document.getElementById('close-room-settings-btn').onclick = () => document.getElementById('room-settings-modal').classList.add('hidden');
        document.getElementById('close-add-member-btn').onclick = () => document.getElementById('add-member-modal').classList.add('hidden');
        document.getElementById('close-create-modal-btn').onclick = () => document.getElementById('create-room-modal').classList.add('hidden');
        document.getElementById('close-image-viewer-btn').onclick = () => document.getElementById('image-viewer-modal').classList.add('hidden');
        document.getElementById('close-share-link-btn').onclick = () => document.getElementById('share-link-modal').classList.add('hidden');
        document.getElementById('close-friend-requests-btn').onclick = () => document.getElementById('friend-requests-modal').classList.add('hidden');
        document.getElementById('close-user-search-btn').onclick = () => {
             if (state.unsubscribeSearchListener) state.unsubscribeSearchListener();
             document.getElementById('user-search-modal').classList.add('hidden');
        };
        document.getElementById('close-conversation-settings-btn').onclick = () => document.getElementById('conversation-settings-modal').classList.add('hidden');
        document.getElementById('create-room-form').onsubmit = handleCreateRoomSubmit;
        document.getElementById('image-uploader').onchange = handleMediaUpload;
        document.getElementById('media-uploader').onchange = handleMediaUpload;
        window.addEventListener('click', () => document.getElementById('room-context-menu').classList.add('hidden'));
        
        // Event listeners para o modal de configura√ß√µes da conversa
        const conversationModal = document.getElementById('conversation-settings-modal');
        conversationModal.onclick = (e) => {
            if (e.target === conversationModal) {
                conversationModal.classList.add('hidden');
            }
        };
    }    function bindMainUI() {
        Object.assign(ui, {
            myProfilePic: document.getElementById('my-profile-pic'),
            myUsername: document.getElementById('my-username'),
            userSettingsBtn: document.getElementById('user-settings-btn'),
            userSearchBtn: document.getElementById('user-search-btn'),
            createRoomBtn: document.getElementById('create-room-btn'),
            roomListContainer: document.getElementById('room-list-container'),
            friendRequestsBtn: document.getElementById('friend-requests-btn'),
            friendRequestsBadge: document.getElementById('friend-requests-badge')
        });
        ui.myProfilePic.parentElement.onclick = () => { if(state.currentUserData?.photoURL) openImageViewer(state.currentUserData.photoURL, { isUser: true }); };
        ui.userSettingsBtn.onclick = openUserSettings;
        ui.userSearchBtn.onclick = openUserSearch;
        ui.createRoomBtn.onclick = () => document.getElementById('create-room-modal').classList.remove('hidden');
        ui.friendRequestsBtn.onclick = openFriendRequestsModal;

        // --- L√≥gica de Navega√ß√£o Principal ---
        const navFriends = document.getElementById('nav-friends');
        const navRooms = document.getElementById('nav-rooms');
        const appContainer = document.getElementById('app-container');
        const friendsScreen = document.getElementById('friends-screen');

        if (navFriends) {
            navFriends.addEventListener('click', (e) => {
                e.preventDefault();
                friendsScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                updateNav(navFriends);
                renderFriendsScreen(); 
            });
        }        if (navRooms) {
            navRooms.addEventListener('click', (e) => {
                e.preventDefault();
                appContainer.classList.remove('hidden');
                friendsScreen.classList.add('hidden');
                updateNav(navRooms);
            });        }

        // --- L√ìGICA DA TELA DE AMIGOS ---
        const editFriendsBtn = document.getElementById('edit-friends-btn');
        const doneEditingBtn = document.getElementById('done-editing-btn');
        const friendSearchInput = document.getElementById('friend-search-input');
        const friendsListContainer = document.getElementById('friends-list-container');
        const deleteSelectedBtn = document.getElementById('delete-selected-btn');

        if (editFriendsBtn) { editFriendsBtn.onclick = () => { state.isEditingFriends = true; state.selectedFriendsForDeletion = []; renderFriendsScreen(); }; }
        if (doneEditingBtn) { doneEditingBtn.onclick = () => { state.isEditingFriends = false; state.selectedFriendsForDeletion = []; renderFriendsScreen(); }; }
        
        // CORRE√á√ÉO: A busca agora chama a fun√ß√£o de busca no DB
        if (friendSearchInput) { friendSearchInput.oninput = handleFriendSearch; }

        if (friendsListContainer) {
            friendsListContainer.onclick = async (e) => {
                // L√≥gica para o bot√£o "Adicionar"
                if (e.target.classList.contains('add-friend-btn')) {
                    const targetUid = e.target.dataset.uid;
                    e.target.disabled = true;
                    e.target.textContent = 'Enviado';
                    await sendFriendRequest(targetUid);
                    return;
                }

                const friendItem = e.target.closest('.friend-item');
                if (!friendItem) return;
                const friendId = friendItem.dataset.friendId;

                if (state.isEditingFriends) {
                    if (state.selectedFriendsForDeletion.includes(friendId)) {
                        state.selectedFriendsForDeletion = state.selectedFriendsForDeletion.filter(id => id !== friendId);
                    } else {
                        state.selectedFriendsForDeletion.push(friendId);
                    }
                    renderFriendsScreen();
                } else {
                    showNotification(`Abrindo conversa...`, "info");
                    const friendData = state.friendsData.get(friendId);
                    if (friendData) {
                        await createOrGetDirectMessageRoom(friendId, friendData.username, friendData.photoURL);
                        document.getElementById('nav-rooms').click();
                    }
                }
            };
        }
        
        if (deleteSelectedBtn) {
            deleteSelectedBtn.onclick = async () => {
                if (state.selectedFriendsForDeletion.length === 0) return;

                const confirmed = await showCustomConfirm(
                    "Confirmar Exclus√£o",
                    `Voc√™ tem certeza que deseja remover ${state.selectedFriendsForDeletion.length} amigo(s)? Esta a√ß√£o n√£o pode ser desfeita.`
                );

                if (confirmed) {
                    const batch = writeBatch(db);
                    const currentUserRef = doc(db, 'users', state.currentUserId);

                    batch.update(currentUserRef, {
                        friends: arrayRemove(...state.selectedFriendsForDeletion)
                    });

                    state.selectedFriendsForDeletion.forEach(friendId => {
                        const friendRef = doc(db, 'users', friendId);
                        batch.update(friendRef, {
                            friends: arrayRemove(state.currentUserId)
                        });
                    });

                    try {
                        await batch.commit();
                        showNotification("Amigo(s) removido(s) com sucesso!", "success");
                        state.isEditingFriends = false;
                        state.selectedFriendsForDeletion = [];
                    } catch (error) {
                        console.error("Erro ao remover amigos:", error);
                        showNotification("Ocorreu um erro ao remover os amigos.", "error");
                    }
                }
            };
        }
    }
    
    function setupDataListeners() {
        if (!state.currentUserId) return;
        cleanupOldListeners();

        state.unsubscribeUserData = onSnapshot(doc(db, 'users', state.currentUserId), (docSnap) => {
            if (docSnap.exists()) {
                const oldData = state.currentUserData;
                state.currentUserData = { uid: docSnap.id, ...docSnap.data() };
                if (JSON.stringify(oldData?.friends) !== JSON.stringify(state.currentUserData.friends)) {
                    fetchFriendsData(); 
                }
                renderApp();
            } else {
                console.error("User document not found, signing out.");
                signOut(auth);
            }
        });

        const roomsQuery = query(collection(db, 'rooms'), where("members", "array-contains", state.currentUserId));
        state.unsubscribeUserRooms = onSnapshot(roomsQuery, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "modified") {
                    const changedRoomData = { id: change.doc.id, ...change.doc.data() };
                    const lastMessage = changedRoomData.lastMessage;

                    if (lastMessage && lastMessage.senderId !== state.currentUserId) {
                        const chatPanel = document.getElementById('chat-panel');
                        const guestContainer = document.getElementById('guest-container');
                        const isChatOpen = (chatPanel?.dataset.currentRoomId === changedRoomData.id) || (guestContainer?.dataset.currentRoomId === changedRoomData.id);

                        if (!isChatOpen) {
                            if (navigator.vibrate) {
                                navigator.vibrate([100, 50, 100]);
                            }
                            if (changedRoomData.isDirectMessage && !state.currentUserData.isGuest) {
                                const otherUserId = changedRoomData.members.find(id => id !== state.currentUserId);
                                const otherUserDetails = changedRoomData.memberDetails || {};
                                const otherUserPhoto = changedRoomData.memberPhotos || {};
                                createOrGetDirectMessageRoom(otherUserId, otherUserDetails[otherUserId], otherUserPhoto[otherUserId]);
                            }
                        }
                    }
                }
            });

            state.roomsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderApp();
        });

        const statusRef = rtdbRef(rtdb, 'status');
        state.unsubscribePresence = onValue(statusRef, (snapshot) => {
            state.usersStatus = snapshot.val() || {};
            renderApp();
        });
    }
    
    async function fetchFriendsData() {
        const { friends = [] } = state.currentUserData || {};
        if (friends.length === 0) {
            state.friendsData.clear();
            renderApp();
            return;
        }
        const friendsQuery = query(collection(db, 'users'), where('uid', 'in', friends));
        const friendsSnapshots = await getDocs(friendsQuery);
        state.friendsData.clear();
        friendsSnapshots.forEach(doc => {
            state.friendsData.set(doc.id, doc.data());
        });
        renderApp();
    }

    function cleanupOldListeners() {
        if (state.unsubscribeUserData) state.unsubscribeUserData();
        if (state.unsubscribeUserRooms) state.unsubscribeUserRooms();
        if (state.unsubscribePresence) state.unsubscribePresence();
    }    function renderApp() {
        if (!state.currentUserData || !document.getElementById('sidebar')) return;
        renderSidebarHeader();
        renderSidebarLists();
        renderFriendsScreen(); // <-- ADICIONE ESTA LINHA

        const createRoomBtn = document.getElementById('create-room-btn');
        if (createRoomBtn) {
            createRoomBtn.style.display = state.currentUserData.isGuest ? 'none' : 'flex';
        }    }    function renderFriendsScreen() {
        const friendsListContainer = document.getElementById('friends-list-container');
        const searchInput = document.getElementById('friend-search-input');
        const searchTerm = searchInput.value.trim();

        // L√≥gica de Edi√ß√£o (igual a antes, mas garantindo a visibilidade)
        const editBtn = document.getElementById('edit-friends-btn');
        const doneBtn = document.getElementById('done-editing-btn');
        const deleteBar = document.getElementById('delete-actions-bar');
        const deleteBtn = document.getElementById('delete-selected-btn');
        
        editBtn.classList.toggle('hidden', state.isEditingFriends);
        doneBtn.classList.toggle('hidden', !state.isEditingFriends);
        deleteBar.classList.toggle('hidden', !state.isEditingFriends);
        if (state.isEditingFriends) {
            const selectionCount = state.selectedFriendsForDeletion.length;
            deleteBtn.disabled = selectionCount === 0;
            deleteBtn.textContent = selectionCount > 0 ? `Excluir (${selectionCount})` : 'Excluir Selecionados';
        }

        friendsListContainer.innerHTML = ''; // Limpa a tela

        // DECIS√ÉO: Mostrar resultados da busca OU lista de amigos?
        if (searchTerm && state.userSearchResults.length > 0) {
            // --- RENDERIZA OS RESULTADOS DA BUSCA GLOBAL ---
            state.userSearchResults.forEach(user => {
                if (user.id === state.currentUserId) return; // N√£o mostra voc√™ mesmo

                const isFriend = state.currentUserData.friends.includes(user.id);
                // Futuramente, voc√™ pode checar se um pedido j√° foi enviado
                // const isPending = state.currentUserData.friendRequests.some(req => req.to === user.id);

                const photo = user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.username[0] || '?')}&background=random&color=fff`;

                let actionButton;
                if (isFriend) {
                    actionButton = '<span class="text-sm text-gray-500">Amigo</span>';
                } else {
                    // if (isPending) { actionButton = '<span class="text-sm text-yellow-500">Pendente</span>'; } 
                    actionButton = `<button class="add-friend-btn bg-blue-600 text-white px-3 py-1 text-sm rounded-lg hover:bg-blue-700" data-uid="${user.id}">Adicionar</button>`;
                }

                const userElementHTML = `
                    <div class="flex items-center bg-gray-800 p-3 rounded-lg">
                        <img src="${photo}" alt="${user.username}" class="w-12 h-12 rounded-full mr-4 object-cover">
                        <div class="flex-grow">
                            <span class="font-bold text-white">${user.username}</span>
                        </div>
                        ${actionButton}
                    </div>
                `;
                friendsListContainer.innerHTML += userElementHTML;
            });
        } else {
            // --- RENDERIZA A LISTA DE AMIGOS NORMAL ---
            const friendsToRender = [...state.friendsData.values()];
            if (friendsToRender.length === 0) {
                friendsListContainer.innerHTML = `<p class="text-center text-gray-400 mt-10">Voc√™ ainda n√£o adicionou nenhum amigo.</p>`;
                return;
            }
            // (O resto da l√≥gica para renderizar amigos normais, com modo de edi√ß√£o)
            friendsToRender.forEach(friend => {
                const isOnline = state.usersStatus[friend.uid]?.state === 'online';
                const isSelected = state.selectedFriendsForDeletion.includes(friend.uid);
                const photo = friend.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(friend.username[0] || '?')}&background=random&color=fff`;

                const friendElementHTML = `
                <div class="friend-item flex items-center bg-gray-800 p-3 rounded-lg shadow hover:bg-gray-700/80 cursor-pointer transition-all duration-200 ${isSelected ? 'ring-2 ring-red-500 bg-gray-700' : ''}" data-friend-id="${friend.uid}">
                    ${state.isEditingFriends ? `<div class="mr-4"><input type="checkbox" class="friend-checkbox pointer-events-none h-5 w-5 bg-gray-700 border-gray-600 rounded text-red-500 focus:ring-red-500" ${isSelected ? 'checked' : ''}></div>` : ''}
                    <div class="relative"><img src="${photo}" alt="${friend.username}" class="w-12 h-12 rounded-full mr-4 object-cover"><span class="absolute bottom-0 right-4 w-3 h-3 rounded-full ${isOnline ? 'bg-green-500' : 'bg-gray-500'} border-2 border-gray-800"></span></div>
                    <div class="flex-grow"><span class="font-bold text-white">${friend.username}</span><p class="text-sm text-gray-400">${isOnline ? 'Online' : 'Offline'}</p></div>
                    ${!state.isEditingFriends ? '<i class="fas fa-comment-alt text-gray-500 group-hover:text-white"></i>' : ''}                </div>`;
                friendsListContainer.innerHTML += friendElementHTML;
            });
        }
    }

    function updateNav(activeButton) {
        const navFriends = document.getElementById('nav-friends');
        const navRooms = document.getElementById('nav-rooms');
        if (!navFriends || !navRooms) return;

        [navFriends, navRooms].forEach(btn => {
            btn.classList.remove('text-indigo-400', 'border-t-2', 'border-indigo-500');
            btn.classList.add('text-gray-400');
        });
        activeButton.classList.add('text-indigo-400', 'border-t-2', 'border-indigo-500');
        activeButton.classList.remove('text-gray-400');
    }

    async function handleFriendSearch() {
        const searchInput = document.getElementById('friend-search-input');
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
            state.userSearchResults = []; // Limpa os resultados se a busca estiver vazia
            renderFriendsScreen();
            return;
        }

        try {
            // Busca por usu√°rios cujo nome min√∫sculo come√ßa com o termo de busca
            const usersRef = collection(db, 'users');
            const q = query(usersRef, 
                where('username_lowercase', '>=', searchTerm),
                where('username_lowercase', '<=', searchTerm + '\uf8ff')
            );
            
            const querySnapshot = await getDocs(q);
            state.userSearchResults = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderFriendsScreen(); // Re-renderiza a tela com os resultados da busca
        } catch (error) {
            console.error("Erro ao buscar usu√°rios:", error);
            showNotification("N√£o foi poss√≠vel realizar a busca.", "error");
        }
    }

    function renderSidebarHeader() {
        if (!ui.myUsername || !ui.myProfilePic || !state.currentUserData) return;
        ui.myUsername.textContent = state.currentUserData.username;
        ui.myProfilePic.src = state.currentUserData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(state.currentUserData.username[0] || '?')}&background=random&color=fff`;
        if(ui.friendRequestsBadge) {
            const requestsCount = state.currentUserData.friendRequests?.length || 0;
            ui.friendRequestsBadge.textContent = requestsCount;
            ui.friendRequestsBadge.classList.toggle('hidden', requestsCount === 0);
        }
    }

    function renderSidebarLists() {
        const container = document.getElementById('room-list-container');
        if (!container || !state.currentUserData) return;
        const { friends = [], pinnedRooms = [], archivedRooms = [] } = state.currentUserData;
        const { roomsData = [] } = state;
        let friendsHtml = `<div class="px-4 pt-6 pb-2">
            <h4 class="text-sm font-bold text-transparent bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text uppercase tracking-wider">
                üë• Amigos
            </h4>
        </div>`;
        if (friends.length > 0 && state.friendsData.size > 0) {            friendsHtml += [...state.friendsData.values()].map(friend => {
                const photo = friend.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(friend.username[0] || '?')}&background=A78BFA&color=fff&size=40`;
                const isOnline = state.usersStatus[friend.uid]?.state === 'online';
                const statusIndicator = `<div class="absolute -bottom-0.5 -right-0.5 w-4 h-4 ${isOnline ? 'bg-green-500 animate-pulse' : 'bg-gray-400'} rounded-full border-2 border-gray-900 shadow-lg"></div>`;
                const nameHtml = `<span class="font-semibold truncate flex-1 text-gray-200 group-hover:text-white transition-colors duration-300">${friend.username}</span>`;
                return `<div class="group relative p-3 mx-2 mt-2 rounded-xl flex items-center hover:bg-gradient-to-r hover:from-gray-800/80 hover:to-gray-700/80 cursor-pointer friend-item transition-all duration-300 hover:scale-[1.02] hover:shadow-lg backdrop-blur-sm border border-gray-700/30 hover:border-gray-600/50" data-user-id="${friend.uid}" data-username="${friend.username}" data-user-photo="${photo}">
                    <!-- Efeito de fundo sutil -->
                    <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-600/5 to-purple-600/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    
                    <!-- Foto do amigo -->
                    <div class="relative z-10">
                        <div class="relative w-11 h-11 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-600/20 p-0.5 group-hover:scale-105 transition-transform duration-300">
                            <div class="w-full h-full rounded-full overflow-hidden bg-gray-600 ring-1 ring-gray-600 group-hover:ring-blue-500/30 transition-all duration-300">
                                <img src="${photo}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300" onerror="this.src='https://placehold.co/44x44/cccccc/ffffff?text=?';">
                            </div>
                            ${statusIndicator}
                        </div>
                    </div>
                    
                    <!-- Nome do amigo -->
                    <div class="flex-1 ml-3 min-w-0 relative z-10">
                        ${nameHtml}
                        <div class="text-xs text-gray-400 group-hover:text-gray-300 transition-colors duration-300">
                            ${isOnline ? '‚óè Online' : '‚óã Offline'}
                        </div>
                    </div>
                    
                    <!-- Bot√£o de a√ß√µes -->
                    <button class="relative z-10 p-2 rounded-lg friend-actions-btn text-gray-500 hover:text-white hover:bg-gray-700/50 transition-all duration-300 opacity-0 group-hover:opacity-100" data-user-id="${friend.uid}">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                        </svg>
                    </button>
                </div>`;
            }).join('');
        } else {
            friendsHtml += `<div class="text-center p-6 mx-2 my-4 rounded-xl bg-gradient-to-br from-gray-800/50 to-gray-700/50 border border-gray-600/30 backdrop-blur-sm">
                <div class="text-4xl mb-3">üë§</div>
                <p class="text-gray-400 text-sm leading-relaxed">
                    Encontre usu√°rios na lupa üîç<br>
                    <span class="text-xs text-gray-500">para adicionar como amigos</span>
                </p>
            </div>`;
        }
        const groups = roomsData.filter(r => !r.isDirectMessage);
        let groupsHtml = `<div class="px-4 pt-6 pb-2">
            <h4 class="text-sm font-bold text-transparent bg-gradient-to-r from-green-400 to-emerald-400 bg-clip-text uppercase tracking-wider">
                üè¢ Grupos
            </h4>
        </div>`;
        if (groups.length === 0) {
            groupsHtml += `<div class="text-center p-6 mx-2 my-4 rounded-xl bg-gradient-to-br from-gray-800/50 to-gray-700/50 border border-gray-600/30 backdrop-blur-sm">
                <div class="text-4xl mb-3">‚ûï</div>
                <p class="text-gray-400 text-sm leading-relaxed">
                    Crie um grupo no bot√£o<br>
                    <span class="text-xs text-gray-500">de adicionar acima</span>
                </p>
            </div>`;
        } else {
            const renderItemFunc = (room) => {
                const displayName = getRoomDisplayName(room, state.currentUserId);
                const photo = room.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName[0] || '?')}&background=A78BFA&color=fff&size=40`;
                const nameHtml = `<span class="font-semibold truncate flex-1 text-gray-200">${displayName}</span>`;
                return `<div class="p-3 mx-2 mt-2 rounded-lg flex items-center hover:bg-gray-800 cursor-pointer room-item" data-room-id="${room.id}">
                    <div class="w-10 h-10 rounded-full bg-gray-600 overflow-hidden mr-3 flex-shrink-0"><img src="${photo}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/40x40/cccccc/ffffff?text=?';"></div>
                    ${nameHtml}
                    <button class="p-2 room-actions-btn z-10 text-gray-500 hover:text-white" data-room-id="${room.id}">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path></svg>
                    </button>
                </div>`;
            };
            const archivedItems = groups.filter(r => archivedRooms.includes(r.id)).sort((a, b) => getRoomDisplayName(a, state.currentUserId).localeCompare(getRoomDisplayName(b, state.currentUserId)));
            const pinnedItems = groups.filter(r => pinnedRooms.includes(r.id) && !archivedRooms.includes(r.id)).sort((a, b) => getRoomDisplayName(a, state.currentUserId).localeCompare(getRoomDisplayName(b, state.currentUserId)));
            const normalItems = groups.filter(r => !pinnedRooms.includes(r.id) && !archivedRooms.includes(r.id)).sort((a, b) => getRoomDisplayName(a, state.currentUserId).localeCompare(getRoomDisplayName(b, state.currentUserId)));
            if (pinnedItems.length > 0) groupsHtml += pinnedItems.map(renderItemFunc).join('');
            groupsHtml += normalItems.map(renderItemFunc).join('');
            if (archivedItems.length > 0) {
                groupsHtml += `<details class="px-2"><summary class="px-2 pt-4 text-xs font-bold text-gray-500 uppercase cursor-pointer">Arquivadas</summary>${archivedItems.map(renderItemFunc).join('')}</details>`;
            }
        }
        container.innerHTML = friendsHtml + groupsHtml;
        bindSidebarEvents(container);
    }
    
    function bindSidebarEvents(container) {
        container.querySelectorAll('.friend-item').forEach(el => {
            el.onclick = (e) => { 
                if (e.target.closest('button')) return;
                createOrGetDirectMessageRoom(el.dataset.userId, el.dataset.username, el.dataset.userPhoto);
            }
        });
        container.querySelectorAll('.room-item').forEach(el => {
            el.onclick = (e) => { 
                if (e.target.closest('button')) return;
                openRoom(el.dataset.roomId);
            }
        });
        container.querySelectorAll('.friend-actions-btn, .room-actions-btn').forEach(btn => {
            btn.onclick = (e) => { 
                e.stopPropagation(); 
                handleRoomContextMenu(e, btn.dataset.roomId || `dm_${[state.currentUserId, btn.dataset.userId].sort().join('_')}`); 
            }
        });
    }

    async function handleRoomContextMenu(event, roomId) {
        const roomRef = doc(db, 'rooms', roomId);
        const roomSnap = await getDoc(roomRef);
        if(!roomSnap.exists()) return;
        const roomData = roomSnap.data();
        const menu = document.getElementById('room-context-menu');
        const menuWidth = 160; const menuHeight = 150;
        const screenWidth = window.innerWidth; const screenHeight = window.innerHeight;
        let left = event.clientX; let top = event.clientY;
        if (left + menuWidth > screenWidth) left = screenWidth - menuWidth - 10;
        if (top + menuHeight > screenHeight) top = screenHeight - menuHeight - 10;
        menu.style.top = `${top}px`;
        menu.style.left = `${left}px`;
        menu.classList.remove('hidden');
        const isPinned = state.currentUserData.pinnedRooms?.includes(roomId);
        const isArchived = state.currentUserData.archivedRooms?.includes(roomId);
        const clearChatBtn = document.getElementById('context-clear-chat');
        document.getElementById('context-pin').textContent = isPinned ? 'Desafixar' : 'Fixar';
        document.getElementById('context-archive').textContent = isArchived ? 'Desarquivar' : 'Arquivar';
        clearChatBtn.classList.toggle('hidden', !roomData.isDirectMessage);
        const deleteBtn = document.getElementById('context-delete');
        if (roomData.isDirectMessage) {
            deleteBtn.textContent = 'Remover Amigo';
        } else {
            deleteBtn.textContent = roomData.creatorUid === state.currentUserId ? 'Apagar Sala' : 'Sair da Sala';
        }
        document.getElementById('context-pin').onclick = (e) => { e.stopPropagation(); menu.classList.add('hidden'); togglePinRoom(roomId); };
        document.getElementById('context-archive').onclick = (e) => { e.stopPropagation(); menu.classList.add('hidden'); toggleArchiveRoom(roomId); };
        clearChatBtn.onclick = async (e) => {
            e.stopPropagation(); menu.classList.add('hidden');
            if (await showCustomConfirm('Limpar Conversa', 'Isso apagar√° todas as mensagens desta conversa para todos. Deseja continuar?')) {
                await clearChatForEveryone(roomId);
            }
        };
        deleteBtn.onclick = async (e) => { 
            e.stopPropagation(); menu.classList.add('hidden');
            if (roomData.isDirectMessage) {
                 if (await showCustomConfirm('Remover Amigo', `Isso ir√° desfazer a amizade e apagar a conversa permanentemente. Continuar?`)) {
                     await removeFriendAndDeleteDM(roomId, roomData);
                 }
            } else {
                if (roomData.creatorUid === state.currentUserId) {
                    if (await showCustomConfirm('Apagar Sala', 'Esta a√ß√£o √© permanente e remover√° todos os membros e mensagens. Continuar?')) {
                        await deleteRoom(roomId);
                    }
                } else {
                     if (await showCustomConfirm('Sair da Sala', `Tem certeza que deseja sair de "${getRoomDisplayName(roomData, state.currentUserId)}"?`)) {
                         await updateDoc(doc(db, 'rooms', roomId), { members: arrayRemove(state.currentUserId), admins: arrayRemove(state.currentUserId) });
                         await updateDoc(doc(db, 'users', state.currentUserId), { pinnedRooms: arrayRemove(roomId), archivedRooms: arrayRemove(roomId) });
                     }
                }
            }
        };
    }

    async function removeFriendAndDeleteDM(roomId, roomData) {
        const otherUserId = roomData.members.find(id => id !== state.currentUserId);
        if (!otherUserId) return;
        const batch = writeBatch(db);
        const currentUserRef = doc(db, 'users', state.currentUserId);
        batch.update(currentUserRef, { friends: arrayRemove(otherUserId), pinnedRooms: arrayRemove(roomId), archivedRooms: arrayRemove(roomId) });
        const otherUserRef = doc(db, 'users', otherUserId);
        batch.update(otherUserRef, { friends: arrayRemove(state.currentUserId), pinnedRooms: arrayRemove(roomId), archivedRooms: arrayRemove(roomId) });
        await clearChatForEveryone(roomId);
        const roomRef = doc(db, 'rooms', roomId);
        batch.delete(roomRef);
        await batch.commit();
        showNotification("Amigo removido e conversa apagada.");
        if(document.getElementById('chat-panel')?.dataset.currentRoomId === roomId) {
            document.getElementById('chat-panel').innerHTML = `<div class="h-full flex items-center justify-center text-center p-4"><p class="text-gray-500">Selecione uma sala ou inicie uma nova conversa.</p></div>`;
            delete document.getElementById('chat-panel').dataset.currentRoomId;
        }
    }

    async function togglePinRoom(roomId) {
        const userRef = doc(db, 'users', state.currentUserId);
        const isPinned = state.currentUserData.pinnedRooms?.includes(roomId);
        await updateDoc(userRef, { pinnedRooms: isPinned ? arrayRemove(roomId) : arrayUnion(roomId) });
    }

    async function toggleArchiveRoom(roomId) {
        const userRef = doc(db, 'users', state.currentUserId);
        const isArchived = state.currentUserData.archivedRooms?.includes(roomId);
        await updateDoc(userRef, { archivedRooms: isArchived ? arrayRemove(roomId) : arrayUnion(roomId) });
    }
    
    async function deleteRoom(roomId) {
        showNotification("Apagando sala...");
        await clearChatForEveryone(roomId);
        await deleteDoc(doc(db, 'rooms', roomId));
        showNotification("Sala apagada com sucesso.");
        if(document.getElementById('chat-panel')) document.getElementById('chat-panel').innerHTML = `<div class="h-full flex items-center justify-center text-center p-4"><p class="text-gray-500">Selecione uma sala ou inicie uma nova conversa.</p></div>`;
    }

    async function handleCreateRoomSubmit(e) {
        e.preventDefault();
        const name = document.getElementById('room-name-input').value.trim();
        const password = document.getElementById('room-password-input').value.trim();
        if (!name) return;
        const roomData = { 
            name, password: password || null, isPrivate: !!password, isDirectMessage: false, photoURL: '', creatorUid: state.currentUserId, admins: [state.currentUserId], members: [state.currentUserId], typing: [], createdAt: serverTimestamp() 
        };
        const newRoomRef = await addDoc(collection(db, "rooms"), roomData);
        document.getElementById('create-room-modal').classList.add('hidden');
        document.getElementById('create-room-form').reset();
        openRoom(newRoomRef.id);
    }
    
    async function openRoom(roomId, isGuestView = false) {
        if (state.unsubscribeMessages) state.unsubscribeMessages();
        if (state.unsubscribeRoom) state.unsubscribeRoom();
        if (state.readReceiptObserver) state.readReceiptObserver.disconnect();
        const container = isGuestView ? document.getElementById('guest-container') : document.getElementById('chat-panel');
        if (!isGuestView && document.getElementById('sidebar')) {
            document.getElementById('sidebar').classList.remove('-translate-x-full');
            container.classList.remove('translate-x-full');
        }
        container.innerHTML = `<div class="h-full flex items-center justify-center"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div></div>`;
        const roomRef = doc(db, "rooms", roomId);
        
        try {
            const initialDocSnap = await getDoc(roomRef);
            if (!initialDocSnap.exists() || !initialDocSnap.data().members.includes(state.currentUserId)) {
                container.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-center p-4"><p class="text-gray-500">Esta sala n√£o existe ou voc√™ n√£o tem acesso.</p></div>`;
                if (!isGuestView) { container.innerHTML += `<button onclick="document.getElementById('sidebar').classList.remove('-translate-x-full'); document.getElementById('chat-panel').classList.add('translate-x-full');" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-md">Voltar</button>`; }
                return;
            }
            state.currentRoomData = { id: initialDocSnap.id, ...initialDocSnap.data() };
            renderChatView(container, state.currentRoomData, isGuestView);
            container.dataset.currentRoomId = roomId;
            subscribeToMessages(roomId, container.querySelector('.messages-container'));
            state.unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const oldData = state.currentRoomData;
                    state.currentRoomData = { id: docSnap.id, ...docSnap.data() };
                    if(oldData?.photoURL !== state.currentRoomData.photoURL || oldData?.name !== state.currentRoomData.name) {
                        updateChatView(container, state.currentRoomData);
                    }
                } else {
                    if (state.unsubscribeRoom) state.unsubscribeRoom();
                    if(isGuestView) { signOut(auth); } 
                    else { container.innerHTML = `<div class="h-full flex items-center justify-center text-center p-4"><p class="text-gray-500">Esta sala foi removida.</p></div>`; delete container.dataset.currentRoomId; }
                }
            });
        } catch (error) { container.innerHTML = `<div class="h-full flex items-center justify-center text-center p-4"><p class="text-gray-500">Ocorreu um erro ao abrir a sala.</p></div>`; }
    }
    
    function updateChatView(container, roomData) {
        if (!roomData || !state.currentUserId) return;
        const displayName = getRoomDisplayName(roomData, state.currentUserId);
        const otherUserId = roomData.isDirectMessage ? roomData.members.find(id => id !== state.currentUserId) : null;
        const photo = roomData.isDirectMessage ? 
            (roomData.memberPhotos?.[otherUserId] || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName[0] || '?')}&background=A78BFA&color=fff&size=80`) : 
            (roomData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName[0] || '?')}&background=A78BFA&color=fff&size=80`);
        const headerPic = container.querySelector('#room-header-pic');
        if (headerPic) headerPic.src = photo;
        const headerName = container.querySelector('#room-header-name');
        if (headerName) headerName.textContent = displayName;
        const shareBtn = container.querySelector('#share-room-btn');
        if(shareBtn) shareBtn.style.display = roomData.isDirectMessage ? 'none' : 'block';
        updateTypingIndicator(roomData.typing);
    }

    function renderChatView(container, roomData, isGuestView = false) {
        if (!state.currentUserData) return;
        const displayName = getRoomDisplayName(roomData, state.currentUserId);
        const isAdmin = (roomData.admins || []).includes(state.currentUserId);
        const otherUserId = roomData.isDirectMessage ? roomData.members.find(id => id !== state.currentUserId) : null;
        const photo = roomData.isDirectMessage ? (roomData.memberPhotos?.[otherUserId] || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName[0] || '?')}&background=A78BFA&color=fff&size=40`) : (roomData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName[0] || '?')}&background=A78BFA&color=fff&size=40`);        let headerButtons = !state.currentUserData.isGuest ? `<button id="share-room-btn" title="Convidar" class="group relative p-3 rounded-xl hover:bg-gradient-to-r hover:from-blue-600/20 hover:to-purple-600/20 transition-all duration-300 hover:scale-110" style="display: ${roomData.isDirectMessage ? 'none' : 'block'}">
            <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
            </svg>
            <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-blue-500/10 to-purple-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </button>` : '';
        if (isAdmin && !roomData.isDirectMessage) {
            headerButtons += `<button id="room-settings-btn" title="Configura√ß√µes da Sala" class="group relative p-3 rounded-xl hover:bg-gradient-to-r hover:from-green-600/20 hover:to-emerald-600/20 transition-all duration-300 hover:scale-110">
                <svg class="w-5 h-5 text-gray-400 group-hover:text-green-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-green-500/10 to-emerald-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            </button>`;
        }
        let backButton = isGuestView ? `<button id="guest-settings-btn" title="Configura√ß√µes" class="group relative p-3 -ml-2 rounded-xl hover:bg-gradient-to-r hover:from-purple-600/20 hover:to-pink-600/20 transition-all duration-300 hover:scale-110">
            <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-purple-500/10 to-pink-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </button>` 
        : `<button id="back-to-list-btn" class="group relative md:hidden p-3 -ml-2 rounded-xl hover:bg-gradient-to-r hover:from-indigo-600/20 hover:to-blue-600/20 transition-all duration-300 hover:scale-110">
            <svg class="w-6 h-6 text-gray-400 group-hover:text-indigo-400 transition-all duration-300 transform group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
            </svg>
            <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-indigo-500/10 to-blue-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
        </button>`;        container.innerHTML = `<div class="flex flex-col h-full bg-black">
            <header class="relative p-4 border-b border-gray-800/50 header-blur flex items-center flex-shrink-0 backdrop-blur-xl bg-gradient-to-r from-gray-900/80 via-gray-800/80 to-gray-900/80">
                <!-- Efeito de gradiente sutil no fundo -->
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600/5 via-purple-600/5 to-indigo-600/5"></div>
                
                <!-- Bot√£o de voltar -->
                <div class="relative z-10">
                    ${backButton}
                </div>
                  <!-- √Årea central com nome centralizado -->
                <div class="flex-1 flex items-center justify-center min-w-0 mx-4 relative z-10">
                    <div class="text-center cursor-pointer group" onclick="document.querySelector('#room-header-name').click()">
                        <!-- Nome centralizado -->
                        <span id="room-header-name" class="font-bold text-lg text-white truncate max-w-[200px] group-hover:text-blue-400 transition-colors duration-300 bg-gradient-to-r from-white to-gray-200 bg-clip-text block">${displayName}</span>
                        <div class="typing-indicator-container text-xs text-gray-400 h-4 w-full">
                            ${roomData.isDirectMessage ? '<span class="text-gray-500 text-xs">Toque para ver detalhes</span>' : `<span class="text-gray-500">${roomData.members?.length || 0} membros</span>`}
                        </div>
                    </div>
                </div>
                
                <!-- Foto do usu√°rio no canto direito (sem indicador verde) -->
                <div class="flex items-center space-x-2 relative z-10">
                    ${headerButtons}
                    <div class="relative cursor-pointer" onclick="document.querySelector('#room-header-pic').click()">
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500/20 to-purple-600/20 p-0.5 hover:scale-105 transition-transform duration-300">
                            <div class="w-full h-full rounded-full overflow-hidden bg-gray-800 ring-2 ring-gray-700/50 hover:ring-blue-500/30 transition-all duration-300">
                                <img id="room-header-pic" src="${photo}" class="w-full h-full object-cover hover:scale-110 transition-transform duration-300" onerror="this.src='https://placehold.co/48x48/cccccc/ffffff?text=?';">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Linha decorativa sutil -->
                <div class="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-blue-500/30 to-transparent"></div>
            </header>
            <div class="messages-container flex-1 overflow-y-auto p-4 space-y-4"></div>
            <div id="recording-indicator" class="hidden items-center justify-center p-4 bg-gradient-to-r from-red-900/80 via-red-800/80 to-red-900/80 text-red-100 backdrop-blur-xl border-t border-red-700/50">
                <!-- Efeito de gradiente sutil -->
                <div class="absolute inset-0 bg-gradient-to-r from-red-600/10 via-pink-600/10 to-red-600/10"></div>
                
                <div class="flex items-center space-x-3 relative z-10">
                    <div class="relative">
                        <div class="w-4 h-4 bg-red-500 rounded-full animate-pulse shadow-lg shadow-red-500/50"></div>
                        <div class="absolute inset-0 w-4 h-4 bg-red-400 rounded-full animate-ping"></div>
                    </div>
                    <span id="recording-timer" class="font-semibold text-lg">00:00</span>
                    <span class="text-red-300 text-sm">Gravando √°udio...</span>
                </div>
                
                <!-- Linha decorativa -->
                <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-red-500/40 to-transparent"></div>
            </div>            <form class="chat-form relative p-3 border-t border-gray-800/50 form-blur flex items-center space-x-3 flex-shrink-0 backdrop-blur-xl bg-gradient-to-r from-gray-900/90 via-gray-800/90 to-gray-900/90">
                <!-- Efeito de gradiente sutil no fundo -->
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600/3 via-purple-600/3 to-indigo-600/3"></div>
                  <!-- Bot√£o de anexar m√≠dia -->
                <button type="button" id="attach-media-btn" class="group relative p-2.5 rounded-full hover:bg-gradient-to-r hover:from-emerald-600/20 hover:to-green-600/20 transition-all duration-300 hover:scale-110 z-10">
                    <svg class="w-5 h-5 text-gray-400 group-hover:text-emerald-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                    <div class="absolute inset-0 rounded-full bg-gradient-to-r from-emerald-500/10 to-green-500/10 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                </button><!-- Input de mensagem -->
                <div class="flex-1 relative z-10">
                    <input type="text" placeholder="Digite sua mensagem..." class="chat-input w-full bg-gradient-to-r from-gray-800/80 to-gray-700/80 border border-gray-600/50 rounded-full px-5 py-2.5 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 text-white placeholder-gray-400 backdrop-blur-sm transition-all duration-300 hover:border-gray-500/70 text-sm"/>
                    <div class="absolute inset-0 rounded-full bg-gradient-to-r from-blue-500/5 to-purple-500/5 opacity-0 hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
                </div>
                  <!-- Bot√£o din√¢mico (microfone/enviar) -->
                <button type="button" id="dynamic-action-btn" class="group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10">
                    <!-- √çcone do microfone (padr√£o) - SEM hover vermelho -->
                    <svg id="mic-icon" class="w-5 h-5 text-gray-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
                    </svg>
                    <!-- √çcone de enviar (oculto inicialmente) -->
                    <svg id="send-icon" class="w-5 h-5 text-gray-400 group-hover:text-blue-400 transition-colors duration-300 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                    <!-- Removido o background gradient vermelho -->
                </button>
                
                <!-- Linha decorativa sutil -->
                <div class="absolute top-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-blue-500/30 to-transparent"></div>
            </form>
        </div>`;        if(!isGuestView) {
            const backBtn = container.querySelector('#back-to-list-btn');
            if(backBtn) {
                backBtn.onclick = () => { 
                    document.getElementById('sidebar').classList.remove('-translate-x-full'); 
                    document.getElementById('chat-panel').classList.add('translate-x-full'); 
                    delete container.dataset.currentRoomId; 
                };
            }
        } else {
            const guestBtn = container.querySelector('#guest-settings-btn');
            if(guestBtn) {
                guestBtn.onclick = openUserSettings;
            }
        }        
        // Event listeners para o cabe√ßalho
        const headerPic = container.querySelector('#room-header-pic');
        if(headerPic) {
            headerPic.parentElement.onclick = () => openImageViewer(photo, { isRoom: true, isAdmin });
        }
        
        const headerName = container.querySelector('#room-header-name');
        if(headerName) {
            headerName.onclick = () => openConversationSettings(roomData);
        }
        
        // Event listeners para o formul√°rio
        container.querySelector('.chat-form').onsubmit = sendMessage;
        container.querySelector('#attach-media-btn').onclick = () => document.getElementById('media-uploader').click();
        
        // Input e bot√£o din√¢mico
        const chatInput = container.querySelector('.chat-input');
        const dynamicBtn = container.querySelector('#dynamic-action-btn');
        const micIcon = container.querySelector('#mic-icon');
        const sendIcon = container.querySelector('#send-icon');        // Fun√ß√£o para alternar entre microfone e enviar
        function toggleButtonState() {
            const hasText = chatInput.value.trim().length > 0;
            
            console.log('üîÑ [TOGGLE] Iniciando toggleButtonState');
            console.log('üîÑ [TOGGLE] hasText:', hasText, 'value:', chatInput.value);
            console.log('üîÑ [TOGGLE] state.isRecording:', state.isRecording);
            console.log('üîÑ [TOGGLE] Classes atuais do bot√£o:', dynamicBtn.className);
            
            if (hasText) {
                console.log('üì§ [TOGGLE] Mostrando bot√£o de enviar');
                // Mostrar bot√£o de enviar
                micIcon.classList.add('hidden');
                sendIcon.classList.remove('hidden');
                
                // Garantir que n√£o est√° gravando quando muda para enviar
                state.isRecording = false;
                
                // Atualizar classes do bot√£o para estilo azul
                dynamicBtn.className = 'group relative p-2.5 rounded-full hover:bg-gradient-to-r hover:from-blue-600/20 hover:to-blue-600/20 transition-all duration-300 hover:scale-110 z-10';
                console.log('üì§ [TOGGLE] Classes do bot√£o definidas para ENVIAR:', dynamicBtn.className);
                
                // Remover todos os event listeners de √°udio
                dynamicBtn.removeEventListener('mousedown', startRecording);
                dynamicBtn.removeEventListener('mouseup', stopRecording);
                dynamicBtn.removeEventListener('touchstart', startRecording);
                dynamicBtn.removeEventListener('touchend', stopRecording);
                console.log('üì§ [TOGGLE] Listeners de grava√ß√£o removidos');
                
                // Definir como bot√£o de enviar
                dynamicBtn.onclick = (e) => {
                    e.preventDefault();
                    console.log('üì§ [CLICK] Enviando mensagem via bot√£o din√¢mico');
                    
                    // Verificar se h√° texto antes de enviar
                    if (chatInput.value.trim()) {
                        // Simular envio da mensagem
                        const form = container.querySelector('.chat-form');
                        const event = new Event('submit', { bubbles: true, cancelable: true });
                        form.dispatchEvent(event);
                    }
                };            } else {
                console.log('üé§ [TOGGLE] Mostrando bot√£o de microfone');
                // Mostrar bot√£o de microfone
                micIcon.classList.remove('hidden');
                sendIcon.classList.add('hidden');
                
                // SEMPRE garantir que o estado de grava√ß√£o esteja limpo
                state.isRecording = false;
                console.log('üé§ [TOGGLE] state.isRecording for√ßado para false');
                
                // For√ßar reset da UI de grava√ß√£o se a fun√ß√£o estiver dispon√≠vel
                if (typeof updateRecordingUI === 'function') {
                    console.log('üé§ [TOGGLE] Chamando updateRecordingUI(false)');
                    updateRecordingUI(false);
                }
                
                // SEMPRE limpar classes vermelhas antes de aplicar as corretas
                dynamicBtn.classList.remove('animate-pulse', 'scale-110', 'bg-gradient-to-r', 'from-red-500/80', 'to-red-600/80', 'hover:from-red-600/90', 'hover:to-red-700/90');
                
                // Atualizar classes do bot√£o para estilo neutro (cinza)
                dynamicBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                console.log('üé§ [TOGGLE] Classes do bot√£o definidas para MICROFONE:', dynamicBtn.className);
                
                // Limpar estilo inline se houver
                dynamicBtn.style.background = '';
                dynamicBtn.style.backgroundColor = '';
                
                // Remover onclick de enviar
                dynamicBtn.onclick = null;
                console.log('üé§ [TOGGLE] onClick removido');
                
                // Remover listeners antigos para evitar duplica√ß√£o
                dynamicBtn.removeEventListener('mousedown', startRecording);
                dynamicBtn.removeEventListener('mouseup', stopRecording);
                dynamicBtn.removeEventListener('touchstart', startRecording);
                dynamicBtn.removeEventListener('touchend', stopRecording);
                console.log('üé§ [TOGGLE] Listeners antigos removidos');
                
                // Adicionar event listeners para grava√ß√£o de √°udio apenas se as fun√ß√µes existirem
                if (typeof startRecording === 'function' && typeof stopRecording === 'function') {
                    dynamicBtn.addEventListener('mousedown', startRecording);
                    dynamicBtn.addEventListener('mouseup', stopRecording);
                    dynamicBtn.addEventListener('touchstart', startRecording, { passive: false });
                    dynamicBtn.addEventListener('touchend', stopRecording);
                    console.log('üé§ [TOGGLE] Novos listeners de grava√ß√£o adicionados');
                } else {
                    console.log('‚ö†Ô∏è [TOGGLE] Fun√ß√µes de grava√ß√£o n√£o encontradas');
                }
            }
            
            console.log('üîÑ [TOGGLE] toggleButtonState finalizado');
        }        // Monitorar mudan√ßas no input
        chatInput.addEventListener('input', () => {
            console.log('üî§ [INPUT] Event input disparado, valor atual:', chatInput.value);
            toggleButtonState();
            handleTyping();
        });
        
        // Monitorar quando o campo perde o foco
        chatInput.addEventListener('blur', () => {
            console.log('üî§ [BLUR] Campo perdeu foco');
            setTimeout(() => {
                console.log('üî§ [BLUR] Timeout executado, chamando toggleButtonState');
                toggleButtonState();
            }, 100);
        });        // Garantir estado inicial (microfone vis√≠vel, enviar oculto)
        chatInput.value = ''; // Limpar qualquer valor
        toggleButtonState(); // Usar a fun√ß√£o centralizada
        console.log('üéØ [INIT] Estado inicial configurado via toggleButtonState');
        
        // Estado inicial
        toggleButtonState();
          // Event listener para configura√ß√µes da sala
        const roomSettingsBtn = container.querySelector('#room-settings-btn');
        if (roomSettingsBtn) roomSettingsBtn.onclick = openRoomSettings;
          // Debug final - verificar estado ap√≥s configura√ß√£o completa
        setTimeout(() => {
            console.log('üéØ [FINAL_CHECK] Verifica√ß√£o final da configura√ß√£o do chat:');
            console.log('üéØ [FINAL_CHECK] chatInput.value:', chatInput.value);
            console.log('üéØ [FINAL_CHECK] micIcon.hidden:', micIcon.classList.contains('hidden'));
            console.log('üéØ [FINAL_CHECK] sendIcon.hidden:', sendIcon.classList.contains('hidden'));
            console.log('üéØ [FINAL_CHECK] dynamicBtn.className:', dynamicBtn.className);
            console.log('üéØ [FINAL_CHECK] state.isRecording:', state.isRecording);            
            // Testar se os listeners est√£o funcionando
            console.log('üéØ [FINAL_CHECK] Listeners ativos no bot√£o:', {
                mousedown: !!dynamicBtn.onmousedown,
                mouseup: !!dynamicBtn.onmouseup,
                onclick: !!dynamicBtn.onclick
            });            // Adicionar fun√ß√£o global de emerg√™ncia para debug
            window.forceResetButton = function() {
                console.log('üö® [EMERGENCY] Fun√ß√£o de emerg√™ncia chamada pelo usu√°rio');
                const chatInput = document.querySelector('.chat-input');
                const dynamicBtn = document.querySelector('#dynamic-action-btn');
                const micIcon = document.querySelector('#mic-icon');
                const sendIcon = document.querySelector('#send-icon');
                
                if (dynamicBtn && micIcon && sendIcon) {
                    // For√ßar estado limpo
                    state.isRecording = false;
                    
                    // Mostrar microfone
                    micIcon.classList.remove('hidden');
                    sendIcon.classList.add('hidden');
                    
                    // Limpar completamente o bot√£o
                    dynamicBtn.className = '';
                    dynamicBtn.removeAttribute('style');
                    dynamicBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                    
                    // Garantir que n√£o h√° estilos inline
                    dynamicBtn.style.background = '';
                    dynamicBtn.style.backgroundColor = '';
                    
                    console.log('üö® [EMERGENCY] Bot√£o resetado com sucesso!');
                    console.log('üö® [EMERGENCY] Classes finais:', dynamicBtn.className);
                } else {
                    console.log('üö® [EMERGENCY] Elementos n√£o encontrados');
                }
            };
              // Fun√ß√£o para debug do estado atual
            window.debugButtonState = function() {
                const dynamicBtn = document.querySelector('#dynamic-action-btn');
                const chatInput = document.querySelector('.chat-input');
                const micIcon = document.querySelector('#mic-icon');
                const sendIcon = document.querySelector('#send-icon');
                const computedStyle = window.getComputedStyle(dynamicBtn);
                
                console.log('üîç [DEBUG] Estado completo:', {
                    isRecording: state.isRecording,
                    inputValue: chatInput?.value,
                    buttonClasses: dynamicBtn?.className,
                    buttonStyle: dynamicBtn?.style.cssText,
                    computedBg: computedStyle.backgroundColor,
                    computedBgImage: computedStyle.backgroundImage,
                    micHidden: micIcon?.classList.contains('hidden'),
                    sendHidden: sendIcon?.classList.contains('hidden'),
                    allClasses: Array.from(dynamicBtn?.classList || [])
                });
                
                // Verificar se h√° CSS conflitante
                const allStyles = [];
                for (let i = 0; i < document.styleSheets.length; i++) {
                    try {
                        const rules = document.styleSheets[i].cssRules || document.styleSheets[i].rules;
                        for (let j = 0; j < rules.length; j++) {
                            if (rules[j].selectorText && rules[j].selectorText.includes('dynamic-action-btn')) {
                                allStyles.push({
                                    selector: rules[j].selectorText,
                                    cssText: rules[j].cssText
                                });
                            }
                        }
                    } catch (e) {
                        // Ignorar erros de CORS
                    }
                }
                console.log('üîç [DEBUG] CSS rules aplicadas:', allStyles);            };
            
            // Fun√ß√£o para for√ßar estado correto de forma ULTRA DR√ÅSTICA
            window.forceMicrophoneState = function() {
                console.log('üö® [ULTRA_FORCE] For√ßando estado de microfone ULTRA DR√ÅSTICAMENTE');
                
                const dynamicBtn = document.querySelector('#dynamic-action-btn');
                const micIcon = document.querySelector('#mic-icon');
                const sendIcon = document.querySelector('#send-icon');
                
                if (dynamicBtn && micIcon && sendIcon) {
                    // Limpar estado
                    state.isRecording = false;
                    
                    // Mostrar √≠cone correto
                    micIcon.classList.remove('hidden');
                    sendIcon.classList.add('hidden');
                    
                    // LIMPEZA ULTRA DR√ÅSTICA
                    dynamicBtn.removeAttribute('class');
                    dynamicBtn.removeAttribute('style');
                    
                    // Aplicar CSS inline for√ßado
                    dynamicBtn.style.cssText = `
                        background: transparent !important;
                        background-color: transparent !important;
                        background-image: none !important;
                        position: relative;
                        padding: 0.625rem;
                        border-radius: 9999px;
                        transition: all 0.3s;
                        z-index: 10;
                    `;
                    
                    // Aplicar classes
                    dynamicBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                    
                    // Remover todos os event listeners e re-aplicar apenas os de microfone
                    const newBtn = dynamicBtn.cloneNode(true);
                    dynamicBtn.parentNode.replaceChild(newBtn, dynamicBtn);
                    
                    console.log('üö® [ULTRA_FORCE] Bot√£o completamente recriado');
                    console.log('üö® [ULTRA_FORCE] Novo background:', window.getComputedStyle(newBtn).backgroundColor);
                }
            };
            
            console.log('üéØ [FINAL_CHECK] Fun√ß√µes de emerg√™ncia criadas: window.forceResetButton(), window.debugButtonState(), window.forceMicrophoneState()');
              // Monitoramento cont√≠nuo para auto-corre√ß√£o
            const continuousMonitor = setInterval(() => {
                const btn = document.querySelector('#dynamic-action-btn');
                const input = document.querySelector('.chat-input');
                const micIcon = document.querySelector('#mic-icon');
                const sendIcon = document.querySelector('#send-icon');
                
                if (btn && input && input.value.trim() === '' && !state.isRecording && micIcon && sendIcon) {
                    if (btn.className.includes('red') || btn.className.includes('pulse')) {
                        console.log('üîÑ [AUTO_MONITOR] Detectado bot√£o vermelho incorreto - auto-corrigindo');
                        
                        // Corre√ß√£o direta sem toggleButtonState
                        state.isRecording = false;
                        micIcon.classList.remove('hidden');
                        sendIcon.classList.add('hidden');
                        btn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                        btn.removeAttribute('style');
                        
                        console.log('üîÑ [AUTO_MONITOR] Bot√£o corrigido automaticamente');
                    }
                }
            }, 1000); // Verificar a cada segundo
            
            // Parar o monitor ap√≥s 2 minutos (para n√£o sobrecarregar)
            setTimeout(() => {
                clearInterval(continuousMonitor);
                console.log('üîÑ [AUTO_MONITOR] Monitor cont√≠nuo desativado ap√≥s 2 minutos');
            }, 120000);
        }, 1000);
    }

    function subscribeToMessages(roomId, container) {
        if(state.unsubscribeMessages) state.unsubscribeMessages();
        if(state.readReceiptObserver) state.readReceiptObserver.disconnect();
        const q = query(collection(db, `rooms/${roomId}/messages`), orderBy('createdAt', 'asc'));
        state.unsubscribeMessages = onSnapshot(q, snapshot => {
            if(!container) return;
            let lastSenderId = null;
            const isScrolledToBottom = container.scrollHeight - container.clientHeight <= container.scrollTop + 50;
            container.innerHTML = snapshot.docs.map(doc => {
                const msg = doc.data();
                const sentByMe = msg.senderId === state.currentUserId;
                const showSender = msg.senderId !== lastSenderId && !sentByMe;
                lastSenderId = msg.senderId;
                let contentHtml = '';
                if(msg.type === 'image') {
                    contentHtml = `<img src="${msg.mediaUrl}" class="chat-image rounded-lg max-w-xs max-h-64 object-cover cursor-pointer" data-src="${msg.mediaUrl}" />`;
                } else if (msg.type === 'video') {
                    contentHtml = `<video src="${msg.mediaUrl}" class="rounded-lg max-w-xs max-h-64" controls></video>`;
                } else if (msg.type === 'audio') {
                    contentHtml = `<audio src="${msg.mediaUrl}" controls class="max-w-xs"></audio>`;                } else {
                    contentHtml = `<div class="max-w-[280px] sm:max-w-[320px] p-3 rounded-2xl ${sentByMe ? 'bg-gradient-to-br from-blue-600 to-blue-700 text-white shadow-lg' : 'bg-gradient-to-br from-gray-800 to-gray-700 text-gray-100 border border-gray-600/30'} break-words overflow-wrap-anywhere whitespace-pre-wrap leading-relaxed">${msg.content}</div>`;
                }
                let seenHtml = '';
                if(sentByMe) {
                    const allMembers = state.currentRoomData?.members || [];
                    const seenByCount = Object.keys(msg.seenBy || {}).length;
                    const allHaveSeen = seenByCount >= allMembers.length - 1;
                    const seenColor = allHaveSeen ? 'text-blue-400' : 'text-gray-400';
                    seenHtml = `<svg class="seen-icon ${seenColor}" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>`;
                }
                return `<div class="flex flex-col w-full ${sentByMe ? 'items-end' : 'items-start'} message-item" data-id="${doc.id}">
                    ${showSender ? `<div class="text-xs text-gray-500 mb-1 px-1">${msg.senderName || 'Usu√°rio'}</div>` : ''}
                    <div class="flex items-center">
                        ${contentHtml}
                        ${sentByMe ? seenHtml : ''}
                    </div>
                </div>`;
            }).join('');
            container.querySelectorAll('.chat-image').forEach(img => {
                img.onclick = () => openImageViewer(img.dataset.src);
            });
            setupReadReceipts(snapshot.docs);
            if (isScrolledToBottom) { container.scrollTop = container.scrollHeight; }
        });
    }
    
    function setupReadReceipts(messageDocs) {
        if (state.readReceiptObserver) state.readReceiptObserver.disconnect();
        const observerCallback = (entries, observer) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const messageId = entry.target.dataset.id;
                    const messageRef = doc(db, `rooms/${state.currentRoomData.id}/messages`, messageId);
                    updateDoc(messageRef, { [`seenBy.${state.currentUserId}`]: true });
                    observer.unobserve(entry.target);
                }
            });
        };
        state.readReceiptObserver = new IntersectionObserver(observerCallback, { threshold: 0.8 });
        messageDocs.forEach(messageDoc => {
            const messageData = messageDoc.data();
            if (messageData.senderId !== state.currentUserId && !(messageData.seenBy && messageData.seenBy[state.currentUserId])) {
                const el = document.querySelector(`.message-item[data-id="${messageDoc.id}"]`);
                if(el) state.readReceiptObserver.observe(el);
            }
        });
    }    async function sendMessage(e) {
        e.preventDefault();
        console.log('üì¨ [SEND] sendMessage iniciada');
        
        const input = e.target.querySelector('.chat-input');
        const text = input.value;
        console.log('üì¨ [SEND] Texto da mensagem:', text);
        
        if(!text.trim()) {
            console.log('üì¨ [SEND] Texto vazio, cancelando envio');
            return;
        }
          console.log('üì¨ [SEND] Limpando input');
        input.value = '';
        
        // CORRE√á√ÉO IMEDIATA E AGRESSIVA para o bot√£o vermelho
        console.log('üì¨ [SEND] Aplicando corre√ß√£o imediata do bot√£o');
        state.isRecording = false;
        
        const dynamicBtn = document.querySelector('#dynamic-action-btn');
        const micIcon = document.querySelector('#mic-icon');
        const sendIcon = document.querySelector('#send-icon');
        
        if (dynamicBtn && micIcon && sendIcon) {
            // For√ßar estado de microfone IMEDIATAMENTE
            micIcon.classList.remove('hidden');
            sendIcon.classList.add('hidden');
            
            // Limpar TODAS as classes vermelhas de forma agressiva
            dynamicBtn.classList.remove('animate-pulse', 'scale-110', 'bg-gradient-to-r', 'from-red-500/80', 'to-red-600/80', 'hover:from-red-600/90', 'hover:to-red-700/90', 'bg-red-500', 'bg-red-600');
            
            // Aplicar classes corretas
            dynamicBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
              // Limpar estilos inline
            dynamicBtn.style.background = '';
            dynamicBtn.style.backgroundColor = '';
            
            // FOR√áAR limpeza do estado de hover/focus
            dynamicBtn.blur();
            dynamicBtn.onmouseout = null;
            dynamicBtn.onmouseleave = null;
            
            // Criar um evento artificial para "sair" do hover
            const mouseLeaveEvent = new MouseEvent('mouseleave', {
                view: window,
                bubbles: true,
                cancelable: true
            });
            dynamicBtn.dispatchEvent(mouseLeaveEvent);
            
            console.log('üì¨ [SEND] Bot√£o corrigido imediatamente - classes:', dynamicBtn.className);
            console.log('üì¨ [SEND] Estado de hover for√ßadamente limpo');
        }
          // Verifica√ß√£o adicional ap√≥s um delay para garantir que ficou correto
        setTimeout(() => {
            console.log('üì¨ [SEND] Verifica√ß√£o final do estado do bot√£o');
            const finalBtn = document.querySelector('#dynamic-action-btn');
            const finalMic = document.querySelector('#mic-icon');
            const finalSend = document.querySelector('#send-icon');
            
            if (finalBtn && finalMic && finalSend) {
                console.log('üì¨ [SEND] Estado visual atual:', {
                    className: finalBtn.className,
                    style: finalBtn.style.cssText,
                    computedStyle: window.getComputedStyle(finalBtn).backgroundColor,
                    micHidden: finalMic.classList.contains('hidden'),
                    sendHidden: finalSend.classList.contains('hidden')
                });
                  // Se ainda estiver vermelho VISUALMENTE, corrigir drasticamente
                const computedBg = window.getComputedStyle(finalBtn).backgroundColor;
                const isVisuallyRed = finalBtn.className.includes('red') || finalBtn.className.includes('pulse') || 
                                    computedBg.includes('255') || computedBg.includes('red');
                
                // NOVA VERIFICA√á√ÉO: Verificar se √© o √≠cone que est√° vermelho
                const micIcon = finalBtn.querySelector('#mic-icon');
                const micComputedColor = micIcon ? window.getComputedStyle(micIcon).color : 'none';
                
                console.log('üì¨ [SEND] Diagn√≥stico detalhado:', {
                    buttonBg: computedBg,
                    micIconColor: micComputedColor,
                    isVisuallyRed: isVisuallyRed,
                    hasRedClass: finalBtn.className.includes('red')
                });
                
                if (isVisuallyRed || micComputedColor.includes('255, 0, 0') || micComputedColor.includes('red')) {
                    console.log('‚ö†Ô∏è [SEND] Problema detectado! Aplicando corre√ß√£o DR√ÅSTICA');
                    console.log('‚ö†Ô∏è [SEND] Background computado:', computedBg);
                    console.log('‚ö†Ô∏è [SEND] Cor do √≠cone:', micComputedColor);
                    
                    // RESET COMPLETO E DR√ÅSTICO
                    finalBtn.removeAttribute('class');
                    finalBtn.removeAttribute('style');
                    
                    // Limpar estados de hover/focus/active
                    finalBtn.blur();
                    finalBtn.style.cssText = 'pointer-events: none';
                    setTimeout(() => {
                        finalBtn.style.cssText = '';
                    }, 10);
                    
                    finalBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                    
                    // For√ßar estilos inline para garantir
                    finalBtn.style.backgroundColor = 'transparent';
                    finalBtn.style.background = 'transparent';
                    finalBtn.style.backgroundImage = 'none';
                    
                    // Garantir √≠cones corretos e suas cores
                    finalMic.classList.remove('hidden');
                    finalSend.classList.add('hidden');
                    
                    // FOR√áAR cor do √≠cone para cinza
                    if (micIcon) {
                        micIcon.style.color = '#9ca3af'; // text-gray-400
                    }
                    
                    console.log('‚ö†Ô∏è [SEND] Corre√ß√£o DR√ÅSTICA aplicada');
                    console.log('‚ö†Ô∏è [SEND] Novo background:', window.getComputedStyle(finalBtn).backgroundColor);
                    console.log('‚ö†Ô∏è [SEND] Nova cor do √≠cone:', micIcon ? window.getComputedStyle(micIcon).color : 'none');
                }
            }
        }, 200);

        const roomId = state.currentRoomData.id;
        const batch = writeBatch(db);
        const roomRef = doc(db, 'rooms', roomId);
        const newMsgRef = doc(collection(db, `rooms/${roomId}/messages`));

        batch.set(newMsgRef, {
            content: text, type: 'text', senderId: state.currentUserId, 
            senderName: state.currentUserData.username,
            senderPhoto: state.currentUserData.photoURL,
            seenBy: {}, createdAt: serverTimestamp()
        });

        batch.update(roomRef, { 
            lastMessage: {
                text: text.substring(0, 40),
                senderId: state.currentUserId,
                senderName: state.currentUserData.username,
                senderPhoto: state.currentUserData.photoURL,
                createdAt: serverTimestamp()
            }
        });        await batch.commit();
        
        console.log('üì¨ [SEND] Mensagem enviada para o Firebase, campo limpo');
        console.log('üì¨ [SEND] sendMessage finalizada');
        
        const userTypingRef = doc(db, 'rooms', state.currentRoomData.id);
        await updateDoc(userTypingRef, { typing: arrayRemove({uid: state.currentUserId, name: state.currentUserData.username}) });
        clearTimeout(state.typingTimeout);    }
    
    async function sendAudioMessage(url, duration) {
        console.log('üéµ [AUDIO_MSG] sendAudioMessage iniciada');
        if(!state.currentRoomData) return;
        const roomId = state.currentRoomData.id;
        const batch = writeBatch(db);
        const roomRef = doc(db, 'rooms', roomId);
        const newMsgRef = doc(collection(db, `rooms/${roomId}/messages`));
        const contentText = `üé§ √Åudio (${duration}s)`;

        batch.set(newMsgRef, {
            type: 'audio', mediaUrl: url, duration: duration, 
            senderId: state.currentUserId, senderName: state.currentUserData.username,
            senderPhoto: state.currentUserData.photoURL,
            seenBy: {}, createdAt: serverTimestamp()
        });

        batch.update(roomRef, { 
            lastMessage: {
                text: contentText,
                senderId: state.currentUserId,
                senderName: state.currentUserData.username,
                senderPhoto: state.currentUserData.photoURL,
                createdAt: serverTimestamp()
            }
        });
        
        await batch.commit();
        console.log('üéµ [AUDIO_MSG] Mensagem de √°udio enviada para o Firebase');
        
        // Verificar se o bot√£o ainda est√° vermelho ap√≥s envio de √°udio
        setTimeout(() => {
            const dynamicBtn = document.getElementById('dynamic-action-btn');
            if (dynamicBtn) {
                console.log('üéµ [AUDIO_MSG] Verifica√ß√£o p√≥s-envio - classes do bot√£o:', dynamicBtn.className);
                console.log('üéµ [AUDIO_MSG] state.isRecording:', state.isRecording);
                
                // For√ßar reset se necess√°rio
                if (dynamicBtn.className.includes('red') || dynamicBtn.className.includes('pulse')) {
                    console.log('üéµ [AUDIO_MSG] PROBLEMA: Bot√£o ainda vermelho ap√≥s envio de √°udio!');
                    console.log('üéµ [AUDIO_MSG] For√ßando reset das classes');
                    
                    state.isRecording = false;
                    updateRecordingUI(false);
                }
            }
        }, 200);
    }


    async function sendMediaMessage(type, url, fileName) {
        if(!state.currentRoomData) return;
        const roomId = state.currentRoomData.id;
        const batch = writeBatch(db);
        const roomRef = doc(db, 'rooms', roomId);
        const newMsgRef = doc(collection(db, `rooms/${roomId}/messages`));
        const contentText = type === 'image' ? 'üì∑ Imagem' : 'üìπ V√≠deo';

        batch.set(newMsgRef, {
            type: type, mediaUrl: url, fileName: fileName, 
            senderId: state.currentUserId, senderName: state.currentUserData.username,
            senderPhoto: state.currentUserData.photoURL,
            seenBy: {}, createdAt: serverTimestamp()
        });

        batch.update(roomRef, { 
            lastMessage: {
                text: contentText,
                senderId: state.currentUserId,
                senderName: state.currentUserData.username,
                senderPhoto: state.currentUserData.photoURL,
                createdAt: serverTimestamp()
            }
        });
        
        await batch.commit();
    }

    function shareRoom(roomId) {
        const modal = document.getElementById('share-link-modal');
        const input = document.getElementById('share-link-input');
        const copyBtn = document.getElementById('copy-link-btn');
        const link = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
        input.value = link;
        modal.classList.remove('hidden');
        copyBtn.onclick = () => {
             if (navigator.clipboard) {
                 navigator.clipboard.writeText(link).then(() => {
                     showNotification("Link de convite copiado!");
                     modal.classList.add('hidden');
                 });
             }
        };
    }    function handleTyping() {
        console.log('‚å®Ô∏è [TYPING] handleTyping chamada');
        if(!state.currentRoomData) return;
        const userTypingRef = doc(db, 'rooms', state.currentRoomData.id);
        clearTimeout(state.typingTimeout);
        updateDoc(userTypingRef, { typing: arrayUnion({uid: state.currentUserId, name: state.currentUserData.username}) });
        state.typingTimeout = setTimeout(() => {
            console.log('‚å®Ô∏è [TYPING] Timeout de typing executado - removendo usu√°rio da lista');
            updateDoc(userTypingRef, { typing: arrayRemove({uid: state.currentUserId, name: state.currentUserData.username}) });
        }, 2000);
    }

    function updateTypingIndicator(typingUsers) {
        const chatPanel = document.getElementById('chat-panel');
        const guestPanel = document.getElementById('guest-container');
        const container = chatPanel?.dataset.currentRoomId ? chatPanel.querySelector('.typing-indicator-container') : guestPanel.querySelector('.typing-indicator-container');
        if (!container) return;
        const otherTypingUsers = (typingUsers || []).filter(u => u.uid !== state.currentUserId);
        if (otherTypingUsers.length === 0) { container.innerHTML = ''; } 
        else {
            const names = otherTypingUsers.map(u => u.name.split(' ')[0]).join(', ');
            const verb = otherTypingUsers.length > 1 ? 'est√£o' : 'est√°';
            container.innerHTML = `<p>${names} ${verb} digitando...</p>`;
        }
    }
      function openUserSettings() {
        const modal = document.getElementById('user-settings-modal');
        modal.classList.remove('hidden');
        document.getElementById('user-settings-pic').src = state.currentUserData.photoURL;
        const nameInput = document.getElementById('user-settings-name');
        nameInput.value = state.currentUserData.username;
        document.getElementById('logout-btn').onclick = () => {
            document.getElementById('user-settings-modal').classList.add('hidden');
            signOut(auth);
        };
        document.getElementById('user-settings-pic').parentElement.onclick = () => {
             state.imageUploadContext = { type: 'user' };
             document.getElementById('image-uploader').click();
        };
        nameInput.onblur = async () => {
            let newName = nameInput.value.trim();
            if (state.currentUserData.isGuest) {
                const guestPrefix = "Convidado: ";
                let rawName = newName.startsWith(guestPrefix) ? newName.substring(guestPrefix.length) : newName;
                rawName = rawName.trim();

                if (!rawName) {
                    nameInput.value = state.currentUserData.username;
                    showNotification("O nome de convidado n√£o pode ser vazio.", "error");
                    return;
                }
                newName = guestPrefix + rawName;
            }

            if (newName && newName !== state.currentUserData.username) {
                const updateData = { username: newName };
                if (state.currentUserData.isGuest) {
                    updateData.guest_name_lowercase = newName.replace("Convidado: ", "").trim().toLowerCase();
                } else {
                    updateData.username_lowercase = newName.toLowerCase();
                }
                await updateDoc(doc(db, 'users', state.currentUserId), updateData);
                showNotification("Nome atualizado!");
            }
            nameInput.value = newName;
        };
    }    function openConversationSettings(roomData) {
        const modal = document.getElementById('conversation-settings-modal');
        const displayName = getRoomDisplayName(roomData, state.currentUserId);
        const otherUserId = roomData.isDirectMessage ? roomData.members.find(id => id !== state.currentUserId) : null;
        const photo = roomData.isDirectMessage ? 
            (roomData.memberPhotos?.[otherUserId] || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName[0] || '?')}&background=A78BFA&color=fff&size=80`) : 
            (roomData.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(displayName[0] || '?')}&background=A78BFA&color=fff&size=80`);
        
        // Preencher informa√ß√µes da conversa
        document.getElementById('conversation-settings-pic').src = photo;
        document.getElementById('conversation-settings-name').textContent = displayName;
        document.getElementById('conversation-settings-type').textContent = roomData.isDirectMessage ? 'Conversa Direta' : 'Sala de Chat';
          // Atualizar status online/offline do usu√°rio
        const statusIndicator = document.getElementById('user-status-indicator');
        if (roomData.isDirectMessage && otherUserId) {
            const isOnline = state.usersStatus[otherUserId]?.state === 'online';
            const statusDot = statusIndicator.querySelector('.w-2');
            const statusText = statusIndicator.querySelector('.text-xs');
            
            if (statusDot && statusText) {
                if (isOnline) {
                    statusDot.className = 'w-2 h-2 bg-green-500 rounded-full animate-pulse';
                    statusText.className = 'text-xs text-green-400';
                    statusText.textContent = 'Online';
                } else {
                    statusDot.className = 'w-2 h-2 bg-gray-400 rounded-full';
                    statusText.className = 'text-xs text-gray-400';
                    statusText.textContent = 'Offline';
                }
            }
            statusIndicator.style.display = 'flex';
        } else {
            // Ocultar status para conversas em grupo
            statusIndicator.style.display = 'none';
        }
        
        // Mostrar/esconder bot√£o de bloquear baseado no tipo de conversa
        const blockBtn = document.getElementById('block-user-btn');
        if (roomData.isDirectMessage && !state.currentUserData.isGuest) {
            blockBtn.style.display = 'flex';
            blockBtn.textContent = 'Bloquear Usu√°rio';
        } else {
            blockBtn.style.display = 'none';
        }
        
        modal.classList.remove('hidden');
        
        // Event listeners do modal
        document.getElementById('close-conversation-settings-btn').onclick = () => {
            modal.classList.add('hidden');
        };
        
        document.getElementById('clear-chat-btn').onclick = async () => {
            const confirmed = await showCustomConfirm('Limpar Conversa', 'Tem certeza que deseja limpar todas as mensagens desta conversa? Esta a√ß√£o n√£o pode ser desfeita.');
            if (confirmed) {
                try {
                    // Buscar todas as mensagens
                    const messagesRef = collection(db, `rooms/${roomData.id}/messages`);
                    const messagesSnapshot = await getDocs(messagesRef);
                    
                    // Deletar mensagens em lote
                    const batch = writeBatch(db);
                    messagesSnapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                    
                    showNotification('Conversa limpa com sucesso!');
                    modal.classList.add('hidden');
                } catch (error) {
                    console.error('Erro ao limpar conversa:', error);
                    showNotification('Erro ao limpar conversa.', 'error');
                }
            }
        };
        
        document.getElementById('block-user-btn').onclick = async () => {
            if (!roomData.isDirectMessage) return;
            
            const confirmed = await showCustomConfirm('Bloquear Usu√°rio', 'Tem certeza que deseja bloquear este usu√°rio? Voc√™s n√£o poder√£o mais se enviar mensagens.');
            if (confirmed) {
                try {
                    // Adicionar √† lista de bloqueados
                    await updateDoc(doc(db, 'users', state.currentUserId), {
                        blockedUsers: arrayUnion(otherUserId)
                    });
                    
                    // Adicionar o usu√°rio atual √† lista de bloqueados do outro usu√°rio
                    await updateDoc(doc(db, 'users', otherUserId), {
                        blockedUsers: arrayUnion(state.currentUserId)
                    });
                    
                    showNotification('Usu√°rio bloqueado com sucesso.');
                    modal.classList.add('hidden');
                    
                    // Voltar √† lista de conversas
                    document.getElementById('sidebar').classList.remove('-translate-x-full');
                    document.getElementById('chat-panel').classList.add('translate-x-full');
                } catch (error) {
                    console.error('Erro ao bloquear usu√°rio:', error);
                    showNotification('Erro ao bloquear usu√°rio.', 'error');
                }
            }
        };
        
        // Fechar modal ao clicar fora
        modal.onclick = (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        };
    }

    function openUserSearch() {
        const modal = document.getElementById('user-search-modal');
        modal.classList.remove('hidden');
        const searchInput = document.getElementById('user-search-input');
        const resultsContainer = document.getElementById('user-search-results');
        let searchTimeout;
        const performSearch = async () => {
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (!searchTerm) { resultsContainer.innerHTML = ''; return; }
            const regularSearch = query(collection(db, 'users'), where('username_lowercase', '>=', searchTerm), where('username_lowercase', '<=', searchTerm + '\uf8ff'));
            const guestSearch = query(collection(db, 'users'), where('guest_name_lowercase', '>=', searchTerm), where('guest_name_lowercase', '<=', searchTerm + '\uf8ff'));
            const [regularResults, guestResults] = await Promise.all([getDocs(regularSearch), getDocs(guestSearch)]);
            const combinedResults = new Map();
            regularResults.forEach(doc => combinedResults.set(doc.id, doc.data()));
            guestResults.forEach(doc => combinedResults.set(doc.id, doc.data()));
            const me = state.currentUserData;
            resultsContainer.innerHTML = combinedResults.size === 0
                ? `<p class="p-4 text-center text-gray-500">Nenhum usu√°rio encontrado.</p>`
                : [...combinedResults.values()].map(user => {
                    if (user.uid === state.currentUserId) return '';
                    const isFriend = me.friends?.includes(user.uid);
                    const hasPendingRequestToMe = me.friendRequests?.some(req => req.from === user.uid);
                    const hasIPendingRequestToThem = user.friendRequests?.some(req => req.from === state.currentUserId);
                    let actionButton = '';
                    if (isFriend) {
                        actionButton = `<button class="ml-auto bg-green-500 text-white text-xs px-2 py-1 rounded-md" disabled>Amigo</button>`;
                    } else if (hasPendingRequestToMe || hasIPendingRequestToThem) {
                        actionButton = `<button class="ml-auto bg-yellow-500 text-white text-xs px-2 py-1 rounded-md" disabled>Pendente</button>`;
                    } else if (!me.isGuest) {
                        actionButton = `<button class="ml-auto bg-blue-500 text-white text-xs px-2 py-1 rounded-md add-friend-btn" data-user-id="${user.uid}">Adicionar</button>`;
                    }
                    return `<div class="p-3 flex items-center hover:bg-gray-700 rounded-lg">
                        <div class="flex-1 flex items-center space-x-3 cursor-pointer user-chat-opener" data-user-id="${user.uid}" data-username="${user.username}" data-user-photo="${user.photoURL}">
                            <div class="w-10 h-10 rounded-full overflow-hidden"><img src="${user.photoURL}" class="w-full h-full object-cover"></div>
                            <span class="text-gray-200">${user.username}</span>
                        </div>
                        ${actionButton}
                    </div>`;
                }).join('');
            document.querySelectorAll('.add-friend-btn').forEach(btn => {
                btn.onclick = (e) => { e.stopPropagation(); sendFriendRequest(btn.dataset.userId); };
            });
            document.querySelectorAll('.user-chat-opener').forEach(item => {
                item.onclick = async () => {
                    const targetUserId = item.dataset.userId;
                    try {
                        await createOrGetDirectMessageRoom(targetUserId, item.dataset.username, item.dataset.userPhoto);
                        modal.classList.add('hidden'); searchInput.value = ''; resultsContainer.innerHTML = '';
                    } catch (error) { showNotification("N√£o foi poss√≠vel iniciar a conversa."); }
                };
            });
        };
        searchInput.onkeyup = () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(performSearch, 300); };
    }
    
    async function createOrGetDirectMessageRoom(targetUserId, targetUsername, targetUserPhoto) {
        const roomMembers = [state.currentUserId, targetUserId].sort();
        const roomId = `dm_${roomMembers.join('_')}`;
        const roomRef = doc(db, 'rooms', roomId);
        const docSnap = await getDoc(roomRef);
        if (!docSnap.exists()) {
            await setDoc(roomRef, {
                isDirectMessage: true, members: roomMembers, admins: roomMembers, 
                memberDetails: { [state.currentUserId]: state.currentUserData.username, [targetUserId]: targetUsername },
                memberPhotos: { [state.currentUserId]: state.currentUserData.photoURL, [targetUserId]: targetUserPhoto },
                typing: [], createdAt: serverTimestamp()
            });
        }
        openRoom(roomId);
    }

    async function sendFriendRequest(targetUserId) {
        const targetUserRef = doc(db, 'users', targetUserId);
        const request = { from: state.currentUserId, username: state.currentUserData.username, photoURL: state.currentUserData.photoURL, timestamp: Timestamp.now() };
        await updateDoc(targetUserRef, { friendRequests: arrayUnion(request) });
        const searchInput = document.getElementById('user-search-input');
        if(searchInput) searchInput.dispatchEvent(new Event('keyup'));
        showNotification('Pedido de amizade enviado!');
    }
    
    async function openFriendRequestsModal() {
        const modal = document.getElementById('friend-requests-modal');
        modal.classList.remove('hidden');
        const listContainer = document.getElementById('friend-requests-list');
        const requests = state.currentUserData.friendRequests || [];
        if (requests.length === 0) { listContainer.innerHTML = `<p class="p-4 text-center text-gray-500">Nenhum pedido de amizade.</p>`; return; }
        listContainer.innerHTML = requests.map(req => {
            return `<div class="p-3 flex items-center border-b border-gray-700">
                <div class="w-10 h-10 rounded-full overflow-hidden mr-3"><img src="${req.photoURL}" class="w-full h-full object-cover"></div>
                <span class="flex-1">${req.username}</span>
                <button class="bg-green-500 text-white px-3 py-1 rounded-md mr-2 accept-friend-btn" data-requester-id="${req.from}">Aceitar</button>
                <button class="bg-red-500 text-white px-3 py-1 rounded-md decline-friend-btn" data-requester-id="${req.from}">Recusar</button>
            </div>`;
        }).join('');
        document.querySelectorAll('.accept-friend-btn').forEach(btn => {
            btn.onclick = async () => {
                const requesterId = btn.dataset.requesterId;
                const batch = writeBatch(db);
                batch.update(doc(db, 'users', state.currentUserId), { friends: arrayUnion(requesterId) });
                batch.update(doc(db, 'users', requesterId), { friends: arrayUnion(state.currentUserId) });
                const myRequestList = state.currentUserData.friendRequests.filter(r => r.from !== requesterId);
                batch.update(doc(db, 'users', state.currentUserId), { friendRequests: myRequestList });
                await batch.commit();
                showNotification("Amigo adicionado!");
                modal.classList.add('hidden');
            };
        });
        document.querySelectorAll('.decline-friend-btn').forEach(btn => {
            btn.onclick = async () => {
                const requesterId = btn.dataset.requesterId;
                const myRequestList = state.currentUserData.friendRequests.filter(r => r.from !== requesterId);
                await updateDoc(doc(db, 'users', state.currentUserId), { friendRequests: myRequestList });
                showNotification("Pedido recusado.");
                modal.classList.add('hidden');
            };
        });
    }

    async function openRoomSettings() {
        const modal = document.getElementById('room-settings-modal');
        modal.classList.remove('hidden');
        const room = state.currentRoomData;
        const addMemberSection = document.getElementById('add-member-section');
        addMemberSection.classList.toggle('hidden', room.isDirectMessage);
        document.getElementById('add-member-btn').onclick = openAddMemberModal;
        document.getElementById('room-settings-pic').src = room.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(room.name[0] || '?')}&background=A78BFA&color=fff&size=40`;
        const nameInput = document.getElementById('room-settings-name');
        nameInput.value = room.name;
        nameInput.onblur = async () => {
            const newName = nameInput.value.trim();
            if (newName && newName !== state.currentRoomData.name) {
                await updateDoc(doc(db, 'rooms', room.id), { name: newName });
                showNotification("Nome da sala atualizado!");
            }
        };
        document.getElementById('room-settings-pic').parentElement.onclick = () => {
            state.imageUploadContext = { type: 'room', id: room.id };
            document.getElementById('image-uploader').click();
        };
        document.getElementById('clear-chat-btn').onclick = async () => {
             if(await showCustomConfirm('Limpar Mensagens', `Tem certeza que deseja apagar TODAS as mensagens da sala "${room.name}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                 await clearChatForEveryone(room.id);
             }
        };
        const membersList = document.getElementById('room-members-list');
        membersList.innerHTML = `<p>A carregar membros...</p>`;
        const usersQuery = query(collection(db, 'users'), where('uid', 'in', room.members));
        const usersSnapshot = await getDocs(usersQuery);
        const usersData = usersSnapshot.docs.map(d => d.data());
        membersList.innerHTML = usersData.map(user => {
            const isAdmin = room.admins.includes(user.uid);
            let userActions = '';
            if (user.uid !== room.creatorUid && room.admins.includes(state.currentUserId)) {
                userActions += `<button class="ml-auto px-3 py-1 text-sm rounded-md ${isAdmin ? 'bg-yellow-500 text-white' : 'bg-gray-600'} admin-toggle-btn" data-uid="${user.uid}">${isAdmin ? 'Rebaixar' : 'Promover'}</button>`;
                userActions += `<button class="ml-2 px-3 py-1 text-sm rounded-md bg-red-600 text-white remove-user-btn" data-uid="${user.uid}" data-username="${user.username}">&times;</button>`;
            }
            return `<div class="flex items-center p-2 rounded-lg hover:bg-gray-700">
                <div class="w-8 h-8 rounded-full overflow-hidden mr-3"><img src="${user.photoURL}" class="w-full h-full object-cover"></div>
                <span class="flex-1">${user.username} ${user.uid === state.currentUserId ? '(Voc√™)' : ''} ${user.uid === room.creatorUid ? '<span class="text-xs text-yellow-400 font-bold">Dono</span>' : ''}</span>
                <div class="flex items-center space-x-2">${userActions}</div>
            </div>`
        }).join('');
        membersList.querySelectorAll('.admin-toggle-btn').forEach(btn => {
            btn.onclick = async () => {
                const targetUid = btn.dataset.uid;
                const isTargetAdmin = state.currentRoomData.admins.includes(targetUid);
                const operation = isTargetAdmin ? arrayRemove(targetUid) : arrayUnion(targetUid);
                await updateDoc(doc(db, 'rooms', room.id), { admins: operation });
                showNotification(`Usu√°rio ${isTargetAdmin ? 'rebaixado' : 'promovido'}.`);
            };
        });
        membersList.querySelectorAll('.remove-user-btn').forEach(btn => {
            btn.onclick = async () => {
                const targetUid = btn.dataset.uid;
                const targetUsername = btn.dataset.username;
                 if (await showCustomConfirm('Remover Usu√°rio', `Tem certeza que deseja remover ${targetUsername} da sala?`)) {
                     await updateDoc(doc(db, 'rooms', room.id), { members: arrayRemove(targetUid), admins: arrayRemove(targetUid) });
                     showNotification(`${targetUsername} foi removido(a) da sala.`);
                 }
            };
        });
    }

    async function openAddMemberModal() {
        const modal = document.getElementById('add-member-modal');
        modal.classList.remove('hidden');
        const listContainer = document.getElementById('add-member-list');
        listContainer.innerHTML = `<p>A carregar amigos...</p>`;
        const friends = state.currentUserData.friends || [];
        const currentMembers = state.currentRoomData.members || [];
        const friendsToAdd = friends.filter(id => !currentMembers.includes(id));
        if (friendsToAdd.length === 0) { listContainer.innerHTML = `<p class="p-4 text-center text-gray-500">Todos os seus amigos j√° est√£o neste grupo.</p>`; return; }
        const usersQuery = query(collection(db, 'users'), where('uid', 'in', friendsToAdd));
        const usersSnap = await getDocs(usersQuery);
        listContainer.innerHTML = usersSnap.docs.map(doc => {
            const user = doc.data();
            return `<div class="p-3 flex items-center border-b border-gray-700">
                <div class="w-10 h-10 rounded-full overflow-hidden mr-3"><img src="${user.photoURL}" class="w-full h-full object-cover"></div>
                <span class="flex-1">${user.username}</span>
                <button class="bg-blue-500 text-white px-3 py-1 rounded-md add-to-group-btn" data-user-id="${user.uid}">Adicionar</button>
            </div>`;
        }).join('');
        listContainer.querySelectorAll('.add-to-group-btn').forEach(btn => {
            btn.onclick = async () => {
                const userId = btn.dataset.userId;
                await updateDoc(doc(db, 'rooms', state.currentRoomData.id), { members: arrayUnion(userId) });
                showNotification("Membro adicionado!");
                btn.disabled = true;
                btn.textContent = 'Adicionado';
            };
        });
    }

    async function clearChatForEveryone(roomId) {
        document.getElementById('loading-overlay').classList.remove('hidden');
        const messagesRef = collection(db, `rooms/${roomId}/messages`);
        const querySnapshot = await getDocs(messagesRef);
        const batch = writeBatch(db);
        querySnapshot.forEach(doc => batch.delete(doc.ref));
        await batch.commit();
        document.getElementById('loading-overlay').classList.add('hidden');
        showNotification("O hist√≥rico da sala foi limpo.");
        document.getElementById('room-settings-modal').classList.add('hidden');
    }
    
    function openImageViewer(src, { isUser = false, isRoom = false, isAdmin = false } = {}) {
        const modal = document.getElementById('image-viewer-modal');
        document.getElementById('image-viewer-pic').src = src;
        const actionsContainer = document.getElementById('image-viewer-actions');
        actionsContainer.innerHTML = '';
        if ((isUser) || (isRoom && isAdmin)) {
            const changeButton = document.createElement('button');
            changeButton.className = 'p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 shadow-lg';
            changeButton.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2-2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>`;
            changeButton.onclick = () => {
                state.imageUploadContext = { type: isUser ? 'user' : 'room', id: isUser ? state.currentUserId : state.currentRoomData.id };
                document.getElementById('image-uploader').click();
                modal.classList.add('hidden');
            };
            actionsContainer.appendChild(changeButton);
        }
        modal.classList.remove('hidden');
    }

    async function handleMediaUpload(e) {
        const file = e.target.files[0];
        if (!file) return;
        const isProfileUpload = state.imageUploadContext?.type;
        if (!isProfileUpload && !state.currentRoomData) {
            showNotification("Voc√™ precisa estar em uma sala para enviar m√≠dias.", "error");
            return;
        }
        document.getElementById('loading-overlay').classList.remove('hidden');
        const fileType = file.type.startsWith('image/') ? 'image' : (file.type.startsWith('video/') ? 'video' : null);
        
        if (isProfileUpload) {
            if (fileType !== 'image') {
                showNotification("Apenas imagens s√£o permitidas para fotos de perfil.", "error");
                document.getElementById('loading-overlay').classList.add('hidden');
                return;
            }
            const { type, id } = state.imageUploadContext;
            const path = `${type}_photos/${id || state.currentUserId}/${Date.now()}_${file.name}`;
            try {
                const fileRef = storageRef(storage, path);
                await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(fileRef);
                if (type === 'user') {
                    await updateDoc(doc(db, 'users', state.currentUserId), { photoURL: downloadURL });
                    showNotification("Foto de perfil atualizada!");
                } else if (type === 'room') {
                    await updateDoc(doc(db, 'rooms', id), { photoURL: downloadURL });
                    showNotification("Foto da sala atualizada!");
                }
            } catch (error) { showNotification("Falha ao atualizar a foto.", "error"); }
        } else {
            if (!fileType) {
                showNotification("Tipo de arquivo n√£o suportado.", "error");
                document.getElementById('loading-overlay').classList.add('hidden');
                return;
            }
            const path = `chat_media/${state.currentRoomData.id}/${Date.now()}_${file.name}`;
            try {
                const fileRef = storageRef(storage, path);
                await uploadBytes(fileRef, file);
                const downloadURL = await getDownloadURL(fileRef);
                await sendMediaMessage(fileType, downloadURL, file.name);
            } catch (error) { showNotification("Falha ao enviar m√≠dia.", "error"); }
        }
        document.getElementById('loading-overlay').classList.add('hidden');
        state.imageUploadContext = null;
        e.target.value = '';
    }

    function setupPresenceSystem() {
       if (!auth.currentUser || auth.currentUser.isAnonymous) return;
       const myUid = auth.currentUser.uid;
       const userStatusRef = rtdbRef(rtdb, 'status/' + myUid);
       const isOfflineForRTDB = { state: 'offline', last_changed: rtdbServerTimestamp() };
       const isOnlineForRTDB = { state: 'online', last_changed: rtdbServerTimestamp() };
       onValue(rtdbRef(rtdb, '.info/connected'), (snapshot) => {
           if (snapshot.val() === false) { set(userStatusRef, isOfflineForRTDB); return; }
           onDisconnect(userStatusRef).set(isOfflineForRTDB).then(() => { set(userStatusRef, isOnlineForRTDB); });
       });
    }    async function setupPushNotifications() {
        if (!messaging) {
            console.warn('Firebase Messaging n√£o est√° dispon√≠vel');
            return false;
        }

        // Verificar se o navegador suporta notifica√ß√µes
        if (!('Notification' in window)) {
            console.warn('Este navegador n√£o suporta notifica√ß√µes');
            return false;
        }

        try {
            // Verificar se j√° tem permiss√£o
            let permission = Notification.permission;
            console.log('Permiss√£o atual das notifica√ß√µes:', permission);
            
            // Se n√£o tem permiss√£o, solicitar
            if (permission === 'default') {
                console.log('Solicitando permiss√£o de notifica√ß√µes...');
                  // Suporte para diferentes navegadores
                if (Notification.requestPermission) {
                    console.log('Chamando Notification.requestPermission()...');
                    try {
                        // Tentar a forma moderna (retorna Promise)
                        permission = await Notification.requestPermission();
                    } catch (e) {
                        console.log('Tentativa com Promise falhou, tentando forma legacy...');
                        // Fallback para navegadores antigos (callback)
                        permission = await new Promise((resolve) => {
                            Notification.requestPermission((result) => {
                                resolve(result);
                            });
                        });
                    }
                } else {
                    console.error('Notification.requestPermission n√£o est√° dispon√≠vel');
                    return false;
                }
                
                console.log('Resultado da permiss√£o:', permission);
            }
            
            if (permission === 'granted') {
                console.log('Permiss√£o concedida, obtendo token...');
                const vapidKey = "BBo4U4SIypBpGZvoVaAXWee9fmBOEsl8ck9GzYiGF0s7mQaUm5l3Mc0tDGA-zb6VzhJpAIeQXgD4t4AgANHj8Z0";
                const currentToken = await getToken(messaging, { vapidKey: vapidKey });

                if (currentToken) {
                    await updateDoc(doc(db, 'users', state.currentUserId), {
                        fcmTokens: arrayUnion(currentToken)
                    });
                    console.log('Token de notifica√ß√£o salvo:', currentToken);
                    
                    // Configurar listener para mensagens em primeiro plano
                    onMessage(messaging, (payload) => {
                        console.log('Mensagem recebida em primeiro plano. ', payload);
                        showNotification(`${payload.notification.title}: ${payload.notification.body}`);
                    });
                    
                    return true;
                } else {
                    console.warn('Falha ao obter token de notifica√ß√£o');
                    return false;
                }
            } else if (permission === 'denied') {
                console.warn('Permiss√£o para notifica√ß√µes negada pelo usu√°rio');
                return false;
            } else {
                console.warn('Usu√°rio n√£o respondeu √† solicita√ß√£o de permiss√£o ou cancelou');
                return false;
            }
        } catch (err) {
            console.error('Erro ao configurar notifica√ß√µes:', err);
            return false;
        }
    }

    function checkNotificationPermission() {
        // Verifica se o navegador suporta notifica√ß√µes
        if (!('Notification' in window)) {
            return 'not-supported';
        }
        
        // Retorna o status atual da permiss√£o
        return Notification.permission;
    }    function showMandatoryNotificationsModal() {
        const modal = document.getElementById('mandatory-notifications-modal');
        const statusEl = document.getElementById('mandatory-notifications-status');
        const button = document.getElementById('activate-mandatory-notifications-btn');
        
        modal.classList.remove('hidden');
        statusEl.textContent = '';
        button.disabled = false;
        button.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
            </svg>
            <span>Ativar Notifica√ß√µes</span>
        `;
        
        button.onclick = async () => {
            button.disabled = true;
            button.innerHTML = `
                <div class="animate-spin rounded-full h-5 w-5 border-t-2 border-b-2 border-white"></div>
                <span>Aguardando...</span>
            `;
            statusEl.textContent = 'Clique em "Permitir" quando o navegador perguntar sobre notifica√ß√µes...';
            statusEl.className = 'text-xs text-center text-blue-400';
            
            const success = await setupPushNotifications();
            
            if (success) {
                button.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Notifica√ß√µes Ativadas!</span>
                `;
                button.className = 'w-full py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-lg transition-all duration-300 flex items-center justify-center space-x-2';
                statusEl.textContent = '‚úì Notifica√ß√µes ativadas com sucesso! Redirecionando...';
                statusEl.className = 'text-xs text-center text-green-400';
                
                setTimeout(async () => {
                    modal.classList.add('hidden');
                    
                    // Continuar com o setup do app
                    const params = new URLSearchParams(window.location.search);
                    const roomIdFromUrl = params.get('room');
                    
                    await setupMainUI(roomIdFromUrl);
                    setupPresenceSystem();
                    monitorNotificationStatus();
                }, 2000);
            } else {
                button.disabled = false;
                button.innerHTML = `
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                    </svg>
                    <span>Tentar Novamente</span>
                `;
                button.className = 'w-full py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white font-semibold rounded-lg hover:from-yellow-600 hover:to-yellow-700 transition-all duration-300 flex items-center justify-center space-x-2';
                
                const currentPermission = Notification.permission;
                if (currentPermission === 'denied') {
                    statusEl.textContent = '‚úó Voc√™ negou as notifica√ß√µes. Para ativar, v√° em Configura√ß√µes do navegador > Notifica√ß√µes > Permitir para este site.';
                    statusEl.className = 'text-xs text-center text-red-400';
                } else {
                    statusEl.textContent = '‚úó N√£o foi poss√≠vel ativar as notifica√ß√µes. Tente novamente.';
                    statusEl.className = 'text-xs text-center text-red-400';
                }
            }
        };
    }

    function enforceNotifications() {
        // N√£o verificar para usu√°rios convidados
        if (state.currentUserData?.isGuest) {
            return true;
        }
        
        const permission = checkNotificationPermission();
        
        if (permission === 'not-supported') {
            console.warn('Notifica√ß√µes n√£o suportadas neste navegador');
            return true; // Permitir acesso mesmo sem suporte
        }
        
        if (permission !== 'granted') {
            showMandatoryNotificationsModal();
            return false;
        }
        
        return true;
    }    // Fun√ß√£o para monitorar mudan√ßas no status das notifica√ß√µes
    function monitorNotificationStatus() {
        if (!('Notification' in window) || state.currentUserData?.isGuest) {
            return;
        }
        
        // Verificar periodicamente se as notifica√ß√µes foram desabilitadas
        const checkInterval = setInterval(() => {
            const permission = checkNotificationPermission();
            
            if (permission !== 'granted') {
                // Notifica√ß√µes foram desabilitadas, bloquear acesso
                clearInterval(checkInterval);
                
                // Ocultar o app principal
                document.getElementById('app-container').classList.add('hidden');
                document.getElementById('guest-container').classList.add('hidden');
                
                // Mostrar modal obrigat√≥rio
                showMandatoryNotificationsModal();
            }
        }, 5000); // Verificar a cada 5 segundos
        
        // Armazenar o intervalo para limpeza posterior
        state.notificationCheckInterval = checkInterval;
    }


    function showNotification(message, type = 'success') {
        const toast = document.getElementById('notification-toast');
        toast.textContent = message;
        toast.className = `fixed bottom-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl z-[101] ${type === 'success' ? 'bg-blue-500' : 'bg-red-500'}`;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showCustomConfirm(title, message) {
        return new Promise(resolve => {
            const modal = document.getElementById('custom-confirm-modal');
            document.getElementById('custom-confirm-title').textContent = title;
            document.getElementById('custom-confirm-message').textContent = message;
            modal.classList.remove('hidden');
            const onOk = () => { cleanup(); resolve(true); };
            const onCancel = () => { cleanup(); resolve(false); };
            const cleanup = () => {
                modal.classList.add('hidden');
                document.getElementById('custom-confirm-ok-btn').removeEventListener('click', onOk);
                document.getElementById('custom-confirm-cancel-btn').removeEventListener('click', onCancel);
            };
            document.getElementById('custom-confirm-ok-btn').addEventListener('click', onOk);
            document.getElementById('custom-confirm-cancel-btn').addEventListener('click', onCancel);
        });
    }

    function showCustomPrompt(title, message) {
        return new Promise(resolve => {
            const modal = document.getElementById('custom-prompt-modal');
            document.getElementById('custom-prompt-title').textContent = title;
            document.getElementById('custom-prompt-message').textContent = message;
            const input = document.getElementById('custom-prompt-input');
            input.value = '';
            modal.classList.remove('hidden'); input.focus();
            const submit = () => {
                const value = input.value.trim();
                if (value) { cleanup(value); }
            };
            const onEnter = (e) => { if (e.key === 'Enter') submit(); };
            const cleanup = (value) => {
                 modal.classList.add('hidden');
                 document.getElementById('custom-prompt-ok-btn').removeEventListener('click', submit);
                 input.removeEventListener('keyup', onEnter);
                 resolve(value);
            }
            document.getElementById('custom-prompt-ok-btn').addEventListener('click', submit);
            input.addEventListener('keyup', onEnter);
        });
    }    async function startRecording(e) {
        e.preventDefault();
        console.log('üéôÔ∏è [START_REC] startRecording chamada');
        console.log('üéôÔ∏è [START_REC] state.isRecording atual:', state.isRecording);
        
        if (state.isRecording) {
            console.log('üéôÔ∏è [START_REC] J√° est√° gravando, cancelando');
            return;
        }
        
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            showNotification("Grava√ß√£o de √°udio n√£o √© suportada neste navegador.", "error");
            console.error("üéôÔ∏è [START_REC] MediaDevices API not supported.");
            return;
        }

        try {
            console.log('üéôÔ∏è [START_REC] Solicitando permiss√£o do microfone');
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            console.log('üéôÔ∏è [START_REC] Permiss√£o concedida, configurando grava√ß√£o');
            state.isRecording = true;
            state.audioChunks = [];
            state.mediaRecorder = new MediaRecorder(stream);

            state.mediaRecorder.ondataavailable = event => {
                console.log('üéôÔ∏è [START_REC] Dados de √°udio dispon√≠veis');
                state.audioChunks.push(event.data);
            };

            state.mediaRecorder.onstop = async () => {
                console.log('üéôÔ∏è [START_REC] Grava√ß√£o parada, processando √°udio');
                const duration = Math.round((Date.now() - state.recordingStartTime) / 1000);
                const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                
                document.getElementById('loading-overlay').classList.remove('hidden');
                
                const path = `chat_audio/${state.currentRoomData.id}/${Date.now()}.webm`;
                const fileRef = storageRef(storage, path);
                try {
                    await uploadBytes(fileRef, audioBlob);
                    const downloadURL = await getDownloadURL(fileRef);
                    await sendAudioMessage(downloadURL, duration);
                    console.log('üéôÔ∏è [START_REC] √Åudio enviado com sucesso');
                } catch (error) {
                    showNotification("Falha ao enviar √°udio.", "error");
                    console.error("üéôÔ∏è [START_REC] Audio upload error:", error);
                } finally {
                    document.getElementById('loading-overlay').classList.add('hidden');
                }
                
                stream.getTracks().forEach(track => track.stop());
                console.log('üéôÔ∏è [START_REC] Stream fechado');
            };

            state.recordingStartTime = Date.now();
            state.mediaRecorder.start();
            console.log('üéôÔ∏è [START_REC] Grava√ß√£o iniciada, chamando updateRecordingUI(true)');
            updateRecordingUI(true);

        } catch (err) {
            console.error("üéôÔ∏è [START_REC] Error accessing microphone:", err);
            showNotification("N√£o foi poss√≠vel acessar o microfone. Verifique as permiss√µes.", "error");
        }
    }

    function stopRecording(e) {
        e.preventDefault();
        console.log('üõë [STOP_REC] stopRecording chamada');
        console.log('üõë [STOP_REC] state.isRecording:', state.isRecording);
        console.log('üõë [STOP_REC] state.mediaRecorder:', !!state.mediaRecorder);
        
        if (!state.isRecording || !state.mediaRecorder) {
            console.log('üõë [STOP_REC] N√£o est√° gravando ou sem MediaRecorder, cancelando');
            return;
        }
        
        console.log('üõë [STOP_REC] Parando grava√ß√£o');
        state.mediaRecorder.stop();
        state.isRecording = false;
        console.log('üõë [STOP_REC] state.isRecording definido como false, chamando updateRecordingUI(false)');
        updateRecordingUI(false);
    }    function updateRecordingUI(isRecording) {
        // STACK TRACE para debug
        console.log('üé® [UI] ===== updateRecordingUI CHAMADA =====');
        console.log('üé® [UI] isRecording:', isRecording);
        console.log('üé® [UI] state.isRecording:', state.isRecording);
        console.log('üé® [UI] Stack trace:', new Error().stack);
        
        const indicator = document.getElementById('recording-indicator');
        const timerEl = document.getElementById('recording-timer');
        const dynamicBtn = document.getElementById('dynamic-action-btn');
        
        console.log('üé® [UI] Elementos encontrados:', {
            indicator: !!indicator,
            timerEl: !!timerEl,
            dynamicBtn: !!dynamicBtn
        });
        
        if (!indicator || !timerEl) {
            console.log('üé® [UI] Elementos n√£o encontrados, cancelando');
            return;        }
        
        // VERIFICA√á√ÉO CR√çTICA: Se n√£o est√° gravando, NUNCA aplicar vermelho
        if (isRecording && state.isRecording) {
            console.log('üî¥ [UI] Ativando modo de grava√ß√£o - bot√£o vermelho');
            indicator.classList.remove('hidden');
            indicator.classList.add('flex');
            
            // Mudar estilo do bot√£o para vermelho durante grava√ß√£o
            if (dynamicBtn) {
                const oldClassName = dynamicBtn.className;
                dynamicBtn.className = 'group relative p-2.5 rounded-full bg-gradient-to-r from-red-500/80 to-red-600/80 hover:from-red-600/90 hover:to-red-700/90 transition-all duration-300 scale-110 z-10 animate-pulse';
                console.log('üî¥ [UI] Classes do bot√£o alteradas de:', oldClassName);
                console.log('üî¥ [UI] Classes do bot√£o alteradas para:', dynamicBtn.className);
            }
            
            state.recordingTimerInterval = setInterval(() => {
                const seconds = Math.floor((Date.now() - state.recordingStartTime) / 1000);
                const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
                const secs = (seconds % 60).toString().padStart(2, '0');
                timerEl.textContent = `${mins}:${secs}`;
            }, 1000);
        } else {
            console.log('‚ö™ [UI] FOR√áANDO MODO CINZA - state.isRecording:', state.isRecording, 'isRecording:', isRecording);
            console.log('‚ö™ [UI] Desativando modo de grava√ß√£o - bot√£o cinza');
            indicator.classList.add('hidden');
            indicator.classList.remove('flex');
            
            // SEMPRE limpar estado de grava√ß√£o
            state.isRecording = false;
            
            // Voltar estilo do bot√£o para neutro - SEMPRE aplicar
            if (dynamicBtn) {
                const oldClassName = dynamicBtn.className;
                
                // M√âTODO SUPER AGRESSIVO: Remover TODAS as classes vermelhas poss√≠veis
                const redClasses = ['animate-pulse', 'scale-110', 'bg-gradient-to-r', 'from-red-500/80', 'to-red-600/80', 'hover:from-red-600/90', 'hover:to-red-700/90', 'bg-red-500', 'bg-red-600', 'bg-red-700', 'text-red-500', 'border-red-500'];
                redClasses.forEach(cls => dynamicBtn.classList.remove(cls));
                  // Limpar className completamente e re-aplicar
                dynamicBtn.className = '';
                dynamicBtn.removeAttribute('style');
                
                // For√ßar estilos inline para garantir background transparente
                dynamicBtn.style.backgroundColor = 'transparent';
                dynamicBtn.style.background = 'transparent';
                dynamicBtn.style.backgroundImage = 'none';
                
                // Aplicar classes corretas
                dynamicBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                
                console.log('‚ö™ [UI] Classes do bot√£o alteradas de:', oldClassName);
                console.log('‚ö™ [UI] Classes do bot√£o alteradas para:', dynamicBtn.className);
                console.log('‚ö™ [UI] Background for√ßado para transparente');
                
                // Verifica√ß√£o imediata com estilo computado
                setTimeout(() => {
                    const computedBg = window.getComputedStyle(dynamicBtn).backgroundColor;
                    console.log('‚ö™ [UI] Background computado ap√≥s reset:', computedBg);
                    
                    if (dynamicBtn.className.includes('red') || dynamicBtn.className.includes('pulse') || 
                        computedBg.includes('255') || computedBg.includes('red')) {
                        
                        console.log('‚ö†Ô∏è [UI] AINDA VERMELHO ap√≥s reset! classes:', dynamicBtn.className, 'computed:', computedBg);
                        
                        // RESET ULTRA AGRESSIVO
                        dynamicBtn.removeAttribute('class');
                        dynamicBtn.removeAttribute('style');
                        dynamicBtn.style.cssText = 'background: transparent !important; background-color: transparent !important;';
                        dynamicBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                        
                        console.log('‚ö†Ô∏è [UI] Reset ULTRA AGRESSIVO aplicado');
                        console.log('‚ö†Ô∏è [UI] Novo background:', window.getComputedStyle(dynamicBtn).backgroundColor);
                    }
                }, 10);
                
                // Verifica√ß√£o adicional ap√≥s mais tempo
                setTimeout(() => {
                    if (dynamicBtn.className.includes('red') || dynamicBtn.className.includes('pulse')) {
                        console.log('üö® [UI] PROBLEMA PERSISTENTE! Clonando bot√£o...');
                        const newBtn = dynamicBtn.cloneNode(true);
                        newBtn.className = 'group relative p-2.5 rounded-full hover:bg-gray-700/30 transition-all duration-300 hover:scale-110 z-10';
                        dynamicBtn.parentNode.replaceChild(newBtn, dynamicBtn);
                    }
                }, 300);
            }
            
            clearInterval(state.recordingTimerInterval);
            timerEl.textContent = '00:00';
        }
        
        console.log('üé® [UI] updateRecordingUI finalizada');
    }

    document.addEventListener('DOMContentLoaded', main);
</script>
<script>
    // --- L√≥gica para ajuste de altura do viewport em celulares ---
    function setRealViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--real-vh', `${vh}px`);
    }
    window.addEventListener('resize', setRealViewportHeight);
    setRealViewportHeight(); // Executa no carregamento inicial    // --- PWA Service Worker & Manifest ---
    const MANIFEST_DATA = {
        "name": "7Chat", "short_name": "7Chat", "description": "Um aplicativo de chat em tempo real.",
        "start_url": "/", "scope": "/", "display": "standalone", "background_color": "#000000", "theme_color": "#111827",
        "icons": [
            { "src": "https://placehold.co/192x192/4f46e5/ffffff?text=7C", "sizes": "192x192", "type": "image/png" },
            { "src": "https://placehold.co/512x512/4f46e5/ffffff?text=7Chat", "sizes": "512x512", "type": "image/png" },
            { "src": "https://placehold.co/512x512/4f46e5/ffffff?text=7Chat&maskable=true", "sizes": "512x512", "type": "image/png", "purpose": "maskable" }
        ]
    };
    const manifestBlob = new Blob([JSON.stringify(MANIFEST_DATA)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    const link = document.createElement('link');
    link.rel = 'manifest'; link.href = manifestURL;
    document.head.appendChild(link);
    
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/firebase-messaging-sw.js')
            .then((registration) => {
                console.log('Service Worker registrado com sucesso:', registration);
            }).catch((err) => {                console.warn('Falha no registro do Service Worker: ', err);
            });    }
</script>
</body>
</html>
